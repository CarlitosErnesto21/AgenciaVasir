import{z as B,A as b}from"./ui-CVJOYm3g.js";import{e as V,g as $,u as L}from"./index-BgCUKfSP.js";import{r as y,E as G,w as H,k as F,c as M,d as N,p as c,x as g,j as K,e as d,q as U,$ as m,F as W,N as P}from"./vendor-CqKcGHPa.js";import J from"./ResumenTour-DPNcExFW.js";import Q from"./FormularioDatosPersonales-Ch0kcR_y.js";import Y from"./SelectorCupos-yeOL67-J.js";import"./vue-tel-input-J95PmLrS.js";const Z={class:"text-sm sm:text-base lg:text-lg font-bold text-red-700 flex items-center text-center justify-center w-full"},ee={class:"mr-1 sm:mr-2"},oe={key:0,class:"space-y-3 sm:space-y-4 lg:space-y-6 text-xs sm:text-sm text-gray-700"},te={class:"flex justify-center gap-4 w-full mt-6"},ue={__name:"ModalReservaTour",props:{visible:{type:Boolean,default:!1},tourSeleccionado:{type:Object,default:null},user:{type:Object,default:null}},emits:["update:visible","confirmar-reserva","actualizar-cupos","refrescar-tour"],setup(u,{emit:q}){const l=B(),i=u,p=q,v=y(null),o=y({correo:"",nombres:"",tipo_documento:"DUI",numero_identificacion:"",fecha_nacimiento:"",genero:"",direccion:"",telefono:"",cupos_adultos:1,cupos_menores:0}),_=y(!1),A=async()=>{var t,e;if(!i.user)return null;try{const s=await fetch("/api/verificar-datos-cliente",{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||"","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(s.ok){if(!(await s.json()).tiene_datos_completos)return null;const a=await fetch("/api/cliente-datos",{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((e=document.querySelector('meta[name="csrf-token"]'))==null?void 0:e.getAttribute("content"))||"","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(a.ok)return(await a.json()).cliente||null}return null}catch(s){return console.error("[ModalReservaTour] Error de conexión al cargar datos del cliente:",s),null}},z=async()=>{const t=i.user;let e="",s="";if(t&&(s=t.email||"",e=t.name||""),o.value={correo:s,nombres:e,tipo_documento:"DUI",numero_identificacion:"",fecha_nacimiento:"",genero:"",direccion:"",telefono:"",cupos_adultos:1,cupos_menores:0},_.value=!1,t){const r=await A();if(r){_.value=!0;let a="";if(r.fecha_nacimiento)try{a=new Date(r.fecha_nacimiento)}catch{}o.value={...o.value,tipo_documento:r.tipo_documento||"DUI",numero_identificacion:r.numero_identificacion||"",fecha_nacimiento:a,genero:r.genero||"",direccion:r.direccion||"",telefono:r.telefono||""}}}},x=()=>{p("update:visible",!1)},w=t=>{l.add(t)},I=async()=>{var t,e,s,r,a,f,h,C,S,T,j,D,E,R;if(!((t=v.value)!=null&&t.validateForm&&!v.value.validateForm())){if(o.value.cupos_adultos<=0&&o.value.cupos_menores<=0){l.add({severity:"error",summary:"Error en la reserva",detail:"Debe seleccionar al menos un cupo.",life:4e3});return}try{const n=await P.post("/reservas/tour",{tour_id:i.tourSeleccionado.id,cliente_data:{correo:o.value.correo,nombres:o.value.nombres,tipo_documento:o.value.tipo_documento,numero_identificacion:o.value.numero_identificacion,fecha_nacimiento:o.value.fecha_nacimiento,genero:((e=o.value.genero)==null?void 0:e.toUpperCase())||"",direccion:o.value.direccion,telefono:o.value.telefono},cupos_adultos:o.value.cupos_adultos,cupos_menores:o.value.cupos_menores,precio_total:X.value.total});((r=(s=n.data)==null?void 0:s.data)==null?void 0:r.cupos_disponibles_actualizados)!==void 0&&p("actualizar-cupos",{tourId:i.tourSeleccionado.id,cuposDisponibles:n.data.data.cupos_disponibles_actualizados}),p("refrescar-tour",i.tourSeleccionado.id),p("confirmar-reserva",n.data),x()}catch(n){if(console.error("Error al confirmar reserva:",n),((a=n.response)==null?void 0:a.status)===419)l.add({severity:"error",summary:"Sesión expirada",detail:"Su sesión ha expirado. Por favor, recargue la página.",life:5e3}),window.location.reload();else if(((f=n.response)==null?void 0:f.status)===422){const O=((C=(h=n.response)==null?void 0:h.data)==null?void 0:C.errors)||{},k=Object.values(O).flat();k.length>0?l.add({severity:"error",summary:"Errores de validación",detail:k.join(", "),life:5e3}):l.add({severity:"error",summary:"Error de validación",detail:((T=(S=n.response)==null?void 0:S.data)==null?void 0:T.message)||"Datos inválidos",life:4e3})}else((j=n.response)==null?void 0:j.status)===403?l.add({severity:"error",summary:"Acceso denegado",detail:"No tiene permisos para realizar esta acción. Debe tener rol de cliente.",life:4e3}):((D=n.response)==null?void 0:D.status)===401?l.add({severity:"error",summary:"Sesión requerida",detail:"Debe iniciar sesión para realizar una reserva.",life:4e3}):l.add({severity:"error",summary:"Error al procesar la reserva",detail:((R=(E=n.response)==null?void 0:E.data)==null?void 0:R.message)||"Inténtelo de nuevo.",life:4e3})}}},X=G(()=>{if(!i.tourSeleccionado)return{total:0};const t=i.tourSeleccionado.precio||i.tourSeleccionado.precio_adulto||0,e=o.value.cupos_adultos+o.value.cupos_menores;return{total:t*e}});return H(()=>i.visible,async t=>{t&&await z()}),(t,e)=>{const s=F("Toast"),r=F("Dialog");return N(),M(W,null,[c(s),c(r,{visible:u.visible,"onUpdate:visible":e[3]||(e[3]=a=>p("update:visible",a)),modal:"",closable:!1,class:"w-[95vw] sm:w-[90vw] md:w-[85vw] lg:w-[80vw] xl:max-w-4xl mx-2 sm:mx-4",draggable:!1},{header:g(()=>[d("h3",Z,[d("span",ee,[c(m(b),{icon:m(L),class:"h-5 text-blue-500"},null,8,["icon"])]),e[4]||(e[4]=d("span",{class:"text-blue-500"},"Reservando Tour",-1))])]),footer:g(()=>[d("div",te,[d("button",{onClick:I,type:"button",class:"bg-red-500 hover:bg-red-700 text-white border-none px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"},[c(m(b),{icon:m(V),class:"h-5 text-white"},null,8,["icon"]),e[5]||(e[5]=U(" Confirmar "))]),d("button",{onClick:x,type:"button",class:"bg-blue-500 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2"},[c(m(b),{icon:m($),class:"h-5"},null,8,["icon"]),e[6]||(e[6]=U(" Cancelar "))])])]),default:g(()=>[u.tourSeleccionado?(N(),M("div",oe,[c(J,{"tour-seleccionado":u.tourSeleccionado},null,8,["tour-seleccionado"]),c(Q,{ref_key:"formularioDatosRef",ref:v,formulario:o.value,"onUpdate:formulario":e[0]||(e[0]=a=>o.value=a),"tiene-cliente-existente":_.value,user:u.user,onMostrarToast:w},null,8,["formulario","tiene-cliente-existente","user"]),c(Y,{"cupos-adultos":o.value.cupos_adultos,"onUpdate:cuposAdultos":e[1]||(e[1]=a=>o.value.cupos_adultos=a),"cupos-menores":o.value.cupos_menores,"onUpdate:cuposMenores":e[2]||(e[2]=a=>o.value.cupos_menores=a),"tour-seleccionado":u.tourSeleccionado,onMostrarToast:w},null,8,["cupos-adultos","cupos-menores","tour-seleccionado"])])):K("",!0)]),_:1},8,["visible"])],64)}}};export{ue as default};
