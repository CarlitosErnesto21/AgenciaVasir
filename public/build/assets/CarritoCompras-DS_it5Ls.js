import{r as E,N as z,a4 as H,E as N,w as G,c as p,j as A,d as f,e,p as m,q as S,$ as t,t as y,I as L,F as B,l as J}from"./vendor-f-nyLqyu.js";import{u as I}from"./carrito-CfDCpVwC.js";import{A as v}from"./ui-C6haujdk.js";import{I as Q}from"./ImageWithFallback-W4HCK1yA.js";import{a8 as U,z as Y,g as Z,a9 as ee,aa as te,ab as oe,ac as se,d as ae,ad as re,ae as ne,a as le,u as O}from"./index-DzsJEOvg.js";import{_ as K}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./app-DhmlorL0.js";function ie(){const k=E(!1),n=E(null),F=I(),g=z.create(),R=()=>{var d;return((d=document.head.querySelector('meta[name="csrf-token"]'))==null?void 0:d.content)||null};return g.interceptors.request.use(l=>{const d=R();return d&&(l.headers["X-CSRF-TOKEN"]=d),l.headers["X-Requested-With"]="XMLHttpRequest",l.headers.Accept="application/json",l}),{loading:k,error:n,createVentaFromCarrito:async l=>{var d,s,o,r,c;k.value=!0,n.value=null;try{const h={productos:F.items.map(b=>({id:b.id,cantidad:b.cantidad,precio:b.precio,nombre:b.nombre,imagen:b.primera_imagen||b.imagen||null,subtotal:b.precio*b.cantidad})),customer_email:l};let C;try{C=await g.post("/carrito/create-venta",h)}catch(b){if(((d=b.response)==null?void 0:d.status)===419){console.log("ðŸ”„ Token CSRF expirado, renovando...");try{const _=await z.get("/tienda",{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"text/html,application/xhtml+xml"}});if(_.data&&typeof _.data=="string"){const M=_.data.match(/name="csrf-token" content="([^"]+)"/);if(M){const j=M[1],q=document.head.querySelector('meta[name="csrf-token"]');q&&(q.setAttribute("content",j),console.log("âœ… Token CSRF renovado:",j))}}C=await g.post("/carrito/create-venta",h)}catch(_){throw _}}else throw b}if(C.data.success)return{success:!0,venta:C.data.venta,message:C.data.message};throw new Error(C.data.message||"Error desconocido")}catch(u){console.error("Error creando venta desde carrito:",u);let h="Error al crear la venta";return(o=(s=u.response)==null?void 0:s.data)!=null&&o.message?h=u.response.data.message:(c=(r=u.response)==null?void 0:r.data)!=null&&c.errors?h=Object.values(u.response.data.errors).flat().join(", "):u.message&&(h=u.message),n.value=h,{success:!1,error:h}}finally{k.value=!1}},procesarPagoVenta:async l=>{var d,s,o,r;k.value=!0,n.value=null;try{const c=await g.post("/pagos/venta",l);if(c.data.success)return{success:!0,pago:c.data.pago,wompi_data:c.data.wompi_data,message:c.data.message};throw new Error(c.data.message||"Error en el pago")}catch(c){console.error("Error procesando pago:",c);let u="Error al procesar el pago";return(s=(d=c.response)==null?void 0:d.data)!=null&&s.message?u=c.response.data.message:(r=(o=c.response)==null?void 0:o.data)!=null&&r.errors?u=Object.values(c.response.data.errors).flat().join(", "):c.message&&(u=c.message),n.value=u,{success:!1,error:u}}finally{k.value=!1}},consultarEstadoPago:async l=>{var d,s;try{const o=await g.get(`/pagos/${l}/estado`);if(o.data.success)return{success:!0,pago:o.data.pago};throw new Error(o.data.message||"Error consultando estado")}catch(o){return console.error("Error consultando estado del pago:",o),{success:!1,error:((s=(d=o.response)==null?void 0:d.data)==null?void 0:s.message)||o.message||"Error consultando estado"}}}}}const ce={class:"modal-header"},de={class:"modal-title"},ue={key:0,class:"loading-state"},me={key:1,class:"error-state"},pe={key:2,class:"payment-form"},fe={class:"purchase-summary"},ve={class:"summary-details"},ge={class:"total-amount"},be={class:"amount"},ye={class:"order-reference"},he={class:"reference"},xe={class:"payment-section"},Ce=["disabled"],ke={key:0,class:"w-6 h-6 mr-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},we={key:1,class:"w-6 h-6 mr-3 animate-spin",fill:"none",viewBox:"0 0 24 24"},_e={class:"payment-info"},$e={class:"info-item"},Ee={class:"info-item"},Te={key:3,class:"success-state"},Se={class:"success-details"},Pe={__name:"CarritoCheckoutModal",props:{isVisible:{type:Boolean,default:!1}},emits:["close","payment-completed"],setup(k,{emit:n}){const F=k,g=n,{createVentaFromCarrito:R}=ie(),w=I(),V=H(),T=E(!1),l=E(null),d=E(!1),s=E(null),o=E(!1),r=N(()=>{var i;return(i=V.props.auth)==null?void 0:i.user}),c=N(()=>{var i;return((i=r.value)==null?void 0:i.email)||""}),u=N(()=>{var i;return((i=r.value)==null?void 0:i.name)||""}),h=i=>i?new Intl.NumberFormat("es-CO",{minimumFractionDigits:2,maximumFractionDigits:2}).format(i):"0.00";G(()=>F.isVisible,async i=>{i&&!l.value&&!d.value&&await C()});const C=async()=>{if(w.isEmpty){s.value="El carrito estÃ¡ vacÃ­o";return}if(!c.value){s.value="No se encontrÃ³ informaciÃ³n del usuario";return}T.value=!0,s.value=null;try{const i=await R(c.value);i.success?l.value=i.venta:s.value=i.error||"Error creando la venta"}catch(i){s.value="Error inesperado al crear la venta",console.error("Error creando venta:",i)}finally{T.value=!1}},b=async()=>{if(!l.value){s.value="No hay venta creada";return}o.value=!0,s.value=null;try{const i=()=>{var x;return((x=document.querySelector('meta[name="csrf-token"]'))==null?void 0:x.getAttribute("content"))||null},a=async()=>await fetch("/wompi/payment-link",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":i(),"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({customer_email:c.value,amount:w.totalPrice,description:`Compra de ${w.items.length} producto(s) - ${u.value}`,reference:`CART-${Date.now()}`,customer_name:u.value,productos:w.items.map(x=>({id:x.id,nombre:x.nombre,precio:x.precio,cantidad:x.cantidad,imagen:x.primera_imagen||x.imagen||null,subtotal:x.precio*x.cantidad}))})});let P=await a();if(P.status===419){console.log("ðŸ”„ Token CSRF expirado, renovando...");const X=(await(await fetch("/tienda",{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"text/html,application/xhtml+xml"}})).text()).match(/name="csrf-token" content="([^"]+)"/);if(X){const D=X[1],W=document.querySelector('meta[name="csrf-token"]');W&&(W.setAttribute("content",D),console.log("âœ… Token CSRF renovado:",D))}P=await a()}const $=await P.json();$.success?(window.open($.payment_link,"_blank"),d.value=!0,g("payment-completed",{success:!0,venta:l.value,payment_link:$.payment_link,reference:$.reference})):s.value=$.message||"Error creando enlace de pago"}catch(i){console.error("Error procesando pago:",i),s.value="Error procesando el pago. IntÃ©ntalo de nuevo."}finally{o.value=!1}},_=()=>{g("close"),j()},M=()=>{w.limpiarCarrito(),_()},j=()=>{l.value=null,d.value=!1,s.value=null,T.value=!1},q=()=>{j(),C()};return(i,a)=>{var P,$;return k.isVisible?(f(),p("div",{key:0,class:"modal-overlay",onClick:_},[e("div",{class:"modal-container",onClick:a[0]||(a[0]=L(()=>{},["stop"]))},[e("div",ce,[e("h3",de,[m(t(v),{icon:t(U),class:"title-icon"},null,8,["icon"]),a[1]||(a[1]=S(" Finalizar Compra "))]),e("button",{onClick:_,class:"close-button"},[m(t(v),{icon:t(Y)},null,8,["icon"])])]),T.value?(f(),p("div",ue,a[2]||(a[2]=[e("div",{class:"spinner"},null,-1),e("p",null,"Procesando tu pedido...",-1)]))):s.value?(f(),p("div",me,[m(t(v),{icon:t(Z),class:"error-icon"},null,8,["icon"]),a[3]||(a[3]=e("h4",null,"Error al procesar",-1)),e("p",null,y(s.value),1),e("button",{onClick:q,class:"retry-button"}," Intentar de nuevo ")])):l.value?(f(),p("div",pe,[e("div",fe,[a[6]||(a[6]=e("h4",null,"Resumen de tu compra",-1)),e("div",ve,[e("div",ge,[a[4]||(a[4]=e("span",null,"Total a pagar:",-1)),e("span",be,"$"+y(h(l.value.total)),1)]),e("div",ye,[a[5]||(a[5]=e("span",null,"NÃºmero de orden:",-1)),e("span",he,"#"+y(l.value.id),1)])])]),e("div",xe,[e("button",{onClick:b,disabled:o.value,class:"w-full inline-flex items-center justify-center px-6 py-4 border border-transparent text-lg font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"},[o.value?(f(),p("svg",we,a[8]||(a[8]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)]))):(f(),p("svg",ke,a[7]||(a[7]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"},null,-1)]))),S(" "+y(o.value?"Generando enlace de pago...":"Pagar con Wompi"),1)],8,Ce)]),e("div",_e,[e("div",$e,[m(t(v),{icon:t(ee),class:"info-icon"},null,8,["icon"]),a[9]||(a[9]=e("span",null,"Pago seguro con encriptaciÃ³n SSL",-1))]),e("div",Ee,[m(t(v),{icon:t(te),class:"info-icon"},null,8,["icon"]),a[10]||(a[10]=e("span",null,"Procesamiento inmediato",-1))])])])):d.value?(f(),p("div",Te,[m(t(v),{icon:t(oe),class:"success-icon"},null,8,["icon"]),a[13]||(a[13]=e("h4",null,"Â¡Pago exitoso!",-1)),a[14]||(a[14]=e("p",null,"Tu compra ha sido procesada correctamente.",-1)),e("div",Se,[e("p",null,[a[11]||(a[11]=e("strong",null,"NÃºmero de orden:",-1)),S(" #"+y((P=l.value)==null?void 0:P.id),1)]),e("p",null,[a[12]||(a[12]=e("strong",null,"Total pagado:",-1)),S(" $"+y(h(($=l.value)==null?void 0:$.total)),1)])]),e("button",{onClick:M,class:"success-button"}," Finalizar ")])):A("",!0)])])):A("",!0)}}},Fe=K(Pe,[["__scopeId","data-v-4bf92fc5"]]),Re={class:"absolute right-0 top-0 h-full w-full max-w-md transform transition-transform carrito-panel"},je={class:"flex h-full flex-col bg-white shadow-xl"},Ae={class:"flex items-center justify-between border-b border-gray-200 px-6 py-4"},Ve={class:"text-lg font-semibold text-gray-900 flex items-center gap-2"},Me={class:"px-6 py-2 bg-blue-50 border-b border-blue-100"},qe={class:"text-sm text-blue-800"},Ne={class:"flex-1 overflow-y-auto px-6 py-4 carrito-scroll"},Ie={key:0,class:"flex flex-col items-center justify-center h-full text-center empty-state"},Xe={key:1,class:"space-y-4"},De={class:"flex-shrink-0 w-16 h-16 producto-imagen"},We={class:"flex-1 min-w-0"},ze={class:"text-sm font-medium text-gray-900 truncate"},Be={class:"text-sm text-blue-600 font-semibold"},Oe={class:"text-xs text-gray-500 whitespace-nowrap"},He={class:"flex items-center gap-2"},Le=["onClick","disabled"],Ue={class:"w-8 text-center text-sm font-medium"},Ke=["onClick","disabled"],Ge=["onClick"],Je={key:0,class:"px-6 py-3 border-t border-gray-100"},Qe={key:1,class:"border-t border-gray-200 px-6 py-4 space-y-4"},Ye={class:"flex items-center justify-between"},Ze={class:"text-xl font-bold text-blue-600 total-badge"},et={class:"space-y-2"},tt={__name:"CarritoCompras",setup(k){const n=I(),F=H(),g=E(!1),R=N(()=>{var s;return!!((s=F.props.auth)!=null&&s.user)}),w=s=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(s),V=()=>{if(!R.value){alert("Debes iniciar sesiÃ³n para continuar con la compra");return}if(n.isEmpty){alert("Tu carrito estÃ¡ vacÃ­o");return}g.value=!0},T=()=>{g.value=!1},l=s=>{g.value=!1},d=s=>s.imagen?s.imagen.startsWith("http")||s.imagen.startsWith("data:")?s.imagen:`/storage/productos/${s.imagen}`:null;return(s,o)=>(f(),p(B,null,[t(n).isVisible?(f(),p("div",{key:0,class:"fixed inset-0 z-[10000] overflow-hidden carrito-overlay",onClick:o[5]||(o[5]=L(r=>t(n).ocultarCarrito(),["self"]))},[e("div",{class:"absolute inset-0 bg-black bg-opacity-50 transition-opacity cursor-pointer fondo-clickeable",onClick:o[0]||(o[0]=r=>t(n).ocultarCarrito())}),e("div",Re,[e("div",je,[e("div",Ae,[e("h2",Ve,[m(t(v),{icon:t(se),class:"text-blue-600"},null,8,["icon"]),o[6]||(o[6]=S(" Carrito de Compras "))]),e("button",{onClick:o[1]||(o[1]=r=>t(n).ocultarCarrito()),class:"text-gray-400 hover:text-gray-600 transition-colors"},[m(t(v),{icon:t(ae),class:"w-6 h-6"},null,8,["icon"])])]),e("div",Me,[e("p",qe,y(t(n).itemCount)+" "+y(t(n).itemCount===1?"producto":"productos")+" en tu carrito ",1)]),e("div",Ne,[t(n).isEmpty?(f(),p("div",Ie,[m(t(v),{icon:t(re),class:"w-16 h-16 text-gray-300 mb-4"},null,8,["icon"]),o[7]||(o[7]=e("h3",{class:"text-lg font-medium text-gray-900 mb-2"},"Tu carrito estÃ¡ vacÃ­o",-1)),o[8]||(o[8]=e("p",{class:"text-gray-500 mb-6"},"Agrega algunos productos para comenzar",-1)),e("button",{onClick:o[2]||(o[2]=r=>t(n).ocultarCarrito()),class:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-colors"}," Continuar Comprando ")])):(f(),p("div",Xe,[(f(!0),p(B,null,J(t(n).items,r=>(f(),p("div",{key:r.id,class:"flex items-center gap-4 p-4 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors producto-item"},[e("div",De,[m(Q,{src:d(r),alt:r.nombre,"fallback-text":r.nombre,"container-class":"w-full h-full","image-class":"w-full h-full object-cover rounded-md border border-gray-200"},null,8,["src","alt","fallback-text"])]),e("div",We,[e("h4",ze,y(r.nombre),1),e("p",Be,y(w(r.precio)),1),e("p",Oe," Stock: "+y(r.stock_actual),1)]),e("div",He,[e("button",{onClick:c=>t(n).decrementarCantidad(r.id),class:"w-8 h-8 flex items-center justify-center border border-gray-300 rounded-md hover:bg-gray-50 transition-colors cantidad-btn",disabled:r.cantidad<=1},[m(t(v),{icon:t(ne),class:"w-3 h-3"},null,8,["icon"])],8,Le),e("span",Ue,y(r.cantidad),1),e("button",{onClick:c=>t(n).incrementarCantidad(r.id),class:"w-8 h-8 flex items-center justify-center border border-gray-300 rounded-md hover:bg-gray-50 transition-colors cantidad-btn",disabled:r.cantidad>=r.stock_actual},[m(t(v),{icon:t(le),class:"w-3 h-3"},null,8,["icon"])],8,Ke)]),e("button",{onClick:c=>t(n).eliminarProducto(r.id),class:"p-2 text-red-400 hover:text-red-600 transition-colors btn-eliminar",title:"Eliminar producto"},[m(t(v),{icon:t(O),class:"w-4 h-4"},null,8,["icon"])],8,Ge)]))),128))]))]),t(n).isEmpty?A("",!0):(f(),p("div",Je,[e("button",{onClick:o[3]||(o[3]=r=>t(n).limpiarCarrito()),class:"w-full text-red-500 hover:text-red-700 hover:bg-red-50 py-2 px-4 text-sm transition-colors flex items-center justify-center gap-2 rounded-md border border-red-200 hover:border-red-300"},[m(t(v),{icon:t(O),class:"w-4 h-4"},null,8,["icon"]),o[9]||(o[9]=S(" Vaciar Carrito "))])])),t(n).isEmpty?A("",!0):(f(),p("div",Qe,[e("div",Ye,[o[10]||(o[10]=e("span",{class:"text-lg font-semibold text-gray-900"},"Total:",-1)),e("span",Ze,y(w(t(n).totalPrice)),1)]),e("div",et,[e("button",{onClick:V,class:"w-full text-white py-3 px-4 rounded-md transition-colors flex items-center justify-center gap-2 font-medium btn-checkout"},[m(t(v),{icon:t(U)},null,8,["icon"]),o[11]||(o[11]=S(" Proceder al Checkout "))]),e("button",{onClick:o[4]||(o[4]=r=>t(n).ocultarCarrito()),class:"w-full text-white py-2 px-4 rounded-md transition-colors btn-continuar"}," Continuar Comprando ")])]))])])])):A("",!0),m(Fe,{"is-visible":g.value,onClose:T,onPaymentCompleted:l},null,8,["is-visible"])],64))}},dt=K(tt,[["__scopeId","data-v-579d1735"]]);export{dt as default};
