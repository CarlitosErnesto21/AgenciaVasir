import{r as k,N as B,a4 as Y,E as N,w as oe,c as y,j as F,d as f,e,p as c,q as E,$ as t,t as b,F as L,l as Z,h as z,I as ee,x as X,B as W,y as se}from"./vendor-DcS5GX9S.js";import{u as H}from"./carrito-B5mGcg2L.js";import{D as m}from"./ui-DN6aYgk-.js";import{I as re}from"./ImageWithFallback-_VPuFh5t.js";import{ao as O,s as I,h as J,ap as ne,a8 as le,p as ie,a9 as te,g as ce,aq as ue,t as de,b as pe,O as Q}from"./index-DObSwni0.js";import{_ as ae}from"./_plugin-vue_export-helper-DlAUqK2U.js";import me from"./ModalDatosCliente-CT9RT75j.js";import"./app-BYiN5B7a.js";import"./vue-tel-input-D_h7FK_m.js";function fe(){const P=k(!1),d=k(null),$=H(),h=B.create(),R=()=>{var v;return((v=document.head.querySelector('meta[name="csrf-token"]'))==null?void 0:v.content)||null};return h.interceptors.request.use(r=>{const v=R();return v&&(r.headers["X-CSRF-TOKEN"]=v),r.headers["X-Requested-With"]="XMLHttpRequest",r.headers.Accept="application/json",r}),{loading:P,error:d,createVentaFromCarrito:async(r,v=null)=>{var l,u,T,p,C;P.value=!0,d.value=null;try{const g={productos:$.items.map(a=>({id:a.id,cantidad:a.cantidad,precio:a.precio,nombre:a.nombre,imagen:a.primera_imagen||a.imagen||null,subtotal:a.precio*a.cantidad})),customer_email:r,cliente_data:v};let w;try{w=await h.post("/carrito/create-venta",g)}catch(a){if(((l=a.response)==null?void 0:l.status)===419){console.log("ðŸ”„ Token CSRF expirado, renovando...");try{const s=await B.get("/tienda",{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"text/html,application/xhtml+xml"}});if(s.data&&typeof s.data=="string"){const i=s.data.match(/name="csrf-token" content="([^"]+)"/);if(i){const A=i[1],n=document.head.querySelector('meta[name="csrf-token"]');n&&(n.setAttribute("content",A),console.log("âœ… Token CSRF renovado:",A))}}w=await h.post("/carrito/create-venta",g)}catch(s){throw s}}else throw a}if(w.data.success)return{success:!0,venta:w.data.venta,message:w.data.message};throw new Error(w.data.message||"Error desconocido")}catch(_){console.error("Error creando venta desde carrito:",_);let g="Error al crear la venta";return(T=(u=_.response)==null?void 0:u.data)!=null&&T.message?g=_.response.data.message:(C=(p=_.response)==null?void 0:p.data)!=null&&C.errors?g=Object.values(_.response.data.errors).flat().join(", "):_.message&&(g=_.message),d.value=g,{success:!1,error:g}}finally{P.value=!1}},procesarPagoVenta:async r=>{var v,l,u,T;P.value=!0,d.value=null;try{const p=await h.post("/pagos/venta",r);if(p.data.success)return{success:!0,pago:p.data.pago,wompi_data:p.data.wompi_data,message:p.data.message};throw new Error(p.data.message||"Error en el pago")}catch(p){console.error("Error procesando pago:",p);let C="Error al procesar el pago";return(l=(v=p.response)==null?void 0:v.data)!=null&&l.message?C=p.response.data.message:(T=(u=p.response)==null?void 0:u.data)!=null&&T.errors?C=Object.values(p.response.data.errors).flat().join(", "):p.message&&(C=p.message),d.value=C,{success:!1,error:C}}finally{P.value=!1}},consultarEstadoPago:async r=>{var v,l;try{const u=await h.get(`/pagos/${r}/estado`);if(u.data.success)return{success:!0,pago:u.data.pago};throw new Error(u.data.message||"Error consultando estado")}catch(u){return console.error("Error consultando estado del pago:",u),{success:!1,error:((l=(v=u.response)==null?void 0:v.data)==null?void 0:l.message)||u.message||"Error consultando estado"}}}}}const ve={class:"modal-header"},ge={class:"modal-title"},ye={key:0,class:"loading-state"},be={key:1,class:"error-state"},he={class:"flex justify-center gap-4 w-full mt-4"},xe={key:2,class:"payment-form"},_e={class:"purchase-summary"},Ce={class:"summary-details"},ke={class:"cart-items"},we={class:"item-name"},Ee={class:"item-quantity"},$e={class:"item-price"},Te={class:"total-amount"},Se={class:"amount"},Pe={class:"payment-section"},je={class:"flex justify-center gap-4 w-full"},De=["disabled"],Fe=["disabled"],Re={class:"payment-info"},qe={class:"info-item"},Ae={class:"info-item"},Me={key:3,class:"success-state"},Ve={class:"success-details"},Ne={key:0},Ie={class:"cart-cleared-notice"},Oe={class:"success-actions"},Xe={class:"flex justify-center gap-4 w-full mt-4"},We={__name:"CarritoCheckoutModal",props:{isVisible:{type:Boolean,default:!1},clienteData:{type:Object,default:null}},emits:["close","payment-completed"],setup(P,{emit:d}){const $=P,h=d,{createVentaFromCarrito:R}=fe(),x=H(),q=Y(),S=k(!1),r=k(null),v=k(!1),l=k(null),u=k(!1),T=N(()=>{var n;return(n=q.props.auth)==null?void 0:n.user}),p=N(()=>{var n;return((n=T.value)==null?void 0:n.email)||""}),C=N(()=>{var n;return(n=T.value)!=null&&n.name?T.value.name:"Cliente"}),_=N(()=>$.clienteData?{id:$.clienteData.id,numero_identificacion:$.clienteData.numero_identificacion,telefono:$.clienteData.telefono,direccion:$.clienteData.direccion,tipo_documento_id:$.clienteData.tipo_documento_id}:null),g=n=>n?new Intl.NumberFormat("es-CO",{minimumFractionDigits:2,maximumFractionDigits:2}).format(n):"0.00";oe(()=>$.isVisible,n=>{n&&i()});const w=async()=>{if(x.isEmpty){l.value="El carrito estÃ¡ vacÃ­o";return}if(!p.value){l.value="No se encontrÃ³ informaciÃ³n del usuario";return}if(!_.value){l.value="No se encontraron datos del cliente";return}S.value=!0,l.value=null;try{const n=await R(p.value,_.value);n.success?r.value=n.venta:l.value=n.error||"Error creando la venta"}catch(n){l.value="Error inesperado al crear la venta",console.error("Error creando venta:",n)}finally{S.value=!1}},a=async()=>{if(u.value=!0,l.value=null,!r.value){S.value=!0;try{if(await w(),l.value||!r.value){u.value=!1;return}}finally{S.value=!1}}try{const n=()=>{var M;return((M=document.querySelector('meta[name="csrf-token"]'))==null?void 0:M.getAttribute("content"))||null},o=async()=>{var M;return await fetch("/wompi/payment-link",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":n(),"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({customer_email:p.value,amount:x.totalPrice,description:`Compra de ${x.items.length} producto(s) - ${C.value}`,reference:`CART-${Date.now()}`,customer_name:C.value,venta_id:((M=r.value)==null?void 0:M.id)||null,productos:x.items.map(D=>({id:D.id,nombre:D.nombre,precio:D.precio,cantidad:D.cantidad,imagen:D.primera_imagen||D.imagen||null,subtotal:D.precio*D.cantidad}))})})};let j=await o();if(j.status===419){console.log("ðŸ”„ Token CSRF expirado, renovando...");const U=(await(await fetch("/tienda",{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"text/html,application/xhtml+xml"}})).text()).match(/name="csrf-token" content="([^"]+)"/);if(U){const G=U[1],K=document.querySelector('meta[name="csrf-token"]');K&&(K.setAttribute("content",G),console.log("âœ… Token CSRF renovado:",G))}j=await o()}const V=await j.json();V.success?(window.open(V.payment_link,"_blank"),x.limpiarCarrito(),v.value=!0,setTimeout(()=>{s()},3e3),h("payment-completed",{success:!0,venta:r.value,payment_link:V.payment_link,reference:V.reference,cart_cleared:!0})):l.value=V.message||"Error creando enlace de pago"}catch(n){console.error("Error procesando pago:",n),l.value="Error procesando el pago. IntÃ©ntalo de nuevo."}finally{u.value=!1}},s=()=>{h("close"),i()},i=()=>{r.value=null,v.value=!1,l.value=null,S.value=!1},A=()=>{i(),w()};return(n,o)=>P.isVisible?(f(),y("div",{key:0,class:"modal-overlay",onClick:s},[e("div",{class:"modal-container",onClick:o[0]||(o[0]=ee(()=>{},["stop"]))},[e("div",ve,[e("h3",ge,[c(t(m),{icon:t(O),class:"title-icon"},null,8,["icon"]),o[1]||(o[1]=E(" Finalizar Compra "))]),e("button",{onClick:s,class:"close-button"},[c(t(m),{icon:t(I)},null,8,["icon"])])]),S.value?(f(),y("div",ye,o[2]||(o[2]=[e("div",{class:"spinner"},null,-1),e("p",null,"Procesando tu pedido...",-1)]))):l.value?(f(),y("div",be,[c(t(m),{icon:t(J),class:"error-icon"},null,8,["icon"]),o[5]||(o[5]=e("h4",null,"Error al procesar",-1)),e("p",null,b(l.value),1),e("div",he,[e("button",{onClick:s,class:"bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2"},[c(t(m),{icon:t(I),class:"h-5"},null,8,["icon"]),o[3]||(o[3]=E(" Cancelar "))]),e("button",{onClick:A,class:"bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2"},[c(t(m),{icon:t(J),class:"h-5"},null,8,["icon"]),o[4]||(o[4]=E(" Intentar de nuevo "))])])])):(f(),y("div",xe,[e("div",_e,[o[7]||(o[7]=e("h4",null,"Resumen de tu compra",-1)),e("div",Ce,[e("div",ke,[(f(!0),y(L,null,Z(t(x).items,j=>(f(),y("div",{key:j.id,class:"cart-item"},[e("span",we,b(j.nombre),1),e("span",Ee,b(j.cantidad)+"x",1),e("span",$e,"$"+b(g(j.precio*j.cantidad)),1)]))),128))]),e("div",Te,[o[6]||(o[6]=e("span",null,"Total a pagar:",-1)),e("span",Se,"$"+b(g(t(x).totalPrice)),1)])])]),e("div",Pe,[e("div",je,[e("button",{onClick:s,class:"bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2",disabled:u.value},[c(t(m),{icon:t(I),class:"h-5"},null,8,["icon"]),o[8]||(o[8]=E(" Cancelar "))],8,De),e("button",{onClick:a,disabled:u.value,class:"bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"},[u.value?(f(),z(t(m),{key:1,icon:t(O),class:"h-5 animate-spin"},null,8,["icon"])):(f(),z(t(m),{key:0,icon:t(O),class:"h-5"},null,8,["icon"])),E(" "+b(u.value?"Generando enlace...":"Pagar con Wompi"),1)],8,Fe)])]),e("div",Re,[e("div",qe,[c(t(m),{icon:t(ne),class:"info-icon"},null,8,["icon"]),o[9]||(o[9]=e("span",null,"Pago seguro con encriptaciÃ³n SSL",-1))]),e("div",Ae,[c(t(m),{icon:t(le),class:"info-icon"},null,8,["icon"]),o[10]||(o[10]=e("span",null,"Procesamiento inmediato",-1))])])])),v.value?(f(),y("div",Me,[c(t(m),{icon:t(ie),class:"success-icon"},null,8,["icon"]),o[16]||(o[16]=e("h4",null,"Â¡Enlace de pago creado!",-1)),o[17]||(o[17]=e("p",null,"Se abriÃ³ una nueva ventana con tu enlace de pago seguro.",-1)),e("div",Ve,[r.value?(f(),y("p",Ne,[o[11]||(o[11]=e("strong",null,"NÃºmero de orden:",-1)),E(" #"+b(r.value.id),1)])):F("",!0),e("p",null,[o[12]||(o[12]=e("strong",null,"Total pagado:",-1)),E(" $"+b(g(t(x).totalPrice)),1)]),e("p",Ie,[c(t(m),{icon:t(te),class:"cart-icon"},null,8,["icon"]),o[13]||(o[13]=E(" Tu carrito se ha limpiado automÃ¡ticamente "))])]),e("div",Oe,[o[15]||(o[15]=e("p",{class:"auto-close-notice"},"Esta ventana se cerrarÃ¡ automÃ¡ticamente en unos segundos",-1)),e("div",Xe,[e("button",{onClick:s,class:"bg-blue-500 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2"},[c(t(m),{icon:t(I),class:"h-5"},null,8,["icon"]),o[14]||(o[14]=E(" Cerrar ahora "))])])])])):F("",!0)])])):F("",!0)}},Be=ae(We,[["__scopeId","data-v-99a72a10"]]),Le={key:0,class:"absolute right-0 top-0 h-full w-full max-w-md transform carrito-panel"},ze={class:"flex h-full flex-col bg-white shadow-xl"},He={class:"flex items-center justify-between border-b border-gray-200 px-6 py-4"},Ue={class:"text-lg font-semibold text-gray-900 flex items-center gap-2"},Ge={class:"px-6 py-2 bg-blue-50 border-b border-blue-100"},Ke={class:"text-sm text-blue-800"},Je={class:"flex-1 overflow-y-auto px-6 py-4 carrito-scroll"},Qe={key:0,class:"flex flex-col items-center justify-center h-full text-center empty-state"},Ye={key:1,class:"space-y-4"},Ze={class:"flex-shrink-0 w-16 h-16 producto-imagen"},et={class:"flex-1 min-w-0"},tt={class:"text-sm font-medium text-gray-900 truncate"},at={class:"text-sm text-blue-600 font-semibold"},ot={class:"text-xs text-gray-500 whitespace-nowrap"},st={class:"flex items-center gap-2"},rt=["onClick","disabled"],nt={class:"w-8 text-center text-sm font-medium"},lt=["onClick","disabled"],it=["onClick"],ct={key:0,class:"px-6 py-3 border-t border-gray-100"},ut={key:1,class:"border-t border-gray-200 px-6 py-4 space-y-4"},dt={class:"flex items-center justify-between"},pt={class:"text-xl font-bold text-blue-600 total-badge"},mt={class:"space-y-2"},ft=["disabled"],vt={__name:"CarritoCompras",setup(P){const d=H(),$=Y(),h=k(!1),R=k(!1),x=k(!1),q=k(null),S=k(!1),r=k(!1),v=N(()=>{var a;return!!((a=$.props.auth)!=null&&a.user)}),l=a=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(a),u=async()=>{if(!v.value)return{tieneCliente:!1,cliente:null};try{S.value=!0;const a=await B.get("/api/verificar-datos-cliente");return a.data.success&&a.data.tiene_datos_completos?(q.value=a.data.cliente,{tieneCliente:!0,cliente:a.data.cliente}):{tieneCliente:!1,cliente:null}}catch(a){return console.error("Error al verificar cliente:",a),{tieneCliente:!1,cliente:null}}finally{S.value=!1}},T=async()=>{if(d.isEmpty){alert("Tu carrito estÃ¡ vacÃ­o");return}if(!v.value){alert("Debes iniciar sesiÃ³n para proceder con la compra");return}try{r.value=!0,g(),setTimeout(async()=>{try{const{tieneCliente:a,cliente:s}=await u();a?(q.value=s,h.value=!0):R.value=!0}catch(a){console.error("Error en proceso de checkout:",a),alert("OcurriÃ³ un error al procesar tu solicitud. Por favor intenta nuevamente.")}finally{r.value=!1}},350)}catch(a){console.error("Error inicial en checkout:",a),r.value=!1,alert("OcurriÃ³ un error al procesar tu solicitud. Por favor intenta nuevamente.")}},p=()=>{h.value=!1},C=a=>{q.value=a,R.value=!1,setTimeout(()=>{h.value=!0},300)},_=a=>{h.value=!1},g=()=>{x.value=!0,setTimeout(()=>{d.ocultarCarrito(),x.value=!1},300)},w=a=>a.imagen?a.imagen.startsWith("http")||a.imagen.startsWith("data:")?a.imagen:`/storage/productos/${a.imagen}`:null;return(a,s)=>(f(),y(L,null,[c(W,{name:"carrito-fade",appear:""},{default:X(()=>[t(d).isVisible?(f(),y("div",{key:0,class:"fixed inset-0 z-[10000] overflow-hidden carrito-overlay",onClick:ee(g,["self"])},[c(W,{name:"backdrop-fade",appear:""},{default:X(()=>[x.value?F("",!0):(f(),y("div",{key:0,class:"absolute inset-0 bg-black bg-opacity-50 transition-opacity cursor-pointer fondo-clickeable",onClick:g}))]),_:1}),c(W,{name:"carrito-slide",appear:""},{default:X(()=>[x.value?F("",!0):(f(),y("div",Le,[e("div",ze,[e("div",He,[e("h2",Ue,[c(t(m),{icon:t(te),class:"text-blue-600"},null,8,["icon"]),s[2]||(s[2]=E(" Carrito de Compras "))]),e("button",{onClick:g,class:"text-gray-400 hover:text-gray-600 transition-colors"},[c(t(m),{icon:t(ce),class:"w-6 h-6"},null,8,["icon"])])]),e("div",Ge,[e("p",Ke,b(t(d).itemCount)+" "+b(t(d).itemCount===1?"producto":"productos")+" en tu carrito ",1)]),e("div",Je,[t(d).isEmpty?(f(),y("div",Qe,[c(t(m),{icon:t(ue),class:"w-16 h-16 text-gray-300 mb-4"},null,8,["icon"]),s[3]||(s[3]=e("h3",{class:"text-lg font-medium text-gray-900 mb-2"},"Tu carrito estÃ¡ vacÃ­o",-1)),s[4]||(s[4]=e("p",{class:"text-gray-500 mb-6"},"Agrega algunos productos para comenzar",-1)),e("button",{onClick:g,class:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-colors"}," Continuar Comprando ")])):(f(),y("div",Ye,[(f(!0),y(L,null,Z(t(d).items,i=>(f(),y("div",{key:i.id,class:"flex items-center gap-4 p-4 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors producto-item"},[e("div",Ze,[c(re,{src:w(i),alt:i.nombre,"fallback-text":i.nombre,"container-class":"w-full h-full","image-class":"w-full h-full object-cover rounded-md border border-gray-200"},null,8,["src","alt","fallback-text"])]),e("div",et,[e("h4",tt,b(i.nombre),1),e("p",at,b(l(i.precio)),1),e("p",ot," Stock: "+b(i.stock_actual),1)]),e("div",st,[e("button",{onClick:A=>t(d).decrementarCantidad(i.id),class:"w-8 h-8 flex items-center justify-center border border-gray-300 rounded-md hover:bg-gray-50 transition-colors cantidad-btn",disabled:i.cantidad<=1},[c(t(m),{icon:t(de),class:"w-3 h-3"},null,8,["icon"])],8,rt),e("span",nt,b(i.cantidad),1),e("button",{onClick:A=>t(d).incrementarCantidad(i.id),class:"w-8 h-8 flex items-center justify-center border border-gray-300 rounded-md hover:bg-gray-50 transition-colors cantidad-btn",disabled:i.cantidad>=i.stock_actual},[c(t(m),{icon:t(pe),class:"w-3 h-3"},null,8,["icon"])],8,lt)]),e("button",{onClick:A=>t(d).eliminarProducto(i.id),class:"p-2 text-red-400 hover:text-red-600 transition-colors btn-eliminar",title:"Eliminar producto"},[c(t(m),{icon:t(Q),class:"w-4 h-4"},null,8,["icon"])],8,it)]))),128))]))]),t(d).isEmpty?F("",!0):(f(),y("div",ct,[e("button",{onClick:s[0]||(s[0]=i=>t(d).limpiarCarrito()),class:"w-full text-red-500 hover:text-red-700 hover:bg-red-50 py-2 px-4 text-sm transition-colors flex items-center justify-center gap-2 rounded-md border border-red-200 hover:border-red-300"},[c(t(m),{icon:t(Q),class:"w-4 h-4"},null,8,["icon"]),s[5]||(s[5]=E(" Vaciar Carrito "))])])),t(d).isEmpty?F("",!0):(f(),y("div",ut,[e("div",dt,[s[6]||(s[6]=e("span",{class:"text-lg font-semibold text-gray-900"},"Total:",-1)),e("span",pt,b(l(t(d).totalPrice)),1)]),e("div",mt,[e("button",{onClick:T,disabled:r.value,class:se(["w-full text-white py-3 px-4 rounded-md transition-colors flex items-center justify-center gap-2 font-medium btn-checkout",{loading:r.value}])},[r.value?F("",!0):(f(),z(t(m),{key:0,icon:t(O)},null,8,["icon"])),E(" "+b(r.value?"Procesando...":"Proceder al Checkout"),1)],10,ft),e("button",{onClick:g,class:"w-full text-white py-2 px-4 rounded-md transition-colors btn-continuar"}," Continuar Comprando ")])]))])]))]),_:1})])):F("",!0)]),_:1}),c(me,{visible:R.value,"onUpdate:visible":s[1]||(s[1]=i=>R.value=i),onClienteGuardado:C},null,8,["visible"]),c(Be,{"is-visible":h.value,"cliente-data":q.value,onClose:p,onPaymentCompleted:_},null,8,["is-visible","cliente-data"])],64))}},Et=ae(vt,[["__scopeId","data-v-fec53078"]]);export{Et as default};
