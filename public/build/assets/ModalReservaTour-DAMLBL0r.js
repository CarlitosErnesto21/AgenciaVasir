import{z as V,A as j}from"./ui-BjYE_i4I.js";import{e as X,g as $}from"./index-DIJG4gfJ.js";import{r as _,E as G,w as H,k as F,c as U,d as N,p as c,x as g,j as K,e as u,q as z,$ as p,F as L,N as P}from"./vendor-CaDzpwPW.js";import W from"./ResumenTour-Dx4z20Wh.js";import J from"./FormularioDatosPersonales-DPqRh2FE.js";import Q from"./SelectorCupos-Dw0-UQ1Z.js";import"./vue-tel-input-AlIeehSu.js";const Y={key:0,class:"space-y-3 sm:space-y-4 lg:space-y-6 text-xs sm:text-sm text-gray-700"},Z={class:"flex justify-center gap-4 w-full mt-6"},ie={__name:"ModalReservaTour",props:{visible:{type:Boolean,default:!1},tourSeleccionado:{type:Object,default:null},user:{type:Object,default:null}},emits:["update:visible","confirmar-reserva","actualizar-cupos","refrescar-tour"],setup(d,{emit:I}){const l=V(),n=d,m=I,f=_(null),o=_({correo:"",nombres:"",tipo_documento:"DUI",numero_identificacion:"",fecha_nacimiento:"",genero:"",direccion:"",telefono:"",cupos_adultos:1,cupos_menores:0}),v=_(!1),M=async()=>{var a;if(!n.user)return null;try{const e=await fetch("/api/cliente-datos",{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((a=document.querySelector('meta[name="csrf-token"]'))==null?void 0:a.getAttribute("content"))||"","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});return e.ok?(await e.json()).cliente||null:(e.status===404||console.error("Error al cargar datos del cliente:",e.status),null)}catch(e){return console.error("Error al cargar datos del cliente:",e),null}},A=async()=>{const a=n.user;let e="",i="";if(a&&(i=a.email||"",e=a.name||""),o.value={correo:i,nombres:e,tipo_documento:"DUI",numero_identificacion:"",fecha_nacimiento:"",genero:"",direccion:"",telefono:"",cupos_adultos:1,cupos_menores:0},v.value=!1,a){const t=await M();if(t){v.value=!0;let r="";if(t.fecha_nacimiento)try{r=new Date(t.fecha_nacimiento)}catch{}o.value={...o.value,tipo_documento:t.tipo_documento||"DUI",numero_identificacion:t.numero_identificacion||"",fecha_nacimiento:r,genero:t.genero||"",direccion:t.direccion||"",telefono:t.telefono||""}}}},y=()=>{m("update:visible",!1)},x=a=>{l.add(a)},q=async()=>{var a,e,i,t,r,b,w,h,C,S,D,E,T,k;if(!((a=f.value)!=null&&a.validateForm&&!f.value.validateForm())){if(o.value.cupos_adultos<=0&&o.value.cupos_menores<=0){l.add({severity:"error",summary:"Error en la reserva",detail:"Debe seleccionar al menos un cupo.",life:4e3});return}try{const s=await P.post("/reservas/tour",{tour_id:n.tourSeleccionado.id,cliente_data:{correo:o.value.correo,nombres:o.value.nombres,tipo_documento:o.value.tipo_documento,numero_identificacion:o.value.numero_identificacion,fecha_nacimiento:o.value.fecha_nacimiento,genero:((e=o.value.genero)==null?void 0:e.toUpperCase())||"",direccion:o.value.direccion,telefono:o.value.telefono},cupos_adultos:o.value.cupos_adultos,cupos_menores:o.value.cupos_menores,precio_total:B.value.total});((t=(i=s.data)==null?void 0:i.data)==null?void 0:t.cupos_disponibles_actualizados)!==void 0&&m("actualizar-cupos",{tourId:n.tourSeleccionado.id,cuposDisponibles:s.data.data.cupos_disponibles_actualizados}),m("refrescar-tour",n.tourSeleccionado.id),m("confirmar-reserva",s.data),y()}catch(s){if(console.error("Error al confirmar reserva:",s),((r=s.response)==null?void 0:r.status)===419)l.add({severity:"error",summary:"Sesi贸n expirada",detail:"Su sesi贸n ha expirado. Por favor, recargue la p谩gina.",life:5e3}),window.location.reload();else if(((b=s.response)==null?void 0:b.status)===422){const O=((h=(w=s.response)==null?void 0:w.data)==null?void 0:h.errors)||{},R=Object.values(O).flat();R.length>0?l.add({severity:"error",summary:"Errores de validaci贸n",detail:R.join(", "),life:5e3}):l.add({severity:"error",summary:"Error de validaci贸n",detail:((S=(C=s.response)==null?void 0:C.data)==null?void 0:S.message)||"Datos inv谩lidos",life:4e3})}else((D=s.response)==null?void 0:D.status)===403?l.add({severity:"error",summary:"Acceso denegado",detail:"No tiene permisos para realizar esta acci贸n. Debe tener rol de cliente.",life:4e3}):((E=s.response)==null?void 0:E.status)===401?l.add({severity:"error",summary:"Sesi贸n requerida",detail:"Debe iniciar sesi贸n para realizar una reserva.",life:4e3}):l.add({severity:"error",summary:"Error al procesar la reserva",detail:((k=(T=s.response)==null?void 0:T.data)==null?void 0:k.message)||"Int茅ntelo de nuevo.",life:4e3})}}},B=G(()=>{if(!n.tourSeleccionado)return{total:0};const a=n.tourSeleccionado.precio||n.tourSeleccionado.precio_adulto||0,e=o.value.cupos_adultos+o.value.cupos_menores;return{total:a*e}});return H(()=>n.visible,async a=>{a&&await A()}),(a,e)=>{const i=F("Toast"),t=F("Dialog");return N(),U(L,null,[c(i),c(t,{visible:d.visible,"onUpdate:visible":e[3]||(e[3]=r=>m("update:visible",r)),modal:"",closable:!1,class:"w-[95vw] sm:w-[90vw] md:w-[85vw] lg:w-[80vw] xl:max-w-4xl mx-2 sm:mx-4",draggable:!1},{header:g(()=>e[4]||(e[4]=[u("h3",{class:"text-sm sm:text-base lg:text-lg font-bold text-red-700 flex items-center"},[u("span",{class:"mr-1 sm:mr-2"},"Ь"),u("span",{class:"hidden sm:inline"},"Reservando Tour"),u("span",{class:"sm:hidden"},"Reserva")],-1)])),footer:g(()=>[u("div",Z,[u("button",{onClick:q,type:"button",class:"bg-red-500 hover:bg-red-700 text-white border-none px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"},[c(p(j),{icon:p(X),class:"h-5 text-white"},null,8,["icon"]),e[5]||(e[5]=z(" Confirmar Reserva "))]),u("button",{onClick:y,type:"button",class:"bg-blue-500 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2"},[c(p(j),{icon:p($),class:"h-5"},null,8,["icon"]),e[6]||(e[6]=z(" Cancelar "))])])]),default:g(()=>[d.tourSeleccionado?(N(),U("div",Y,[c(W,{"tour-seleccionado":d.tourSeleccionado},null,8,["tour-seleccionado"]),c(J,{ref_key:"formularioDatosRef",ref:f,formulario:o.value,"onUpdate:formulario":e[0]||(e[0]=r=>o.value=r),"tiene-cliente-existente":v.value,user:d.user,onMostrarToast:x},null,8,["formulario","tiene-cliente-existente","user"]),c(Q,{"cupos-adultos":o.value.cupos_adultos,"onUpdate:cuposAdultos":e[1]||(e[1]=r=>o.value.cupos_adultos=r),"cupos-menores":o.value.cupos_menores,"onUpdate:cuposMenores":e[2]||(e[2]=r=>o.value.cupos_menores=r),"tour-seleccionado":d.tourSeleccionado,onMostrarToast:x},null,8,["cupos-adultos","cupos-menores","tour-seleccionado"])])):K("",!0)]),_:1},8,["visible"])],64)}}};export{ie as default};
