import{z as B,A as k}from"./ui-CVJOYm3g.js";import{e as V,g as $}from"./index-BBUgHj35.js";import{r as b,E as G,w as H,k as F,c as M,d as N,p as c,x as y,j as K,e as u,q as U,$ as f,F as L,N as W}from"./vendor-CqKcGHPa.js";import P from"./ResumenTour-BWNcqkVz.js";import J from"./FormularioDatosPersonales-DXjOugvd.js";import Q from"./SelectorCupos-9M07rULv.js";import"./vue-tel-input-J95PmLrS.js";const Y={key:0,class:"space-y-3 sm:space-y-4 lg:space-y-6 text-xs sm:text-sm text-gray-700"},Z={class:"flex justify-center gap-4 w-full mt-6"},ie={__name:"ModalReservaTour",props:{visible:{type:Boolean,default:!1},tourSeleccionado:{type:Object,default:null},user:{type:Object,default:null}},emits:["update:visible","confirmar-reserva","actualizar-cupos","refrescar-tour"],setup(d,{emit:q}){const l=B(),i=d,m=q,v=b(null),o=b({correo:"",nombres:"",tipo_documento:"DUI",numero_identificacion:"",fecha_nacimiento:"",genero:"",direccion:"",telefono:"",cupos_adultos:1,cupos_menores:0}),_=b(!1),A=async()=>{var a,e;if(!i.user)return null;try{const s=await fetch("/api/verificar-datos-cliente",{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((a=document.querySelector('meta[name="csrf-token"]'))==null?void 0:a.getAttribute("content"))||"","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(s.ok){if(!(await s.json()).tiene_datos_completos)return null;const t=await fetch("/api/cliente-datos",{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((e=document.querySelector('meta[name="csrf-token"]'))==null?void 0:e.getAttribute("content"))||"","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(t.ok)return(await t.json()).cliente||null}return null}catch(s){return console.error("[ModalReservaTour] Error de conexi贸n al cargar datos del cliente:",s),null}},z=async()=>{const a=i.user;let e="",s="";if(a&&(s=a.email||"",e=a.name||""),o.value={correo:s,nombres:e,tipo_documento:"DUI",numero_identificacion:"",fecha_nacimiento:"",genero:"",direccion:"",telefono:"",cupos_adultos:1,cupos_menores:0},_.value=!1,a){const r=await A();if(r){_.value=!0;let t="";if(r.fecha_nacimiento)try{t=new Date(r.fecha_nacimiento)}catch{}o.value={...o.value,tipo_documento:r.tipo_documento||"DUI",numero_identificacion:r.numero_identificacion||"",fecha_nacimiento:t,genero:r.genero||"",direccion:r.direccion||"",telefono:r.telefono||""}}}},g=()=>{m("update:visible",!1)},x=a=>{l.add(a)},I=async()=>{var a,e,s,r,t,p,w,h,C,S,T,R,D,E;if(!((a=v.value)!=null&&a.validateForm&&!v.value.validateForm())){if(o.value.cupos_adultos<=0&&o.value.cupos_menores<=0){l.add({severity:"error",summary:"Error en la reserva",detail:"Debe seleccionar al menos un cupo.",life:4e3});return}try{const n=await W.post("/reservas/tour",{tour_id:i.tourSeleccionado.id,cliente_data:{correo:o.value.correo,nombres:o.value.nombres,tipo_documento:o.value.tipo_documento,numero_identificacion:o.value.numero_identificacion,fecha_nacimiento:o.value.fecha_nacimiento,genero:((e=o.value.genero)==null?void 0:e.toUpperCase())||"",direccion:o.value.direccion,telefono:o.value.telefono},cupos_adultos:o.value.cupos_adultos,cupos_menores:o.value.cupos_menores,precio_total:X.value.total});((r=(s=n.data)==null?void 0:s.data)==null?void 0:r.cupos_disponibles_actualizados)!==void 0&&m("actualizar-cupos",{tourId:i.tourSeleccionado.id,cuposDisponibles:n.data.data.cupos_disponibles_actualizados}),m("refrescar-tour",i.tourSeleccionado.id),m("confirmar-reserva",n.data),g()}catch(n){if(console.error("Error al confirmar reserva:",n),((t=n.response)==null?void 0:t.status)===419)l.add({severity:"error",summary:"Sesi贸n expirada",detail:"Su sesi贸n ha expirado. Por favor, recargue la p谩gina.",life:5e3}),window.location.reload();else if(((p=n.response)==null?void 0:p.status)===422){const O=((h=(w=n.response)==null?void 0:w.data)==null?void 0:h.errors)||{},j=Object.values(O).flat();j.length>0?l.add({severity:"error",summary:"Errores de validaci贸n",detail:j.join(", "),life:5e3}):l.add({severity:"error",summary:"Error de validaci贸n",detail:((S=(C=n.response)==null?void 0:C.data)==null?void 0:S.message)||"Datos inv谩lidos",life:4e3})}else((T=n.response)==null?void 0:T.status)===403?l.add({severity:"error",summary:"Acceso denegado",detail:"No tiene permisos para realizar esta acci贸n. Debe tener rol de cliente.",life:4e3}):((R=n.response)==null?void 0:R.status)===401?l.add({severity:"error",summary:"Sesi贸n requerida",detail:"Debe iniciar sesi贸n para realizar una reserva.",life:4e3}):l.add({severity:"error",summary:"Error al procesar la reserva",detail:((E=(D=n.response)==null?void 0:D.data)==null?void 0:E.message)||"Int茅ntelo de nuevo.",life:4e3})}}},X=G(()=>{if(!i.tourSeleccionado)return{total:0};const a=i.tourSeleccionado.precio||i.tourSeleccionado.precio_adulto||0,e=o.value.cupos_adultos+o.value.cupos_menores;return{total:a*e}});return H(()=>i.visible,async a=>{a&&await z()}),(a,e)=>{const s=F("Toast"),r=F("Dialog");return N(),M(L,null,[c(s),c(r,{visible:d.visible,"onUpdate:visible":e[3]||(e[3]=t=>m("update:visible",t)),modal:"",closable:!1,class:"w-[95vw] sm:w-[90vw] md:w-[85vw] lg:w-[80vw] xl:max-w-4xl mx-2 sm:mx-4",draggable:!1},{header:y(()=>e[4]||(e[4]=[u("h3",{class:"text-sm sm:text-base lg:text-lg font-bold text-red-700 flex items-center"},[u("span",{class:"mr-1 sm:mr-2"},"Ь"),u("span",{class:"hidden sm:inline"},"Reservando Tour"),u("span",{class:"sm:hidden"},"Reserva")],-1)])),footer:y(()=>[u("div",Z,[u("button",{onClick:I,type:"button",class:"bg-red-500 hover:bg-red-700 text-white border-none px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"},[c(f(k),{icon:f(V),class:"h-5 text-white"},null,8,["icon"]),e[5]||(e[5]=U(" Confirmar Reserva "))]),u("button",{onClick:g,type:"button",class:"bg-blue-500 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2"},[c(f(k),{icon:f($),class:"h-5"},null,8,["icon"]),e[6]||(e[6]=U(" Cancelar "))])])]),default:y(()=>[d.tourSeleccionado?(N(),M("div",Y,[c(P,{"tour-seleccionado":d.tourSeleccionado},null,8,["tour-seleccionado"]),c(J,{ref_key:"formularioDatosRef",ref:v,formulario:o.value,"onUpdate:formulario":e[0]||(e[0]=t=>o.value=t),"tiene-cliente-existente":_.value,user:d.user,onMostrarToast:x},null,8,["formulario","tiene-cliente-existente","user"]),c(Q,{"cupos-adultos":o.value.cupos_adultos,"onUpdate:cuposAdultos":e[1]||(e[1]=t=>o.value.cupos_adultos=t),"cupos-menores":o.value.cupos_menores,"onUpdate:cuposMenores":e[2]||(e[2]=t=>o.value.cupos_menores=t),"tour-seleccionado":d.tourSeleccionado,onMostrarToast:x},null,8,["cupos-adultos","cupos-menores","tour-seleccionado"])])):K("",!0)]),_:1},8,["visible"])],64)}}};export{ie as default};
