import{r as f,E as W,o as O,a6 as K,h as V,d as x,x as n,e as s,p as o,$ as t,a2 as H,y as C,t as h,c as k,F as M,A as Q,q as S,N as g}from"./vendor-gbh1WW5n.js";import{z as q,F as d,e as X,f as E,a as I,g as Y}from"./ui-BrU4k96Z.js";import{s as J,A as Z}from"./AuthenticatedLayout-Brf7D3Fu.js";import{c as L,e as ee,P as j,Q as ae,R as se,S as te,T as le,i as oe,a as re,o as ie}from"./index-BWaQysKE.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ne={class:"container mx-auto px-3 sm:px-4 lg:px-6 py-4 sm:py-6"},de={class:"mb-4 sm:mb-6 mt-1 sm:mt-2"},ce={class:"flex items-center"},me={class:"text-sm font-medium"},ue={class:"bg-white rounded-lg shadow-md"},pe={class:"flex flex-col sm:flex-row lg:justify-between lg:items-center mb-3 sm:mb-4 gap-3 sm:gap-4 p-4 sm:p-5 lg:p-6"},fe={class:"flex flex-col sm:flex-row items-center gap-2 w-full justify-center lg:w-auto lg:justify-end"},ve=["disabled"],we={key:0},xe=["disabled"],he={class:"text-center py-8 text-gray-500"},ge={class:"flex items-center"},be=["title"],ye={class:"text-sm leading-relaxed"},ke={class:"text-sm leading-relaxed"},Ee={class:"flex gap-2 justify-center items-center"},_e=["onClick","title"],Ce=["onClick","title"],Le={class:"flex items-center gap-3"},Be={class:"flex flex-col"},Re={class:"flex justify-center gap-4 w-full"},Ae=["disabled"],$e={key:0},Ne={key:1},Se=["disabled"],B=3,Ge={__name:"Backup",setup(je){const r=q(),i=f(!1),m=f(!1),v=f([]),w=f(!1),u=f(null),p=f(!1),_=f(typeof window<"u"?window.innerWidth:1024),T=W(()=>_.value<640?{width:"95vw",maxWidth:"380px"}:_.value<768?{width:"400px"}:{width:"450px"}),b=()=>({"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),Accept:"application/json","Content-Type":"application/json"}),y=async()=>{m.value=!0;try{const l=await g.get("/api/backups",{headers:b()});l.data.success?v.value=l.data.backups:r.add({severity:"error",summary:"Error",detail:l.data.message||"Error al cargar los backups",life:5e3})}catch(l){l.response?r.add({severity:"error",summary:"Error de Conexión",detail:`Error ${l.response.status}: ${l.response.data.message||"Error desconocido"}`,life:5e3}):r.add({severity:"error",summary:"Error de Red",detail:"No se pudo conectar con el servidor",life:5e3})}finally{m.value=!1}},D=async()=>{var l,e;if(i.value){r.add({severity:"warn",summary:"Backup en Proceso",detail:"Ya se está generando un backup. Por favor espere.",life:3e3});return}i.value=!0;try{r.add({severity:"info",summary:"Generando Backup",detail:"El proceso puede tomar unos minutos...",life:5e3});const a=await g.post("/api/backups/generate",{},{headers:b()});if(a.data.success)r.add({severity:"success",summary:"Backup Generado",detail:"El backup se ha generado correctamente.",life:4e3}),await y();else throw new Error(a.data.message||"Error al generar el backup")}catch(a){r.add({severity:"error",summary:"Error al Generar Backup",detail:((e=(l=a.response)==null?void 0:l.data)==null?void 0:e.message)||a.message||"Error desconocido",life:5e3})}finally{i.value=!1}},P=async l=>{try{const e=await g.get(`/api/backups/${l}/download`,{responseType:"blob"}),a=window.URL.createObjectURL(new Blob([e.data])),c=document.createElement("a");c.href=a;const A=e.headers["content-disposition"];let $="backup.zip";if(A){const N=A.match(/filename="(.+)"/);N&&($=N[1])}c.setAttribute("download",$),document.body.appendChild(c),c.click(),c.remove(),window.URL.revokeObjectURL(a),r.add({severity:"success",summary:"Descarga Iniciada",detail:"El archivo se está descargando",life:3e3})}catch{r.add({severity:"error",summary:"Error de Descarga",detail:"No se pudo descargar el respaldo",life:5e3})}},z=l=>{const e=v.value.find(a=>a.id===l);u.value=e||{id:l,name:`Backup ${l}`},w.value=!0},F=async()=>{var l,e;if(u.value){p.value=!0;try{const a=await g.delete(`/api/backups/${u.value.id}`,{headers:b()});if(a.data.success)r.add({severity:"success",summary:"Respaldo Eliminado",detail:`El respaldo "${u.value.name}" ha sido eliminado correctamente.`,life:3e3}),await y(),w.value=!1,u.value=null;else throw new Error(a.data.message||"Error al eliminar el respaldo")}catch(a){r.add({severity:"error",summary:"Error al Eliminar",detail:((e=(l=a.response)==null?void 0:l.data)==null?void 0:e.message)||a.message||"Error desconocido",life:5e3})}finally{p.value=!1}}},G=()=>{w.value=!1,u.value=null},U=async()=>{var l,e;if(v.value.length===0){r.add({severity:"info",summary:"No Hay Nada Que Limpiar",detail:"No hay respaldos disponibles para limpiar.",life:3e3});return}if(v.value.length<=B){r.add({severity:"info",summary:"No Hay Nada Que Limpiar",detail:`Solo hay ${v.value.length} respaldo(s). Se mantienen automáticamente los últimos ${B}.`,life:3e3});return}r.add({severity:"warn",summary:"Iniciando Limpieza",detail:`Se eliminarán los respaldos antiguos, manteniendo solo los últimos ${B}.`,life:4e3});try{const a=await g.post("/api/backups/cleanup",{},{headers:b()});if(a.data.success){const c=a.data.deleted_count||"varios";r.add({severity:"success",summary:"Limpieza Completada",detail:`Se han eliminado ${c} respaldo(s) antiguos.`,life:4e3}),await y()}else throw new Error(a.data.message||"Error al limpiar los respaldos")}catch(a){r.add({severity:"error",summary:"Error al Limpiar",detail:((e=(l=a.response)==null?void 0:l.data)==null?void 0:e.message)||a.message||"Error desconocido",life:5e3})}},R=()=>{_.value=window.innerWidth};return O(()=>{y(),typeof window<"u"&&window.addEventListener("resize",R)}),K(()=>{typeof window<"u"&&window.removeEventListener("resize",R)}),(l,e)=>(x(),V(Z,null,{default:n(()=>[s("div",ne,[s("div",de,[s("div",ce,[o(t(H),{href:t(J)("settings"),class:"inline-flex p-2 items-center bg-blue-500 hover:bg-blue-600 text-white hover:text-gray-200 rounded-md transition-colors duration-200 mb-4",disabled:m.value||i.value},{default:n(()=>[o(t(d),{icon:m.value||i.value?t(L):t(ee),class:C([{"animate-spin":m.value||i.value},"h-4 w-4 mr-2"])},null,8,["icon","class"]),s("span",me,h(m.value||i.value?"Cargando...":"Volver a Configuración"),1)]),_:1},8,["href","disabled"])])]),s("div",ue,[s("div",pe,[e[5]||(e[5]=s("div",{class:"w-full"},[s("h3",{class:"text-xl sm:text-2xl lg:text-3xl text-blue-600 font-bold text-center sm:text-start"},"Gestión de Respaldos"),s("p",{class:"text-gray-600 text-center sm:text-start mt-1 text-sm sm:text-base"},"Administre las copias de seguridad de la base de datos del sistema")],-1)),s("div",fe,[s("button",{onClick:D,disabled:i.value,class:"flex bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 border border-blue-500 px-3 sm:px-4 py-2 text-xs sm:text-sm text-white shadow-md hover:shadow-lg rounded-md hover:-translate-y-1 transition-all duration-300 items-center justify-center w-full sm:w-auto"},[o(t(d),{icon:i.value?t(L):t(j),class:C([{"animate-spin":i.value},"h-3 w-3 sm:h-4 sm:w-4 mr-1 sm:mr-2 text-white"])},null,8,["icon","class"]),i.value?(x(),k("span",we,"Generando...")):(x(),k(M,{key:1},[e[1]||(e[1]=s("span",{class:"hidden sm:inline"},"Generar Respaldo",-1)),e[2]||(e[2]=s("span",{class:"sm:hidden"},"Generar",-1))],64))],8,ve),s("button",{onClick:U,disabled:i.value,class:"flex bg-orange-500 hover:bg-orange-600 disabled:bg-gray-400 border border-orange-500 px-3 sm:px-4 py-2 text-xs sm:text-sm text-white shadow-md hover:shadow-lg rounded-md hover:-translate-y-1 transition-all duration-300 items-center justify-center w-full sm:w-auto"},[o(t(d),{icon:t(ae),class:"h-3 w-3 sm:h-4 sm:w-4 mr-1 sm:mr-2 text-white"},null,8,["icon"]),e[3]||(e[3]=s("span",{class:"hidden sm:inline"},"Limpiar Antiguos",-1)),e[4]||(e[4]=s("span",{class:"sm:hidden"},"Limpiar",-1))],8,xe)])]),o(t(X),{value:v.value,dataKey:"id",paginator:!0,rows:10,rowsPerPageOptions:[5,10,20,50],paginatorTemplate:"RowsPerPageDropdown FirstPageLink PrevPageLink CurrentPageReport NextPageLink LastPageLink",currentPageReportTemplate:"Mostrando {first} a {last} de {totalRecords} respaldos",class:"overflow-x-auto max-w-full",responsiveLayout:"scroll",loading:m.value,pt:{root:{class:"text-sm"},wrapper:{class:"text-sm"},table:{class:"text-sm"},thead:{class:"text-sm"},headerRow:{class:"text-sm"},headerCell:{class:"text-sm font-medium py-3 px-2"},tbody:{class:"text-sm"},bodyRow:{class:"h-20 text-sm hover:bg-blue-50 transition-colors duration-200"},bodyCell:{class:"py-3 px-2 text-sm"},paginator:{class:"text-xs sm:text-sm"},paginatorWrapper:{class:"flex flex-wrap justify-center sm:justify-between items-center gap-2 p-2"}}},{empty:n(()=>[s("div",he,[o(t(d),{icon:t(le),class:"text-4xl mb-2"},null,8,["icon"]),e[6]||(e[6]=s("p",null,"No hay respaldos disponibles",-1))])]),default:n(()=>[o(t(E),{field:"name",header:"Nombre del Archivo",sortable:"",class:"w-40"},{body:n(a=>[s("div",ge,[o(t(d),{icon:t(j),class:"text-blue-600 mr-2 h-4 w-4"},null,8,["icon"]),s("div",{class:"text-sm font-medium leading-relaxed overflow-hidden",style:{"max-width":"200px","text-overflow":"ellipsis","white-space":"nowrap"},title:a.data.name},h(a.data.name),9,be)])]),_:1}),o(t(E),{field:"date",header:"Fecha de Creación",sortable:"",class:"w-32 hidden sm:table-cell"},{body:n(a=>[s("div",ye,h(a.data.date),1)]),_:1}),o(t(E),{field:"size",header:"Tamaño",class:"w-24 hidden md:table-cell"},{body:n(a=>[s("div",ke,h(a.data.size),1)]),_:1}),o(t(E),{exportable:!1,class:"w-32 min-w-28"},{header:n(()=>e[7]||(e[7]=[s("div",{class:"text-center w-full font-bold"}," Acciones ",-1)])),body:n(a=>[s("div",Ee,[s("button",{onClick:c=>P(a.data.id),class:"flex bg-green-500 border p-1 py-2 sm:p-2 text-sm shadow-md hover:shadow-lg rounded-md hover:-translate-y-1 transition-transform duration-300",title:"Descargar "+a.data.name},[o(t(d),{icon:t(se),class:"h-3 w-6 sm:h-4 sm:w-7 text-white"},null,8,["icon"]),e[8]||(e[8]=s("span",{class:"hidden md:block text-white"},"Descargar",-1))],8,_e),s("button",{onClick:c=>z(a.data.id),class:"flex bg-red-500 border p-1 py-2 sm:p-2 text-sm shadow-md hover:shadow-lg rounded-md hover:-translate-y-1 transition-transform duration-300",title:"Eliminar "+a.data.name},[o(t(d),{icon:t(te),class:"h-3 w-6 sm:h-4 sm:w-7 text-white"},null,8,["icon"]),e[9]||(e[9]=s("span",{class:"hidden md:block text-white"},"Eliminar",-1))],8,Ce)])]),_:1})]),_:1},8,["value","loading"])])]),o(t(I),{class:"z-[9999]"}),o(t(Y),{visible:w.value,"onUpdate:visible":e[0]||(e[0]=a=>w.value=a),header:"Eliminar Respaldo",modal:!0,style:Q(T.value),closable:!1,draggable:!1},{footer:n(()=>[s("div",Re,[s("button",{type:"button",class:"bg-red-500 hover:bg-red-700 text-white border-none px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",onClick:F,disabled:p.value},[o(t(d),{icon:p.value?t(L):t(re),class:C(["h-5",{"animate-spin":p.value}])},null,8,["icon","class"]),p.value?(x(),k("span",Ne,"Eliminando...")):(x(),k("span",$e,"Eliminar"))],8,Ae),s("button",{type:"button",class:"bg-blue-500 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2",onClick:G,disabled:p.value},[o(t(d),{icon:t(ie),class:"h-5"},null,8,["icon"]),e[13]||(e[13]=s("span",null,"Cancelar",-1))],8,Se)])]),default:n(()=>{var a;return[s("div",Le,[o(t(d),{icon:t(oe),class:"h-8 w-8 text-red-500"},null,8,["icon"]),s("div",Be,[s("span",null,[e[10]||(e[10]=S("¿Estás seguro de eliminar el respaldo: ")),s("b",null,h((a=u.value)==null?void 0:a.name),1),e[11]||(e[11]=S("?"))]),e[12]||(e[12]=s("span",{class:"text-red-600 text-sm font-medium mt-1"},"Esta acción es irreversible.",-1))])])]}),_:1},8,["visible","style"])]),_:1}))}};export{Ge as default};
