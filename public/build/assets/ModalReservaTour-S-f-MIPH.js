import{F as v,z as G}from"./ui-BrU4k96Z.js";import{M as N,v as O,i as I,aP as H,R as K,a as J,o as Q,A as Y}from"./index-BURLB9l4.js";import Z from"./ResumenTour-DpXp4vZU.js";import ee from"./FormularioDatosPersonales-fqUIkwNJ.js";import ae from"./SelectorCupos-BN7j_9mb.js";import{r as D,c as y,j,d as p,e,p as d,q as b,$ as r,t as h,y as S,h as z,I as te,N as oe,E as se,w as re,k as V,x as X,F as ne}from"./vendor-gbh1WW5n.js";import{_ as le}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./vue-tel-input-nvsKEitw.js";const ie={class:"modal-header"},ce={class:"modal-title"},ue={key:0,class:"error-state"},de={class:"flex justify-center gap-4 w-full mt-4"},me={key:1,class:"payment-form"},ve={class:"purchase-summary"},pe={class:"summary-details"},fe={class:"tour-info"},be={class:"tour-item"},ye={class:"tour-details"},_e={class:"tour-name"},ge={class:"tour-participants"},xe={key:0},he={class:"tour-price"},we={class:"total-amount"},De={class:"amount"},ke={class:"flex items-start"},Ce={key:0},Te={key:1},Re={class:"payment-section"},Se={class:"flex justify-center gap-4 w-full"},Me=["disabled"],je=["disabled"],$e={class:"payment-info"},Ee={class:"info-item"},Fe={class:"info-item"},W=1e3,Pe={__name:"ModalFinalizarReservaTour",props:{isVisible:{type:Boolean,default:!1},reservaData:{type:Object,required:!0,default:()=>({id:null,tour_nombre:"",cupos_adultos:0,cupos_menores:0,total:0,cliente_email:""})}},emits:["close","payment-completed"],setup(s,{emit:A}){const n=s,f=A,m=D(!1),_=D(null),t=x=>parseFloat(x||0).toFixed(2),T=()=>n.reservaData.total>W?(_.value=`El monto máximo por reserva es de $${W.toFixed(2)} USD. Total actual: $${n.reservaData.total.toFixed(2)} USD. Por favor, contacta con nosotros para procesar este pago.`,!1):!0,M=async()=>{try{return(await oe.post("/reservas/tour",{tour_id:n.reservaData.tour_id,cliente_data:n.reservaData.cliente_data,cupos_adultos:n.reservaData.cupos_adultos,cupos_menores:n.reservaData.cupos_menores,precio_total:n.reservaData.total})).data.data.reserva.id}catch(x){throw x}},k=async()=>{var x,a,E,F,P,U,l,o;if(T()){m.value=!0,_.value=null;try{let i=n.reservaData.id;i||(i=await M());const c=()=>{var R;return((R=document.querySelector('meta[name="csrf-token"]'))==null?void 0:R.getAttribute("content"))||null},u=async()=>await fetch("/api/wompi/payment-link-tour",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":c(),"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({customer_email:n.reservaData.cliente_email,amount:n.reservaData.total,description:`Reserva de tour: ${n.reservaData.tour_nombre} - ${n.reservaData.cupos_adultos+n.reservaData.cupos_menores} cupos`,reference:`TOUR-${n.reservaData.id}-${Date.now()}`,customer_name:n.reservaData.cliente_nombre||"Cliente",reserva_id:i,tour_data:{id:n.reservaData.tour_id,nombre:n.reservaData.tour_nombre,cupos_adultos:n.reservaData.cupos_adultos,cupos_menores:n.reservaData.cupos_menores,total:n.reservaData.total}})});let w=await u();if(w.status===419)try{const R=await fetch("/api/csrf-token",{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(R.ok){const B=await R.json();if(B.csrf_token){const L=document.querySelector('meta[name="csrf-token"]');L&&L.setAttribute("content",B.csrf_token),w=await u()}}}catch{}const C=await w.json();if(w.ok&&C.success)if(C.payment_link)window.open(C.payment_link,"_blank"),f("payment-completed",{success:!0,reserva:{...n.reservaData,id:i},payment_link:C.payment_link,reference:C.reference}),g();else throw new Error("No se recibió el enlace de pago");else throw new Error(C.message||C.error||"Error al crear el enlace de pago")}catch(i){let c="Error al procesar la reserva y el pago";if(((x=i.response)==null?void 0:x.status)===422){const u=((E=(a=i.response)==null?void 0:a.data)==null?void 0:E.errors)||{},w=Object.values(u).flat();w.length>0?c="Error de validación: "+w.join(", "):c=((P=(F=i.response)==null?void 0:F.data)==null?void 0:P.message)||"Datos de reserva inválidos"}else((U=i.response)==null?void 0:U.status)===419?(c="Su sesión ha expirado. Por favor, recargue la página.",setTimeout(()=>{window.location.reload()},2e3)):i.message?c=i.message:(o=(l=i.response)==null?void 0:l.data)!=null&&o.message&&(c=i.response.data.message);_.value=c}finally{m.value=!1}}},g=()=>{f("close"),$()},$=()=>{m.value=!1,_.value=null},q=()=>{$(),k()};return(x,a)=>s.isVisible?(p(),y("div",{key:0,class:"modal-overlay",onClick:g},[e("div",{class:"modal-container",onClick:a[0]||(a[0]=te(()=>{},["stop"]))},[e("div",ie,[e("h3",ce,[d(r(v),{icon:r(N),class:"title-icon"},null,8,["icon"]),a[1]||(a[1]=b(" Finalizar Reserva "))]),e("button",{onClick:g,class:"close-button"},[d(r(v),{icon:r(O)},null,8,["icon"])])]),_.value?(p(),y("div",ue,[d(r(v),{icon:r(I),class:"error-icon"},null,8,["icon"]),a[4]||(a[4]=e("h4",null,"Error al procesar",-1)),e("p",null,h(_.value),1),e("div",de,[e("button",{onClick:g,class:"bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2"},[d(r(v),{icon:r(O),class:"h-5"},null,8,["icon"]),a[2]||(a[2]=b(" Cancelar "))]),e("button",{onClick:q,class:"bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2"},[d(r(v),{icon:r(I),class:"h-5"},null,8,["icon"]),a[3]||(a[3]=b(" Intentar de nuevo "))])])])):(p(),y("div",me,[e("div",ve,[a[9]||(a[9]=e("h4",null,"Resumen de Reserva",-1)),e("div",pe,[e("div",fe,[e("div",be,[e("div",ye,[e("span",_e,h(s.reservaData.tour_nombre),1),e("div",ge,[s.reservaData.cupos_adultos>0?(p(),y("span",xe,h(s.reservaData.cupos_adultos)+"x Mayores de edad ",1)):j("",!0),s.reservaData.cupos_menores>0?(p(),y("span",{key:1,class:S({"ml-2":s.reservaData.cupos_adultos>0})},h(s.reservaData.cupos_menores)+"x Menores de edad ",3)):j("",!0)])]),e("span",he,"$"+h(t(s.reservaData.total)),1)])]),e("div",we,[a[5]||(a[5]=e("span",null,"Total a pagar:",-1)),e("span",De,"$"+h(t(s.reservaData.total)),1)]),s.reservaData.total>800?(p(),y("div",{key:0,class:S(["mt-3 p-3 rounded-lg",s.reservaData.total>1e3?"bg-red-50 border border-red-200":"bg-yellow-50 border border-yellow-200"])},[e("div",ke,[d(r(v),{icon:r(I),class:S([s.reservaData.total>1e3?"text-red-500":"text-yellow-500","h-5 w-5 mt-0.5 mr-3 flex-shrink-0"])},null,8,["icon","class"]),e("div",null,[e("p",{class:S([s.reservaData.total>1e3?"text-red-800 font-semibold":"text-yellow-800 font-medium","text-sm"])},h(s.reservaData.total>1e3?"⚠️ Límite superado":"⚠️ Cerca del límite"),3),e("p",{class:S([s.reservaData.total>1e3?"text-red-700":"text-yellow-700","text-xs mt-1"])},[s.reservaData.total>1e3?(p(),y("span",Ce,a[6]||(a[6]=[b(" El monto máximo por transacción es $1,000 USD. "),e("strong",null,"Contacta con nosotros",-1),b(" para procesar este pago. ")]))):(p(),y("span",Te,[a[7]||(a[7]=b(" Estás cerca del límite máximo de $1,000 USD por transacción. Tu total actual es de ")),e("strong",null,"$"+h(t(s.reservaData.total))+" USD",1),a[8]||(a[8]=b(". "))]))],2)])])],2)):j("",!0)])]),e("div",Re,[e("div",Se,[e("button",{onClick:g,class:"bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2",disabled:m.value},[d(r(v),{icon:r(O),class:"h-5"},null,8,["icon"]),a[10]||(a[10]=b(" Cancelar "))],8,Me),e("button",{onClick:k,disabled:m.value||s.reservaData.total>1e3,class:S(["bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",s.reservaData.total>1e3?"bg-red-400 hover:bg-red-400 cursor-not-allowed":""])},[m.value?(p(),z(r(v),{key:1,icon:r(N),class:"h-5 animate-spin"},null,8,["icon"])):(p(),z(r(v),{key:0,icon:r(N),class:"h-5"},null,8,["icon"])),b(" "+h(m.value?"Procesando Reserva...":s.reservaData.total>1e3?"Monto excede límite":"Reservar y Pagar"),1)],10,je)])]),e("div",$e,[e("div",Ee,[d(r(v),{icon:r(H),class:"info-icon"},null,8,["icon"]),a[11]||(a[11]=e("span",null,"Pago seguro con encriptación SSL",-1))]),e("div",Fe,[d(r(v),{icon:r(K),class:"info-icon"},null,8,["icon"]),a[12]||(a[12]=e("span",null,"Procesamiento inmediato",-1))])])]))])])):j("",!0)}},Ue=le(Pe,[["__scopeId","data-v-a47bf140"]]),Ae={class:"text-sm sm:text-base lg:text-lg font-bold text-red-700 flex items-center text-center justify-center w-full"},qe={class:"mr-1 sm:mr-2"},Ne={key:0,class:"space-y-3 sm:space-y-4 lg:space-y-6 text-xs sm:text-sm text-gray-700"},Oe={class:"flex justify-center gap-4 w-full mt-6"},Ie=["disabled"],Xe={key:1,class:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"},Je={__name:"ModalReservaTour",props:{visible:{type:Boolean,default:!1},tourSeleccionado:{type:Object,default:null},user:{type:Object,default:null}},emits:["update:visible","confirmar-reserva","actualizar-cupos","refrescar-tour"],setup(s,{emit:A}){const n=G(),f=s,m=A,_=D(null),t=D({correo:"",nombres:"",tipo_documento:"DUI",numero_identificacion:"",fecha_nacimiento:"",genero:"",direccion:"",telefono:"",cupos_adultos:1,cupos_menores:0}),T=D(!1),M=D(!1),k=D(!1),g=D(null),$=async()=>{var l,o;if(!f.user)return null;try{const i=await fetch("/api/verificar-datos-cliente",{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((l=document.querySelector('meta[name="csrf-token"]'))==null?void 0:l.getAttribute("content"))||"","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(i.ok){if(!(await i.json()).tiene_datos_completos)return null;const u=await fetch("/api/cliente-datos",{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((o=document.querySelector('meta[name="csrf-token"]'))==null?void 0:o.getAttribute("content"))||"","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(u.ok)return(await u.json()).cliente||null}return null}catch(i){return console.error("[ModalReservaTour] Error de conexión al cargar datos del cliente:",i),null}},q=async()=>{const l=f.user;let o="",i="";if(l&&(i=l.email||"",o=l.name||""),t.value={correo:i,nombres:o,tipo_documento:"DUI",numero_identificacion:"",fecha_nacimiento:"",genero:"",direccion:"",telefono:"",cupos_adultos:1,cupos_menores:0},M.value=!1,l){const c=await $();if(c){M.value=!0;let u="";if(c.fecha_nacimiento)try{u=new Date(c.fecha_nacimiento)}catch{}t.value={...t.value,tipo_documento:c.tipo_documento||"DUI",numero_identificacion:c.numero_identificacion||"",fecha_nacimiento:u,genero:c.genero||"",direccion:c.direccion||"",telefono:c.telefono||""}}}},x=()=>{m("update:visible",!1)},a=l=>{n.add(l)},E=()=>{k.value=!1,g.value=null},F=l=>{var o;k.value=!1,n.add({severity:"success",summary:"¡Reserva confirmada!",detail:"Tu reserva ha sido registrada. Se ha abierto Wompi para procesar el pago.",life:6e3}),((o=l.reserva)==null?void 0:o.cupos_disponibles_actualizados)!==void 0&&m("actualizar-cupos",{tourId:f.tourSeleccionado.id,cuposDisponibles:l.reserva.cupos_disponibles_actualizados}),m("refrescar-tour",f.tourSeleccionado.id),m("confirmar-reserva",{data:{reserva:l.reserva,pago:l}}),g.value=null},P=async()=>{var l,o;if(!T.value&&!((l=_.value)!=null&&l.validateForm&&!_.value.validateForm())){if(t.value.cupos_adultos<=0&&t.value.cupos_menores<=0){n.add({severity:"error",summary:"Error en la reserva",detail:"Debe seleccionar al menos un cupo.",life:4e3});return}g.value={id:null,tour_id:f.tourSeleccionado.id,tour_nombre:f.tourSeleccionado.nombre,cupos_adultos:t.value.cupos_adultos,cupos_menores:t.value.cupos_menores,total:U.value.total,cliente_email:t.value.correo,cliente_nombre:t.value.nombres,cliente_data:{correo:t.value.correo,nombres:t.value.nombres,tipo_documento:t.value.tipo_documento,numero_identificacion:t.value.numero_identificacion,fecha_nacimiento:t.value.fecha_nacimiento,genero:((o=t.value.genero)==null?void 0:o.toUpperCase())||"",direccion:t.value.direccion,telefono:t.value.telefono}},m("update:visible",!1),k.value=!0}},U=se(()=>{if(!f.tourSeleccionado)return{total:0};const l=f.tourSeleccionado.precio||f.tourSeleccionado.precio_adulto||0,o=t.value.cupos_adultos+t.value.cupos_menores;return{total:l*o}});return re(()=>f.visible,async l=>{l&&await q()}),(l,o)=>{const i=V("Toast"),c=V("Dialog");return p(),y(ne,null,[d(i),d(c,{visible:s.visible,"onUpdate:visible":o[3]||(o[3]=u=>m("update:visible",u)),modal:"",closable:!1,class:"w-[95vw] sm:w-[90vw] md:w-[85vw] lg:w-[80vw] xl:max-w-4xl mx-2 sm:mx-4",draggable:!1},{header:X(()=>[e("h3",Ae,[e("span",qe,[d(r(v),{icon:r(Y),class:"h-5 text-blue-500"},null,8,["icon"])]),o[4]||(o[4]=e("span",{class:"text-blue-500"},"Reservando Tour",-1))])]),footer:X(()=>[e("div",Oe,[e("button",{onClick:P,type:"button",disabled:T.value,class:"bg-red-500 hover:bg-red-700 text-white border-none px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"},[T.value?(p(),y("div",Xe)):(p(),z(r(v),{key:0,icon:r(J),class:"h-5 text-white"},null,8,["icon"])),b(" "+h(T.value?"Procesando...":"Continuar"),1)],8,Ie),e("button",{onClick:x,type:"button",class:"bg-blue-500 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2"},[d(r(v),{icon:r(Q),class:"h-5"},null,8,["icon"]),o[5]||(o[5]=b(" Cancelar "))])])]),default:X(()=>[s.tourSeleccionado?(p(),y("div",Ne,[d(Z,{"tour-seleccionado":s.tourSeleccionado},null,8,["tour-seleccionado"]),d(ee,{ref_key:"formularioDatosRef",ref:_,formulario:t.value,"onUpdate:formulario":o[0]||(o[0]=u=>t.value=u),"tiene-cliente-existente":M.value,user:s.user,onMostrarToast:a},null,8,["formulario","tiene-cliente-existente","user"]),d(ae,{"cupos-adultos":t.value.cupos_adultos,"onUpdate:cuposAdultos":o[1]||(o[1]=u=>t.value.cupos_adultos=u),"cupos-menores":t.value.cupos_menores,"onUpdate:cuposMenores":o[2]||(o[2]=u=>t.value.cupos_menores=u),"tour-seleccionado":s.tourSeleccionado,onMostrarToast:a},null,8,["cupos-adultos","cupos-menores","tour-seleccionado"])])):j("",!0)]),_:1},8,["visible"]),d(Ue,{"is-visible":k.value,"reserva-data":g.value||{},onClose:E,onPaymentCompleted:F},null,8,["is-visible","reserva-data"])],64)}}};export{Je as default};
