import{z as V,F as x}from"./ui-BrU4k96Z.js";import{l as $,m as L,y as G}from"./index-D80U6yN5.js";import{r as _,E as H,w as K,k as U,c as h,d as b,p as c,x as w,j as P,e as m,h as W,q,$ as p,t as J,F as Q,N as Y}from"./vendor-gbh1WW5n.js";import Z from"./ResumenTour-CgcZaSW_.js";import ee from"./FormularioDatosPersonales-fqUIkwNJ.js";import oe from"./SelectorCupos-l8EdViWl.js";import"./vue-tel-input-nvsKEitw.js";const te={class:"text-sm sm:text-base lg:text-lg font-bold text-red-700 flex items-center text-center justify-center w-full"},ae={class:"mr-1 sm:mr-2"},re={key:0,class:"space-y-3 sm:space-y-4 lg:space-y-6 text-xs sm:text-sm text-gray-700"},se={class:"flex justify-center gap-4 w-full mt-6"},ne=["disabled"],ie={key:1,class:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"},ve={__name:"ModalReservaTour",props:{visible:{type:Boolean,default:!1},tourSeleccionado:{type:Object,default:null},user:{type:Object,default:null}},emits:["update:visible","confirmar-reserva","actualizar-cupos","refrescar-tour"],setup(u,{emit:z}){const l=V(),i=u,f=z,y=_(null),e=_({correo:"",nombres:"",tipo_documento:"DUI",numero_identificacion:"",fecha_nacimiento:"",genero:"",direccion:"",telefono:"",cupos_adultos:1,cupos_menores:0}),d=_(!1),g=_(!1),A=async()=>{var t,o;if(!i.user)return null;try{const s=await fetch("/api/verificar-datos-cliente",{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||"","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(s.ok){if(!(await s.json()).tiene_datos_completos)return null;const a=await fetch("/api/cliente-datos",{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((o=document.querySelector('meta[name="csrf-token"]'))==null?void 0:o.getAttribute("content"))||"","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(a.ok)return(await a.json()).cliente||null}return null}catch(s){return console.error("[ModalReservaTour] Error de conexión al cargar datos del cliente:",s),null}},I=async()=>{const t=i.user;let o="",s="";if(t&&(s=t.email||"",o=t.name||""),e.value={correo:s,nombres:o,tipo_documento:"DUI",numero_identificacion:"",fecha_nacimiento:"",genero:"",direccion:"",telefono:"",cupos_adultos:1,cupos_menores:0},g.value=!1,t){const r=await A();if(r){g.value=!0;let a="";if(r.fecha_nacimiento)try{a=new Date(r.fecha_nacimiento)}catch{}e.value={...e.value,tipo_documento:r.tipo_documento||"DUI",numero_identificacion:r.numero_identificacion||"",fecha_nacimiento:a,genero:r.genero||"",direccion:r.direccion||"",telefono:r.telefono||""}}}},C=()=>{f("update:visible",!1)},S=t=>{l.add(t)},X=async()=>{var t,o,s,r,a,v,T,k,D,R,j,E,F,M;if(!d.value&&!((t=y.value)!=null&&t.validateForm&&!y.value.validateForm())){if(e.value.cupos_adultos<=0&&e.value.cupos_menores<=0){l.add({severity:"error",summary:"Error en la reserva",detail:"Debe seleccionar al menos un cupo.",life:4e3});return}d.value=!0;try{const n=await Y.post("/reservas/tour",{tour_id:i.tourSeleccionado.id,cliente_data:{correo:e.value.correo,nombres:e.value.nombres,tipo_documento:e.value.tipo_documento,numero_identificacion:e.value.numero_identificacion,fecha_nacimiento:e.value.fecha_nacimiento,genero:((o=e.value.genero)==null?void 0:o.toUpperCase())||"",direccion:e.value.direccion,telefono:e.value.telefono},cupos_adultos:e.value.cupos_adultos,cupos_menores:e.value.cupos_menores,precio_total:B.value.total});((r=(s=n.data)==null?void 0:s.data)==null?void 0:r.cupos_disponibles_actualizados)!==void 0&&f("actualizar-cupos",{tourId:i.tourSeleccionado.id,cuposDisponibles:n.data.data.cupos_disponibles_actualizados}),f("refrescar-tour",i.tourSeleccionado.id),f("confirmar-reserva",n.data),C()}catch(n){if(console.error("Error al confirmar reserva:",n),((a=n.response)==null?void 0:a.status)===419)l.add({severity:"error",summary:"Sesión expirada",detail:"Su sesión ha expirado. Por favor, recargue la página.",life:5e3}),window.location.reload();else if(((v=n.response)==null?void 0:v.status)===422){const O=((k=(T=n.response)==null?void 0:T.data)==null?void 0:k.errors)||{},N=Object.values(O).flat();N.length>0?l.add({severity:"error",summary:"Errores de validación",detail:N.join(", "),life:5e3}):l.add({severity:"error",summary:"Error de validación",detail:((R=(D=n.response)==null?void 0:D.data)==null?void 0:R.message)||"Datos inválidos",life:4e3})}else((j=n.response)==null?void 0:j.status)===403?l.add({severity:"error",summary:"Acceso denegado",detail:"No tiene permisos para realizar esta acción. Debe tener rol de cliente.",life:4e3}):((E=n.response)==null?void 0:E.status)===401?l.add({severity:"error",summary:"Sesión requerida",detail:"Debe iniciar sesión para realizar una reserva.",life:4e3}):l.add({severity:"error",summary:"Error al procesar la reserva",detail:((M=(F=n.response)==null?void 0:F.data)==null?void 0:M.message)||"Inténtelo de nuevo.",life:4e3})}finally{d.value=!1}}},B=H(()=>{if(!i.tourSeleccionado)return{total:0};const t=i.tourSeleccionado.precio||i.tourSeleccionado.precio_adulto||0,o=e.value.cupos_adultos+e.value.cupos_menores;return{total:t*o}});return K(()=>i.visible,async t=>{t&&await I()}),(t,o)=>{const s=U("Toast"),r=U("Dialog");return b(),h(Q,null,[c(s),c(r,{visible:u.visible,"onUpdate:visible":o[3]||(o[3]=a=>f("update:visible",a)),modal:"",closable:!1,class:"w-[95vw] sm:w-[90vw] md:w-[85vw] lg:w-[80vw] xl:max-w-4xl mx-2 sm:mx-4",draggable:!1},{header:w(()=>[m("h3",te,[m("span",ae,[c(p(x),{icon:p(G),class:"h-5 text-blue-500"},null,8,["icon"])]),o[4]||(o[4]=m("span",{class:"text-blue-500"},"Reservando Tour",-1))])]),footer:w(()=>[m("div",se,[m("button",{onClick:X,type:"button",disabled:d.value,class:"bg-red-500 hover:bg-red-700 text-white border-none px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"},[d.value?(b(),h("div",ie)):(b(),W(p(x),{key:0,icon:p($),class:"h-5 text-white"},null,8,["icon"])),q(" "+J(d.value?"Procesando...":"Confirmar"),1)],8,ne),m("button",{onClick:C,type:"button",class:"bg-blue-500 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2"},[c(p(x),{icon:p(L),class:"h-5"},null,8,["icon"]),o[5]||(o[5]=q(" Cancelar "))])])]),default:w(()=>[u.tourSeleccionado?(b(),h("div",re,[c(Z,{"tour-seleccionado":u.tourSeleccionado},null,8,["tour-seleccionado"]),c(ee,{ref_key:"formularioDatosRef",ref:y,formulario:e.value,"onUpdate:formulario":o[0]||(o[0]=a=>e.value=a),"tiene-cliente-existente":g.value,user:u.user,onMostrarToast:S},null,8,["formulario","tiene-cliente-existente","user"]),c(oe,{"cupos-adultos":e.value.cupos_adultos,"onUpdate:cuposAdultos":o[1]||(o[1]=a=>e.value.cupos_adultos=a),"cupos-menores":e.value.cupos_menores,"onUpdate:cuposMenores":o[2]||(o[2]=a=>e.value.cupos_menores=a),"tour-seleccionado":u.tourSeleccionado,onMostrarToast:S},null,8,["cupos-adultos","cupos-menores","tour-seleccionado"])])):P("",!0)]),_:1},8,["visible"])],64)}}};export{ve as default};
