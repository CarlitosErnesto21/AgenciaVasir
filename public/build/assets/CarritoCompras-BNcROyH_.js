import{r as k,N as B,a4 as Y,E as N,w as oe,c as g,j as A,d as f,e,p as i,q as T,$ as t,t as y,F as L,l as Z,h as z,I as ee,x as O,B as W,y as se}from"./vendor-CqKcGHPa.js";import{u as H}from"./carrito-ByVehbIa.js";import{A as p,z as re}from"./ui-CVJOYm3g.js";import{I as ne}from"./ImageWithFallback-DQs8e-88.js";import{am as X,t as I,h as J,at as le,aa as ie,p as ce,ab as te,g as ue,au as de,w as me,b as pe,a8 as Q}from"./index-mhZfaEHg.js";import{_ as ae}from"./_plugin-vue_export-helper-DlAUqK2U.js";import fe from"./ModalDatosCliente-jgJdEj_N.js";import"./app-jfYL9bZS.js";import"./vue-tel-input-J95PmLrS.js";function ve(){const j=k(!1),d=k(null),S=H(),P=B.create(),F=()=>{var r;return((r=document.head.querySelector('meta[name="csrf-token"]'))==null?void 0:r.content)||null};return P.interceptors.request.use(c=>{const r=F();return r&&(c.headers["X-CSRF-TOKEN"]=r),c.headers["X-Requested-With"]="XMLHttpRequest",c.headers.Accept="application/json",c}),{loading:j,error:d,createVentaFromCarrito:async(c,r=null)=>{var n,u,E,m,_;j.value=!0,d.value=null;try{const x={productos:S.items.map(v=>({id:v.id,cantidad:v.cantidad,precio:v.precio,nombre:v.nombre,imagen:v.primera_imagen||v.imagen||null,subtotal:v.precio*v.cantidad})),customer_email:c,cliente_data:r};let $;try{$=await P.post("/carrito/create-venta",x)}catch(v){if(((n=v.response)==null?void 0:n.status)===419){console.log("ðŸ”„ Token CSRF expirado, renovando...");try{const C=await B.get("/tienda",{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"text/html,application/xhtml+xml"}});if(C.data&&typeof C.data=="string"){const s=C.data.match(/name="csrf-token" content="([^"]+)"/);if(s){const l=s[1],a=document.head.querySelector('meta[name="csrf-token"]');a&&(a.setAttribute("content",l),console.log("âœ… Token CSRF renovado:",l))}}$=await P.post("/carrito/create-venta",x)}catch(C){throw C}}else throw v}if($.data.success)return{success:!0,venta:$.data.venta,message:$.data.message};throw new Error($.data.message||"Error desconocido")}catch(h){console.error("Error creando venta desde carrito:",h);let x="Error al crear la venta";return(E=(u=h.response)==null?void 0:u.data)!=null&&E.message?x=h.response.data.message:(_=(m=h.response)==null?void 0:m.data)!=null&&_.errors?x=Object.values(h.response.data.errors).flat().join(", "):h.message&&(x=h.message),d.value=x,{success:!1,error:x}}finally{j.value=!1}},procesarPagoVenta:async c=>{var r,n,u,E;j.value=!0,d.value=null;try{const m=await P.post("/pagos/venta",c);if(m.data.success)return{success:!0,pago:m.data.pago,wompi_data:m.data.wompi_data,message:m.data.message};throw new Error(m.data.message||"Error en el pago")}catch(m){console.error("Error procesando pago:",m);let _="Error al procesar el pago";return(n=(r=m.response)==null?void 0:r.data)!=null&&n.message?_=m.response.data.message:(E=(u=m.response)==null?void 0:u.data)!=null&&E.errors?_=Object.values(m.response.data.errors).flat().join(", "):m.message&&(_=m.message),d.value=_,{success:!1,error:_}}finally{j.value=!1}},consultarEstadoPago:async c=>{var r,n;try{const u=await P.get(`/pagos/${c}/estado`);if(u.data.success)return{success:!0,pago:u.data.pago};throw new Error(u.data.message||"Error consultando estado")}catch(u){return console.error("Error consultando estado del pago:",u),{success:!1,error:((n=(r=u.response)==null?void 0:r.data)==null?void 0:n.message)||u.message||"Error consultando estado"}}}}}const ge={class:"modal-header"},ye={class:"modal-title"},be={key:0,class:"loading-state"},he={key:1,class:"error-state"},xe={class:"flex justify-center gap-4 w-full mt-4"},Ce={key:2,class:"payment-form"},_e={class:"purchase-summary"},ke={class:"summary-details"},we={class:"cart-items"},Ee={class:"item-name"},$e={class:"item-quantity"},Te={class:"item-price"},Se={class:"total-amount"},Pe={class:"amount"},je={class:"payment-section"},Fe={class:"flex justify-center gap-4 w-full"},Re=["disabled"],De=["disabled"],Ae={class:"payment-info"},Ve={class:"info-item"},qe={class:"info-item"},Me={key:3,class:"success-state"},Ne={class:"success-details"},Ie={key:0},Xe={class:"cart-cleared-notice"},Oe={class:"success-actions"},We={class:"flex justify-center gap-4 w-full mt-4"},Be={__name:"CarritoCheckoutModal",props:{isVisible:{type:Boolean,default:!1},clienteData:{type:Object,default:null}},emits:["close","payment-completed"],setup(j,{emit:d}){const S=j,P=d,{createVentaFromCarrito:F}=ve(),b=H(),V=Y(),w=k(!1),c=k(null),r=k(!1),n=k(null),u=k(!1),E=N(()=>{var a;return(a=V.props.auth)==null?void 0:a.user}),m=N(()=>{var a;return((a=E.value)==null?void 0:a.email)||""}),_=N(()=>{var a;return(a=E.value)!=null&&a.name?E.value.name:"Cliente"}),h=N(()=>S.clienteData?{id:S.clienteData.id,numero_identificacion:S.clienteData.numero_identificacion,telefono:S.clienteData.telefono,direccion:S.clienteData.direccion,tipo_documento_id:S.clienteData.tipo_documento_id}:null),x=a=>a?new Intl.NumberFormat("es-CO",{minimumFractionDigits:2,maximumFractionDigits:2}).format(a):"0.00";oe(()=>S.isVisible,a=>{a&&s()});const $=async()=>{if(b.isEmpty){n.value="El carrito estÃ¡ vacÃ­o";return}if(!m.value){n.value="No se encontrÃ³ informaciÃ³n del usuario";return}if(!h.value){n.value="No se encontraron datos del cliente";return}w.value=!0,n.value=null;try{const a=await F(m.value,h.value);a.success?c.value=a.venta:n.value=a.error||"Error creando la venta"}catch(a){n.value="Error inesperado al crear la venta",console.error("Error creando venta:",a)}finally{w.value=!1}},v=async()=>{if(u.value=!0,n.value=null,!c.value){w.value=!0;try{if(await $(),n.value||!c.value){u.value=!1;return}}finally{w.value=!1}}try{const a=()=>{var q;return((q=document.querySelector('meta[name="csrf-token"]'))==null?void 0:q.getAttribute("content"))||null},o=async()=>{var q;return await fetch("/wompi/payment-link",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":a(),"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({customer_email:m.value,amount:b.totalPrice,description:`Compra de ${b.items.length} producto(s) - ${_.value}`,reference:`CART-${Date.now()}`,customer_name:_.value,venta_id:((q=c.value)==null?void 0:q.id)||null,productos:b.items.map(D=>({id:D.id,nombre:D.nombre,precio:D.precio,cantidad:D.cantidad,imagen:D.primera_imagen||D.imagen||null,subtotal:D.precio*D.cantidad}))})})};let R=await o();if(R.status===419){console.log("ðŸ”„ Token CSRF expirado, renovando...");const U=(await(await fetch("/tienda",{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"text/html,application/xhtml+xml"}})).text()).match(/name="csrf-token" content="([^"]+)"/);if(U){const G=U[1],K=document.querySelector('meta[name="csrf-token"]');K&&(K.setAttribute("content",G),console.log("âœ… Token CSRF renovado:",G))}R=await o()}const M=await R.json();M.success?(window.open(M.payment_link,"_blank"),b.limpiarCarrito(),r.value=!0,setTimeout(()=>{C()},3e3),P("payment-completed",{success:!0,venta:c.value,payment_link:M.payment_link,reference:M.reference,cart_cleared:!0})):n.value=M.message||"Error creando enlace de pago"}catch(a){console.error("Error procesando pago:",a),n.value="Error procesando el pago. IntÃ©ntalo de nuevo."}finally{u.value=!1}},C=()=>{P("close"),s()},s=()=>{c.value=null,r.value=!1,n.value=null,w.value=!1},l=()=>{s(),$()};return(a,o)=>j.isVisible?(f(),g("div",{key:0,class:"modal-overlay",onClick:C},[e("div",{class:"modal-container",onClick:o[0]||(o[0]=ee(()=>{},["stop"]))},[e("div",ge,[e("h3",ye,[i(t(p),{icon:t(X),class:"title-icon"},null,8,["icon"]),o[1]||(o[1]=T(" Finalizar Compra "))]),e("button",{onClick:C,class:"close-button"},[i(t(p),{icon:t(I)},null,8,["icon"])])]),w.value?(f(),g("div",be,o[2]||(o[2]=[e("div",{class:"spinner"},null,-1),e("p",null,"Procesando tu pedido...",-1)]))):n.value?(f(),g("div",he,[i(t(p),{icon:t(J),class:"error-icon"},null,8,["icon"]),o[5]||(o[5]=e("h4",null,"Error al procesar",-1)),e("p",null,y(n.value),1),e("div",xe,[e("button",{onClick:C,class:"bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2"},[i(t(p),{icon:t(I),class:"h-5"},null,8,["icon"]),o[3]||(o[3]=T(" Cancelar "))]),e("button",{onClick:l,class:"bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2"},[i(t(p),{icon:t(J),class:"h-5"},null,8,["icon"]),o[4]||(o[4]=T(" Intentar de nuevo "))])])])):(f(),g("div",Ce,[e("div",_e,[o[7]||(o[7]=e("h4",null,"Resumen de tu compra",-1)),e("div",ke,[e("div",we,[(f(!0),g(L,null,Z(t(b).items,R=>(f(),g("div",{key:R.id,class:"cart-item"},[e("span",Ee,y(R.nombre),1),e("span",$e,y(R.cantidad)+"x",1),e("span",Te,"$"+y(x(R.precio*R.cantidad)),1)]))),128))]),e("div",Se,[o[6]||(o[6]=e("span",null,"Total a pagar:",-1)),e("span",Pe,"$"+y(x(t(b).totalPrice)),1)])])]),e("div",je,[e("div",Fe,[e("button",{onClick:C,class:"bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2",disabled:u.value},[i(t(p),{icon:t(I),class:"h-5"},null,8,["icon"]),o[8]||(o[8]=T(" Cancelar "))],8,Re),e("button",{onClick:v,disabled:u.value,class:"bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"},[u.value?(f(),z(t(p),{key:1,icon:t(X),class:"h-5 animate-spin"},null,8,["icon"])):(f(),z(t(p),{key:0,icon:t(X),class:"h-5"},null,8,["icon"])),T(" "+y(u.value?"Generando enlace...":"Pagar con Wompi"),1)],8,De)])]),e("div",Ae,[e("div",Ve,[i(t(p),{icon:t(le),class:"info-icon"},null,8,["icon"]),o[9]||(o[9]=e("span",null,"Pago seguro con encriptaciÃ³n SSL",-1))]),e("div",qe,[i(t(p),{icon:t(ie),class:"info-icon"},null,8,["icon"]),o[10]||(o[10]=e("span",null,"Procesamiento inmediato",-1))])])])),r.value?(f(),g("div",Me,[i(t(p),{icon:t(ce),class:"success-icon"},null,8,["icon"]),o[16]||(o[16]=e("h4",null,"Â¡Enlace de pago creado!",-1)),o[17]||(o[17]=e("p",null,"Se abriÃ³ una nueva ventana con tu enlace de pago seguro.",-1)),e("div",Ne,[c.value?(f(),g("p",Ie,[o[11]||(o[11]=e("strong",null,"NÃºmero de orden:",-1)),T(" #"+y(c.value.id),1)])):A("",!0),e("p",null,[o[12]||(o[12]=e("strong",null,"Total pagado:",-1)),T(" $"+y(x(t(b).totalPrice)),1)]),e("p",Xe,[i(t(p),{icon:t(te),class:"cart-icon"},null,8,["icon"]),o[13]||(o[13]=T(" Tu carrito se ha limpiado automÃ¡ticamente "))])]),e("div",Oe,[o[15]||(o[15]=e("p",{class:"auto-close-notice"},"Esta ventana se cerrarÃ¡ automÃ¡ticamente en unos segundos",-1)),e("div",We,[e("button",{onClick:C,class:"bg-blue-500 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2"},[i(t(p),{icon:t(I),class:"h-5"},null,8,["icon"]),o[14]||(o[14]=T(" Cerrar ahora "))])])])])):A("",!0)])])):A("",!0)}},Le=ae(Be,[["__scopeId","data-v-3c0a0bd3"]]),ze={key:0,class:"absolute right-0 top-0 h-full w-full max-w-md transform carrito-panel"},He={class:"flex h-full flex-col bg-white shadow-xl"},Ue={class:"flex items-center justify-between border-b border-gray-200 px-6 py-4"},Ge={class:"text-lg font-semibold text-gray-900 flex items-center gap-2"},Ke={class:"px-6 py-2 bg-blue-50 border-b border-blue-100"},Je={class:"text-sm text-blue-800"},Qe={class:"flex-1 overflow-y-auto px-6 py-4 carrito-scroll"},Ye={key:0,class:"flex flex-col items-center justify-center h-full text-center empty-state"},Ze={key:1,class:"space-y-4"},et={class:"flex-shrink-0 w-16 h-16 producto-imagen"},tt={class:"flex-1 min-w-0"},at={class:"text-sm font-medium text-gray-900 truncate"},ot={class:"text-sm text-blue-600 font-semibold"},st={class:"text-xs text-gray-500 whitespace-nowrap"},rt={class:"flex items-center gap-2"},nt=["onClick","disabled"],lt={class:"w-8 text-center text-sm font-medium"},it=["onClick","disabled"],ct=["onClick"],ut={key:0,class:"px-6 py-3 border-t border-gray-100"},dt={key:1,class:"border-t border-gray-200 px-6 py-4 space-y-4"},mt={class:"flex items-center justify-between"},pt={class:"text-xl font-bold text-blue-600 total-badge"},ft={class:"space-y-2"},vt=["disabled"],gt={__name:"CarritoCompras",setup(j){const d=H(),S=Y(),P=re(),F=k(!1),b=k(!1),V=k(!1),w=k(null),c=k(!1),r=k(!1),n=N(()=>{var s;return!!((s=S.props.auth)!=null&&s.user)}),u=s=>{const l=d.incrementarCantidad(s);l.success||P.add({severity:"warn",summary:"Stock insuficiente",detail:l.message,life:3e3})},E=s=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(s),m=async()=>{if(!n.value)return{tieneCliente:!1,cliente:null};try{c.value=!0;const s=await B.get("/api/verificar-datos-cliente");return s.data.success&&s.data.tiene_datos_completos?(w.value=s.data.cliente,{tieneCliente:!0,cliente:s.data.cliente}):{tieneCliente:!1,cliente:null}}catch(s){return console.error("Error al verificar cliente:",s),{tieneCliente:!1,cliente:null}}finally{c.value=!1}},_=async()=>{if(d.isEmpty){alert("Tu carrito estÃ¡ vacÃ­o");return}if(!n.value){alert("Debes iniciar sesiÃ³n para proceder con la compra");return}try{r.value=!0,v(),setTimeout(async()=>{try{const{tieneCliente:s,cliente:l}=await m();s?(w.value=l,F.value=!0):b.value=!0}catch(s){console.error("Error en proceso de checkout:",s),alert("OcurriÃ³ un error al procesar tu solicitud. Por favor intenta nuevamente.")}finally{r.value=!1}},350)}catch(s){console.error("Error inicial en checkout:",s),r.value=!1,alert("OcurriÃ³ un error al procesar tu solicitud. Por favor intenta nuevamente.")}},h=()=>{F.value=!1},x=s=>{w.value=s,b.value=!1,setTimeout(()=>{F.value=!0},300)},$=s=>{F.value=!1},v=()=>{V.value=!0,setTimeout(()=>{d.ocultarCarrito(),V.value=!1},300)},C=s=>s.imagen?s.imagen.startsWith("http")||s.imagen.startsWith("data:")?s.imagen:`/storage/productos/${s.imagen}`:null;return(s,l)=>(f(),g(L,null,[i(W,{name:"carrito-fade",appear:""},{default:O(()=>[t(d).isVisible?(f(),g("div",{key:0,class:"fixed inset-0 z-[10000] overflow-hidden carrito-overlay",onClick:ee(v,["self"])},[i(W,{name:"backdrop-fade",appear:""},{default:O(()=>[V.value?A("",!0):(f(),g("div",{key:0,class:"absolute inset-0 bg-black bg-opacity-50 transition-opacity cursor-pointer fondo-clickeable",onClick:v}))]),_:1}),i(W,{name:"carrito-slide",appear:""},{default:O(()=>[V.value?A("",!0):(f(),g("div",ze,[e("div",He,[e("div",Ue,[e("h2",Ge,[i(t(p),{icon:t(te),class:"text-blue-600"},null,8,["icon"]),l[2]||(l[2]=T(" Carrito de Compras "))]),e("button",{onClick:v,class:"text-gray-400 hover:text-gray-600 transition-colors"},[i(t(p),{icon:t(ue),class:"w-6 h-6"},null,8,["icon"])])]),e("div",Ke,[e("p",Je,y(t(d).itemCount)+" "+y(t(d).itemCount===1?"producto":"productos")+" en tu carrito ",1)]),e("div",Qe,[t(d).isEmpty?(f(),g("div",Ye,[i(t(p),{icon:t(de),class:"w-16 h-16 text-gray-300 mb-4"},null,8,["icon"]),l[3]||(l[3]=e("h3",{class:"text-lg font-medium text-gray-900 mb-2"},"Tu carrito estÃ¡ vacÃ­o",-1)),l[4]||(l[4]=e("p",{class:"text-gray-500 mb-6"},"Agrega algunos productos para comenzar",-1)),e("button",{onClick:v,class:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-colors"}," Continuar Comprando ")])):(f(),g("div",Ze,[(f(!0),g(L,null,Z(t(d).items,a=>(f(),g("div",{key:a.id,class:"flex items-center gap-4 p-4 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors producto-item"},[e("div",et,[i(ne,{src:C(a),alt:a.nombre,"fallback-text":a.nombre,"container-class":"w-full h-full","image-class":"w-full h-full object-cover rounded-md border border-gray-200"},null,8,["src","alt","fallback-text"])]),e("div",tt,[e("h4",at,y(a.nombre),1),e("p",ot,y(E(a.precio)),1),e("p",st," Stock: "+y(a.stock_actual),1)]),e("div",rt,[e("button",{onClick:o=>t(d).decrementarCantidad(a.id),class:"w-8 h-8 flex items-center justify-center border border-gray-300 rounded-md hover:bg-gray-50 transition-colors cantidad-btn",disabled:a.cantidad<=1},[i(t(p),{icon:t(me),class:"w-3 h-3"},null,8,["icon"])],8,nt),e("span",lt,y(a.cantidad),1),e("button",{onClick:o=>u(a.id),class:"w-8 h-8 flex items-center justify-center border border-gray-300 rounded-md hover:bg-gray-50 transition-colors cantidad-btn",disabled:a.cantidad>=a.stock_actual},[i(t(p),{icon:t(pe),class:"w-3 h-3"},null,8,["icon"])],8,it)]),e("button",{onClick:o=>t(d).eliminarProducto(a.id),class:"p-2 text-red-400 hover:text-red-600 transition-colors btn-eliminar",title:"Eliminar producto"},[i(t(p),{icon:t(Q),class:"w-4 h-4"},null,8,["icon"])],8,ct)]))),128))]))]),t(d).isEmpty?A("",!0):(f(),g("div",ut,[e("button",{onClick:l[0]||(l[0]=a=>t(d).limpiarCarrito()),class:"w-full text-red-500 hover:text-red-700 hover:bg-red-50 py-2 px-4 text-sm transition-colors flex items-center justify-center gap-2 rounded-md border border-red-200 hover:border-red-300"},[i(t(p),{icon:t(Q),class:"w-4 h-4"},null,8,["icon"]),l[5]||(l[5]=T(" Vaciar Carrito "))])])),t(d).isEmpty?A("",!0):(f(),g("div",dt,[e("div",mt,[l[6]||(l[6]=e("span",{class:"text-lg font-semibold text-gray-900"},"Total:",-1)),e("span",pt,y(E(t(d).totalPrice)),1)]),e("div",ft,[e("button",{onClick:_,disabled:r.value,class:se(["w-full text-white py-3 px-4 rounded-md transition-colors flex items-center justify-center gap-2 font-medium btn-checkout",{loading:r.value}])},[r.value?A("",!0):(f(),z(t(p),{key:0,icon:t(X)},null,8,["icon"])),T(" "+y(r.value?"Procesando...":"Proceder al Checkout"),1)],10,vt),e("button",{onClick:v,class:"w-full text-white py-2 px-4 rounded-md transition-colors btn-continuar"}," Continuar Comprando ")])]))])]))]),_:1})])):A("",!0)]),_:1}),i(fe,{visible:b.value,"onUpdate:visible":l[1]||(l[1]=a=>b.value=a),onClienteGuardado:x},null,8,["visible"]),i(Le,{"is-visible":F.value,"cliente-data":w.value,onClose:h,onPaymentCompleted:$},null,8,["is-visible","cliente-data"])],64))}},$t=ae(gt,[["__scopeId","data-v-794ab36c"]]);export{$t as default};
