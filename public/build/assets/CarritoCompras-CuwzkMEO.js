import{r as w,N as z,a3 as ee,E as I,w as ne,c as p,j as M,d as l,e,p as d,q as x,$ as t,t as h,F as H,l as te,y as O,h as G,I as ae,x as W,B}from"./vendor-gbh1WW5n.js";import{u as K}from"./carrito-CgUgBSMJ.js";import{F as y,z as le}from"./ui-BrU4k96Z.js";import{I as ie}from"./ImageWithFallback-D9gRbSkH.js";import{M as U,v as X,i as L,aP as ce,R as de,h as ue,aj as oe,o as me,aQ as pe,B as fe,k as ve,Q as Y}from"./index-BL4yA-eF.js";import{_ as se}from"./_plugin-vue_export-helper-DlAUqK2U.js";import ge from"./ModalDatosCliente-BH90beXd.js";import"./app-Cy1dPPr6.js";import"./vue-tel-input-nvsKEitw.js";function ye(){const D=w(!1),f=w(null),T=K(),S=z.create(),j=()=>{var i;return((i=document.head.querySelector('meta[name="csrf-token"]'))==null?void 0:i.content)||null};return S.interceptors.request.use(u=>{const i=j();return i&&(u.headers["X-CSRF-TOKEN"]=i),u.headers["X-Requested-With"]="XMLHttpRequest",u.headers.Accept="application/json",u}),{loading:D,error:f,createVentaFromCarrito:async(u,i=null)=>{var n,m,E,v,k;D.value=!0,f.value=null;try{const _={productos:T.items.map(b=>({id:b.id,cantidad:b.cantidad,precio:b.precio,nombre:b.nombre,imagen:b.primera_imagen||b.imagen||null,subtotal:b.precio*b.cantidad})),customer_email:u,cliente_data:i};let P;try{P=await S.post("/carrito/create-venta",_)}catch(b){if(((n=b.response)==null?void 0:n.status)===419)try{const F=await z.get("/tienda",{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"text/html,application/xhtml+xml"}});if(F.data&&typeof F.data=="string"){const o=F.data.match(/name="csrf-token" content="([^"]+)"/);if(o){const c=o[1],g=document.head.querySelector('meta[name="csrf-token"]');g&&g.setAttribute("content",c)}}P=await S.post("/carrito/create-venta",_)}catch(F){throw F}else throw b}if(P.data.success)return{success:!0,venta:P.data.venta,message:P.data.message};throw new Error(P.data.message||"Error desconocido")}catch(C){console.error("Error creando venta desde carrito:",C);let _="Error al crear la venta";return(E=(m=C.response)==null?void 0:m.data)!=null&&E.message?_=C.response.data.message:(k=(v=C.response)==null?void 0:v.data)!=null&&k.errors?_=Object.values(C.response.data.errors).flat().join(", "):C.message&&(_=C.message),f.value=_,{success:!1,error:_}}finally{D.value=!1}},procesarPagoVenta:async u=>{var i,n,m,E;D.value=!0,f.value=null;try{const v=await S.post("/pagos/venta",u);if(v.data.success)return{success:!0,pago:v.data.pago,wompi_data:v.data.wompi_data,message:v.data.message};throw new Error(v.data.message||"Error en el pago")}catch(v){console.error("Error procesando pago:",v);let k="Error al procesar el pago";return(n=(i=v.response)==null?void 0:i.data)!=null&&n.message?k=v.response.data.message:(E=(m=v.response)==null?void 0:m.data)!=null&&E.errors?k=Object.values(v.response.data.errors).flat().join(", "):v.message&&(k=v.message),f.value=k,{success:!1,error:k}}finally{D.value=!1}},consultarEstadoPago:async u=>{var i,n;try{const m=await S.get(`/pagos/${u}/estado`);if(m.data.success)return{success:!0,pago:m.data.pago};throw new Error(m.data.message||"Error consultando estado")}catch(m){return console.error("Error consultando estado del pago:",m),{success:!1,error:((n=(i=m.response)==null?void 0:i.data)==null?void 0:n.message)||m.message||"Error consultando estado"}}}}}const be={class:"modal-header"},he={class:"modal-title"},xe={key:0,class:"loading-state"},_e={key:1,class:"error-state"},Ce={class:"flex justify-center gap-4 w-full mt-4"},ke={key:2,class:"payment-form"},we={class:"purchase-summary"},$e={class:"summary-details"},Ee={class:"cart-items"},Pe={class:"item-name"},Te={class:"item-quantity"},Se={class:"item-price"},Me={class:"total-amount"},De={class:"amount"},je={class:"flex items-start"},Fe={class:"text-sm"},Ae={key:0,class:"text-red-800 font-medium"},Re={key:1,class:"text-yellow-800 font-medium"},Ve={key:0},qe={key:1},Ne={class:"payment-section"},Ie={class:"flex justify-center gap-4 w-full"},Oe=["disabled"],Xe=["disabled"],Ue={class:"payment-info"},We={class:"info-item"},Be={class:"info-item"},Le={key:3,class:"success-state"},ze={class:"success-details"},He={key:0},Ge={class:"cart-cleared-notice"},Ke={class:"success-actions"},Qe={class:"flex justify-center gap-4 w-full mt-4"},Z=1e3,Je={__name:"CarritoCheckoutModal",props:{isVisible:{type:Boolean,default:!1},clienteData:{type:Object,default:null}},emits:["close","payment-completed"],setup(D,{emit:f}){const T=D,S=f,{createVentaFromCarrito:j}=ye(),r=K(),V=ee(),$=w(!1),u=w(null),i=w(!1),n=w(null),m=w(!1),E=I(()=>{var s;return(s=V.props.auth)==null?void 0:s.user}),v=I(()=>{var s;return((s=E.value)==null?void 0:s.email)||""}),k=I(()=>{var s;return(s=E.value)!=null&&s.name?E.value.name:"Cliente"}),C=I(()=>T.clienteData?{id:T.clienteData.id,numero_identificacion:T.clienteData.numero_identificacion,telefono:T.clienteData.telefono,direccion:T.clienteData.direccion,tipo_documento_id:T.clienteData.tipo_documento_id}:null),_=s=>s?new Intl.NumberFormat("es-CO",{minimumFractionDigits:2,maximumFractionDigits:2}).format(s):"0.00";ne(()=>T.isVisible,s=>{s&&c()});const P=async()=>{if(r.isEmpty){n.value="El carrito está vacío";return}if(!v.value){n.value="No se encontró información del usuario";return}if(!C.value){n.value="No se encontraron datos del cliente";return}$.value=!0,n.value=null;try{const s=await j(v.value,C.value);s.success?u.value=s.venta:n.value=s.error||"Error creando la venta"}catch(s){n.value="Error inesperado al crear la venta",console.error("Error creando venta:",s)}finally{$.value=!1}},b=()=>r.totalPrice>Z?(n.value=`El monto máximo por compra es de $${Z.toFixed(2)} USD. Total actual: $${r.totalPrice.toFixed(2)} USD. Por favor, reduce la cantidad de productos o contacta con nosotros para pagos mayores.`,!1):!0,F=async()=>{if(b()){if(m.value=!0,n.value=null,!u.value){$.value=!0;try{if(await P(),n.value||!u.value){m.value=!1;return}}finally{$.value=!1}}try{const s=()=>{var q;return((q=document.querySelector('meta[name="csrf-token"]'))==null?void 0:q.getAttribute("content"))||null},a=async()=>{var q;return await fetch("/wompi/payment-link",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":s(),"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({customer_email:v.value,amount:r.totalPrice,description:`Compra de ${r.items.length} producto(s) - ${k.value}`,reference:`CART-${Date.now()}`,customer_name:k.value,venta_id:((q=u.value)==null?void 0:q.id)||null,productos:r.items.map(R=>({id:R.id,nombre:R.nombre,precio:R.precio,cantidad:R.cantidad,imagen:R.primera_imagen||R.imagen||null,subtotal:R.precio*R.cantidad}))})})};let A=await a();if(A.status===419){const Q=(await(await fetch("/tienda",{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"text/html,application/xhtml+xml"}})).text()).match(/name="csrf-token" content="([^"]+)"/);if(Q){const re=Q[1],J=document.querySelector('meta[name="csrf-token"]');J&&J.setAttribute("content",re)}A=await a()}const N=await A.json();N.success?(window.open(N.payment_link,"_blank"),r.limpiarCarrito(),i.value=!0,setTimeout(()=>{o()},3e3),S("payment-completed",{success:!0,venta:u.value,payment_link:N.payment_link,reference:N.reference,cart_cleared:!0})):n.value=N.message||"Error creando enlace de pago"}catch(s){console.error("Error procesando pago:",s),n.value="Error procesando el pago. Inténtalo de nuevo."}finally{m.value=!1}}},o=()=>{S("close"),c()},c=()=>{u.value=null,i.value=!1,n.value=null,$.value=!1},g=()=>{c(),P()};return(s,a)=>D.isVisible?(l(),p("div",{key:0,class:"modal-overlay",onClick:o},[e("div",{class:"modal-container",onClick:a[0]||(a[0]=ae(()=>{},["stop"]))},[e("div",be,[e("h3",he,[d(t(y),{icon:t(U),class:"title-icon"},null,8,["icon"]),a[1]||(a[1]=x(" Finalizar Compra "))]),e("button",{onClick:o,class:"close-button"},[d(t(y),{icon:t(X)},null,8,["icon"])])]),$.value?(l(),p("div",xe,a[2]||(a[2]=[e("div",{class:"spinner"},null,-1),e("p",null,"Procesando tu pedido...",-1)]))):n.value?(l(),p("div",_e,[d(t(y),{icon:t(L),class:"error-icon"},null,8,["icon"]),a[5]||(a[5]=e("h4",null,"Error al procesar",-1)),e("p",null,h(n.value),1),e("div",Ce,[e("button",{onClick:o,class:"bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2"},[d(t(y),{icon:t(X),class:"h-5"},null,8,["icon"]),a[3]||(a[3]=x(" Cancelar "))]),e("button",{onClick:g,class:"bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2"},[d(t(y),{icon:t(L),class:"h-5"},null,8,["icon"]),a[4]||(a[4]=x(" Intentar de nuevo "))])])])):(l(),p("div",ke,[e("div",we,[a[14]||(a[14]=e("h4",null,"Resumen de tu compra",-1)),e("div",$e,[e("div",Ee,[(l(!0),p(H,null,te(t(r).items,A=>(l(),p("div",{key:A.id,class:"cart-item"},[e("span",Pe,h(A.nombre),1),e("span",Te,h(A.cantidad)+"x",1),e("span",Se,"$"+h(_(A.precio*A.cantidad)),1)]))),128))]),e("div",Me,[a[6]||(a[6]=e("span",null,"Total a pagar:",-1)),e("span",De,"$"+h(_(t(r).totalPrice)),1)]),t(r).totalPrice>800?(l(),p("div",{key:0,class:O(["mt-3 p-3 rounded-lg",t(r).totalPrice>1e3?"bg-red-50 border border-red-200":"bg-yellow-50 border border-yellow-200"])},[e("div",je,[d(t(y),{icon:t(L),class:O([t(r).totalPrice>1e3?"text-red-500":"text-yellow-500","h-4 w-4 mr-2 mt-0.5"])},null,8,["icon","class"]),e("div",Fe,[t(r).totalPrice>1e3?(l(),p("p",Ae,a[7]||(a[7]=[e("strong",null,"Monto excede el límite",-1)]))):(l(),p("p",Re,a[8]||(a[8]=[e("strong",null,"Cerca del límite máximo",-1)]))),e("p",{class:O([t(r).totalPrice>1e3?"text-red-700":"text-yellow-700","mt-1"])},[a[11]||(a[11]=x(" El límite máximo por transacción es de ")),a[12]||(a[12]=e("strong",null,"$1,000.00 USD",-1)),a[13]||(a[13]=x(". ")),t(r).totalPrice>1e3?(l(),p("span",Ve," Por favor, reduce la cantidad de productos o contacta con nosotros para pagos mayores. ")):(l(),p("span",qe,[a[9]||(a[9]=x(" Tu total actual es de ")),e("strong",null,"$"+h(_(t(r).totalPrice))+" USD",1),a[10]||(a[10]=x(". "))]))],2)])])],2)):M("",!0)])]),e("div",Ne,[e("div",Ie,[e("button",{onClick:o,class:"bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2",disabled:m.value},[d(t(y),{icon:t(X),class:"h-5"},null,8,["icon"]),a[15]||(a[15]=x(" Cancelar "))],8,Oe),e("button",{onClick:F,disabled:m.value||t(r).totalPrice>1e3,class:O(["bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",t(r).totalPrice>1e3?"bg-red-400 hover:bg-red-400 cursor-not-allowed":""])},[m.value?(l(),G(t(y),{key:1,icon:t(U),class:"h-5 animate-spin"},null,8,["icon"])):(l(),G(t(y),{key:0,icon:t(U),class:"h-5"},null,8,["icon"])),x(" "+h(m.value?"Procesando Compra...":t(r).totalPrice>1e3?"Monto excede límite":"Confirmar y Pagar"),1)],10,Xe)])]),e("div",Ue,[e("div",We,[d(t(y),{icon:t(ce),class:"info-icon"},null,8,["icon"]),a[16]||(a[16]=e("span",null,"Pago seguro con encriptación SSL",-1))]),e("div",Be,[d(t(y),{icon:t(de),class:"info-icon"},null,8,["icon"]),a[17]||(a[17]=e("span",null,"Procesamiento inmediato",-1))])])])),i.value?(l(),p("div",Le,[d(t(y),{icon:t(ue),class:"success-icon"},null,8,["icon"]),a[23]||(a[23]=e("h4",null,"¡Enlace de pago creado!",-1)),a[24]||(a[24]=e("p",null,"Se abrió una nueva ventana con tu enlace de pago seguro.",-1)),e("div",ze,[u.value?(l(),p("p",He,[a[18]||(a[18]=e("strong",null,"Número de orden:",-1)),x(" #"+h(u.value.id),1)])):M("",!0),e("p",null,[a[19]||(a[19]=e("strong",null,"Total pagado:",-1)),x(" $"+h(_(t(r).totalPrice)),1)]),e("p",Ge,[d(t(y),{icon:t(oe),class:"cart-icon"},null,8,["icon"]),a[20]||(a[20]=x(" Tu carrito se ha limpiado automáticamente "))])]),e("div",Ke,[a[22]||(a[22]=e("p",{class:"auto-close-notice"},"Esta ventana se cerrará automáticamente en unos segundos",-1)),e("div",Qe,[e("button",{onClick:o,class:"bg-blue-500 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2"},[d(t(y),{icon:t(X),class:"h-5"},null,8,["icon"]),a[21]||(a[21]=x(" Cerrar ahora "))])])])])):M("",!0)])])):M("",!0)}},Ye=se(Je,[["__scopeId","data-v-c32df82d"]]),Ze={key:0,class:"absolute right-0 top-0 h-full w-full max-w-md transform carrito-panel"},et={class:"flex h-full flex-col bg-white shadow-xl"},tt={class:"flex items-center justify-between border-b border-gray-200 px-6 py-4"},at={class:"text-lg font-semibold text-gray-900 flex items-center gap-2"},ot={class:"px-6 py-2 bg-blue-50 border-b border-blue-100"},st={class:"text-sm text-blue-800"},rt={class:"flex-1 overflow-y-auto px-6 py-4 carrito-scroll"},nt={key:0,class:"flex flex-col items-center justify-center h-full text-center empty-state"},lt={key:1,class:"space-y-2"},it={class:"flex-shrink-0 w-16 h-16 producto-imagen"},ct={class:"flex-1 min-w-0"},dt={class:"text-sm font-medium text-gray-900 truncate"},ut={class:"text-sm text-blue-600 font-semibold"},mt={class:"text-xs text-gray-500 whitespace-nowrap"},pt={class:"flex items-center gap-2"},ft=["onClick","disabled"],vt={class:"w-8 text-center text-sm font-medium"},gt=["onClick","disabled"],yt=["onClick"],bt={key:0,class:"px-6 py-3 border-t border-gray-100"},ht={key:1,class:"border-t border-gray-200 px-6 py-4 space-y-4"},xt={class:"flex items-center justify-between"},_t={class:"text-xl font-bold text-blue-600 total-badge"},Ct={class:"space-y-2"},kt=["disabled"],wt={__name:"CarritoCompras",setup(D){const f=K(),T=ee(),S=le(),j=w(!1),r=w(!1),V=w(!1),$=w(null),u=w(!1),i=w(!1),n=I(()=>{var o;return!!((o=T.props.auth)!=null&&o.user)}),m=o=>{const c=f.incrementarCantidad(o);c.success||S.add({severity:"warn",summary:"Stock insuficiente",detail:c.message,life:3e3})},E=o=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(o),v=async()=>{if(!n.value)return{tieneCliente:!1,cliente:null};try{u.value=!0;const o=await z.get("/api/verificar-datos-cliente");return o.data.success&&o.data.tiene_datos_completos?($.value=o.data.cliente,{tieneCliente:!0,cliente:o.data.cliente}):{tieneCliente:!1,cliente:null}}catch(o){return console.error("Error al verificar cliente:",o),{tieneCliente:!1,cliente:null}}finally{u.value=!1}},k=async()=>{if(f.isEmpty){alert("Tu carrito está vacío");return}if(!n.value){alert("Debes iniciar sesión para proceder con la compra");return}try{i.value=!0,b(),setTimeout(async()=>{try{const{tieneCliente:o,cliente:c}=await v();o?($.value=c,j.value=!0):r.value=!0}catch(o){console.error("Error en proceso de checkout:",o),alert("Ocurrió un error al procesar tu solicitud. Por favor intenta nuevamente.")}finally{i.value=!1}},350)}catch(o){console.error("Error inicial en checkout:",o),i.value=!1,alert("Ocurrió un error al procesar tu solicitud. Por favor intenta nuevamente.")}},C=()=>{j.value=!1},_=o=>{$.value=o,r.value=!1,setTimeout(()=>{j.value=!0},300)},P=o=>{j.value=!1},b=()=>{V.value=!0,setTimeout(()=>{f.ocultarCarrito(),V.value=!1},300)},F=o=>o.imagen?o.imagen.startsWith("http")||o.imagen.startsWith("data:")?o.imagen:`/storage/productos/${o.imagen}`:null;return(o,c)=>(l(),p(H,null,[d(B,{name:"carrito-fade",appear:""},{default:W(()=>[t(f).isVisible?(l(),p("div",{key:0,class:"fixed inset-0 z-[10000] overflow-hidden carrito-overlay",onClick:ae(b,["self"])},[d(B,{name:"backdrop-fade",appear:""},{default:W(()=>[V.value?M("",!0):(l(),p("div",{key:0,class:"absolute inset-0 bg-black bg-opacity-50 transition-opacity cursor-pointer fondo-clickeable",onClick:b}))]),_:1}),d(B,{name:"carrito-slide",appear:""},{default:W(()=>[V.value?M("",!0):(l(),p("div",Ze,[e("div",et,[e("div",tt,[e("h2",at,[d(t(y),{icon:t(oe),class:"text-blue-600"},null,8,["icon"]),c[2]||(c[2]=x(" Carrito de Compras "))]),e("button",{onClick:b,class:"text-gray-400 hover:text-gray-600 transition-colors"},[d(t(y),{icon:t(me),class:"w-6 h-6"},null,8,["icon"])])]),e("div",ot,[e("p",st,h(t(f).itemCount)+" "+h(t(f).itemCount===1?"producto":"productos")+" en tu carrito ",1)]),e("div",rt,[t(f).isEmpty?(l(),p("div",nt,[d(t(y),{icon:t(pe),class:"w-16 h-16 text-gray-300 mb-4"},null,8,["icon"]),c[3]||(c[3]=e("h3",{class:"text-lg font-medium text-gray-900 mb-2"},"Tu carrito está vacío",-1)),c[4]||(c[4]=e("p",{class:"text-gray-500 mb-6"},"Agrega algunos productos para comenzar",-1)),e("button",{onClick:b,class:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-colors"}," Continuar Comprando ")])):(l(),p("div",lt,[(l(!0),p(H,null,te(t(f).items,g=>(l(),p("div",{key:g.id,class:"flex items-center gap-4 p-4 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors producto-item"},[e("div",it,[d(ie,{src:F(g),alt:g.nombre,"fallback-text":g.nombre,"container-class":"w-full h-full","image-class":"w-full h-full object-cover rounded-md border border-gray-200"},null,8,["src","alt","fallback-text"])]),e("div",ct,[e("h4",dt,h(g.nombre),1),e("p",ut,h(E(g.precio)),1),e("p",mt," Stock: "+h(g.stock_actual),1)]),e("div",pt,[e("button",{onClick:s=>t(f).decrementarCantidad(g.id),class:"w-8 h-8 flex items-center justify-center border border-gray-300 rounded-md hover:bg-gray-50 transition-colors cantidad-btn",disabled:g.cantidad<=1},[d(t(y),{icon:t(fe),class:"w-3 h-3"},null,8,["icon"])],8,ft),e("span",vt,h(g.cantidad),1),e("button",{onClick:s=>m(g.id),class:"w-8 h-8 flex items-center justify-center border border-gray-300 rounded-md hover:bg-gray-50 transition-colors cantidad-btn",disabled:g.cantidad>=g.stock_actual},[d(t(y),{icon:t(ve),class:"w-3 h-3"},null,8,["icon"])],8,gt)]),e("button",{onClick:s=>t(f).eliminarProducto(g.id),class:"p-2 text-red-400 hover:text-red-600 transition-colors btn-eliminar",title:"Eliminar producto"},[d(t(y),{icon:t(Y),class:"w-4 h-4"},null,8,["icon"])],8,yt)]))),128))]))]),t(f).isEmpty?M("",!0):(l(),p("div",bt,[e("button",{onClick:c[0]||(c[0]=g=>t(f).limpiarCarrito()),class:"w-full bg-red-500 text-white hover:bg-red-600 py-2 px-4 text-sm transition-colors flex items-center justify-center gap-2 rounded-md border border-red-200 hover:border-red-300"},[d(t(y),{icon:t(Y),class:"w-4 h-4"},null,8,["icon"]),c[5]||(c[5]=x(" Vaciar Carrito "))])])),t(f).isEmpty?M("",!0):(l(),p("div",ht,[e("div",xt,[c[6]||(c[6]=e("span",{class:"text-lg font-semibold text-gray-900"},"Total:",-1)),e("span",_t,h(E(t(f).totalPrice)),1)]),e("div",Ct,[e("button",{onClick:k,disabled:i.value,class:O(["w-full text-white py-3 px-4 rounded-md transition-colors flex items-center justify-center gap-2 font-medium btn-checkout",{loading:i.value}])},[i.value?M("",!0):(l(),G(t(y),{key:0,icon:t(U)},null,8,["icon"])),x(" "+h(i.value?"Procesando...":"Completar Pago"),1)],10,kt),e("button",{onClick:b,class:"w-full text-white py-2 px-4 rounded-md transition-colors btn-continuar"}," Continuar Comprando ")])]))])]))]),_:1})])):M("",!0)]),_:1}),d(ge,{visible:r.value,"onUpdate:visible":c[1]||(c[1]=g=>r.value=g),onClienteGuardado:_},null,8,["visible"]),d(Ye,{"is-visible":j.value,"cliente-data":$.value,onClose:C,onPaymentCompleted:P},null,8,["is-visible","cliente-data"])],64))}},At=se(wt,[["__scopeId","data-v-b8b78cbc"]]);export{At as default};
