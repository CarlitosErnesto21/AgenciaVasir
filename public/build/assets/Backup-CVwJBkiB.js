import{r as f,E as W,o as O,a6 as K,h as V,d as x,x as n,e as s,p as l,$ as t,a2 as H,y as C,t as w,c as k,A as M,q as S,N as y}from"./vendor-gbh1WW5n.js";import{z as Q,F as d,e as q,f as _,a as X,g as I}from"./ui-BrU4k96Z.js";import{s as Y,A as J}from"./AuthenticatedLayout-BL1L8Chz.js";import{e as L,g as Z,O as j,P as ee,Q as ae,R as se,S as te,c as oe,l as le,m as re}from"./index-CaK7jatL.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ie={class:"container mx-auto px-3 sm:px-4 lg:px-6 py-4 sm:py-6"},ne={class:"mb-4 sm:mb-6 mt-1 sm:mt-2"},de={class:"flex items-center"},ce={class:"text-sm font-medium"},me={class:"bg-white rounded-lg shadow-md"},ue={class:"flex flex-col sm:flex-row lg:justify-between lg:items-center mb-3 sm:mb-4 gap-3 sm:gap-4 p-4 sm:p-5 lg:p-6"},pe={class:"flex flex-col sm:flex-row items-center gap-2 w-full justify-center lg:w-auto lg:justify-end"},fe=["disabled"],ve={key:0},he={key:2,class:"sm:hidden"},xe=["disabled"],we={class:"text-center py-8 text-gray-500"},ye={class:"flex items-center"},be=["title"],ge={class:"text-sm leading-relaxed"},ke={class:"text-sm leading-relaxed"},_e={class:"flex gap-2 justify-center items-center"},Ee=["onClick","title"],Ce=["onClick","title"],Le={class:"flex items-center gap-3"},Be={class:"flex flex-col"},Ae={class:"flex justify-center gap-4 w-full"},Re=["disabled"],$e={key:0},Ne={key:1},Se=["disabled"],B=3,Ge={__name:"Backup",setup(je){const r=Q(),i=f(!1),m=f(!1),v=f([]),h=f(!1),u=f(null),p=f(!1),E=f(typeof window<"u"?window.innerWidth:1024),D=W(()=>E.value<640?{width:"95vw",maxWidth:"380px"}:E.value<768?{width:"400px"}:{width:"450px"}),b=()=>({"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),Accept:"application/json","Content-Type":"application/json"}),g=async()=>{m.value=!0;try{const o=await y.get("/api/backups",{headers:b()});o.data.success?v.value=o.data.backups:r.add({severity:"error",summary:"Error",detail:o.data.message||"Error al cargar los backups",life:5e3})}catch(o){o.response?r.add({severity:"error",summary:"Error de Conexión",detail:`Error ${o.response.status}: ${o.response.data.message||"Error desconocido"}`,life:5e3}):r.add({severity:"error",summary:"Error de Red",detail:"No se pudo conectar con el servidor",life:5e3})}finally{m.value=!1}},P=async()=>{var o,a;if(i.value){r.add({severity:"warn",summary:"Backup en Proceso",detail:"Ya se está generando un backup. Por favor espere.",life:3e3});return}i.value=!0;try{r.add({severity:"info",summary:"Generando Backup",detail:"El proceso puede tomar unos minutos...",life:5e3});const e=await y.post("/api/backups/generate",{},{headers:b()});if(e.data.success)r.add({severity:"success",summary:"Backup Generado",detail:"El backup se ha generado correctamente.",life:4e3}),await g();else throw new Error(e.data.message||"Error al generar el backup")}catch(e){r.add({severity:"error",summary:"Error al Generar Backup",detail:((a=(o=e.response)==null?void 0:o.data)==null?void 0:a.message)||e.message||"Error desconocido",life:5e3})}finally{i.value=!1}},T=async o=>{try{const a=await y.get(`/api/backups/${o}/download`,{responseType:"blob"}),e=window.URL.createObjectURL(new Blob([a.data])),c=document.createElement("a");c.href=e;const R=a.headers["content-disposition"];let $="backup.zip";if(R){const N=R.match(/filename="(.+)"/);N&&($=N[1])}c.setAttribute("download",$),document.body.appendChild(c),c.click(),c.remove(),window.URL.revokeObjectURL(e),r.add({severity:"success",summary:"Descarga Iniciada",detail:"El archivo se está descargando",life:3e3})}catch{r.add({severity:"error",summary:"Error de Descarga",detail:"No se pudo descargar el respaldo",life:5e3})}},z=o=>{const a=v.value.find(e=>e.id===o);u.value=a||{id:o,name:`Backup ${o}`},h.value=!0},F=async()=>{var o,a;if(u.value){p.value=!0;try{const e=await y.delete(`/api/backups/${u.value.id}`,{headers:b()});if(e.data.success)r.add({severity:"success",summary:"Respaldo Eliminado",detail:`El respaldo "${u.value.name}" ha sido eliminado correctamente.`,life:3e3}),await g(),h.value=!1,u.value=null;else throw new Error(e.data.message||"Error al eliminar el respaldo")}catch(e){r.add({severity:"error",summary:"Error al Eliminar",detail:((a=(o=e.response)==null?void 0:o.data)==null?void 0:a.message)||e.message||"Error desconocido",life:5e3})}finally{p.value=!1}}},G=()=>{h.value=!1,u.value=null},U=async()=>{var o,a;if(v.value.length===0){r.add({severity:"info",summary:"No Hay Nada Que Limpiar",detail:"No hay respaldos disponibles para limpiar.",life:3e3});return}if(v.value.length<=B){r.add({severity:"info",summary:"No Hay Nada Que Limpiar",detail:`Solo hay ${v.value.length} respaldo(s). Se mantienen automáticamente los últimos ${B}.`,life:3e3});return}r.add({severity:"warn",summary:"Iniciando Limpieza",detail:`Se eliminarán los respaldos antiguos, manteniendo solo los últimos ${B}.`,life:4e3});try{const e=await y.post("/api/backups/cleanup",{},{headers:b()});if(e.data.success){const c=e.data.deleted_count||"varios";r.add({severity:"success",summary:"Limpieza Completada",detail:`Se han eliminado ${c} respaldo(s) antiguos.`,life:4e3}),await g()}else throw new Error(e.data.message||"Error al limpiar los respaldos")}catch(e){r.add({severity:"error",summary:"Error al Limpiar",detail:((a=(o=e.response)==null?void 0:o.data)==null?void 0:a.message)||e.message||"Error desconocido",life:5e3})}},A=()=>{E.value=window.innerWidth};return O(()=>{g(),typeof window<"u"&&window.addEventListener("resize",A)}),K(()=>{typeof window<"u"&&window.removeEventListener("resize",A)}),(o,a)=>(x(),V(J,null,{default:n(()=>[s("div",ie,[s("div",ne,[s("div",de,[l(t(H),{href:t(Y)("settings"),class:"flex items-center text-blue-600 hover:text-blue-700 transition-colors duration-200 px-2 py-1 rounded-md hover:bg-blue-50",disabled:m.value||i.value},{default:n(()=>[l(t(d),{icon:m.value||i.value?t(L):t(Z),class:C([{"animate-spin":m.value||i.value},"h-4 w-4 mr-2"])},null,8,["icon","class"]),s("span",ce,w(m.value||i.value?"Cargando...":"Volver a Configuración"),1)]),_:1},8,["href","disabled"])])]),s("div",me,[s("div",ue,[a[3]||(a[3]=s("div",{class:"w-full"},[s("h3",{class:"text-xl sm:text-2xl lg:text-3xl text-blue-600 font-bold text-center sm:text-start"},"Gestión de Respaldos"),s("p",{class:"text-gray-600 text-center sm:text-start mt-1 text-sm sm:text-base"},"Administre las copias de seguridad de la base de datos del sistema")],-1)),s("div",pe,[s("button",{onClick:P,disabled:i.value,class:"flex bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 border border-blue-500 px-3 sm:px-4 py-2 text-xs sm:text-sm text-white shadow-md hover:shadow-lg rounded-md hover:-translate-y-1 transition-all duration-300 items-center justify-center w-full sm:w-auto"},[l(t(d),{icon:i.value?t(L):t(j),class:C([{"animate-spin":i.value},"h-3 w-3 sm:h-4 sm:w-4 mr-1 sm:mr-2 text-white"])},null,8,["icon","class"]),i.value?(x(),k("span",ve,"Generando...")):(x(),k("span",he,"Generar"))],8,fe),s("button",{onClick:U,disabled:i.value,class:"flex bg-orange-500 hover:bg-orange-600 disabled:bg-gray-400 border border-orange-500 px-3 sm:px-4 py-2 text-xs sm:text-sm text-white shadow-md hover:shadow-lg rounded-md hover:-translate-y-1 transition-all duration-300 items-center justify-center w-full sm:w-auto"},[l(t(d),{icon:t(ee),class:"h-3 w-3 sm:h-4 sm:w-4 mr-1 sm:mr-2 text-white"},null,8,["icon"]),a[1]||(a[1]=s("span",{class:"hidden sm:inline"},"Limpiar Antiguos",-1)),a[2]||(a[2]=s("span",{class:"sm:hidden"},"Limpiar",-1))],8,xe)])]),l(t(q),{value:v.value,dataKey:"id",paginator:!0,rows:10,rowsPerPageOptions:[5,10,20,50],paginatorTemplate:"RowsPerPageDropdown FirstPageLink PrevPageLink CurrentPageReport NextPageLink LastPageLink",currentPageReportTemplate:"Mostrando {first} a {last} de {totalRecords} respaldos",class:"overflow-x-auto max-w-full",responsiveLayout:"scroll",loading:m.value,pt:{root:{class:"text-sm"},wrapper:{class:"text-sm"},table:{class:"text-sm"},thead:{class:"text-sm"},headerRow:{class:"text-sm"},headerCell:{class:"text-sm font-medium py-3 px-2"},tbody:{class:"text-sm"},bodyRow:{class:"h-20 text-sm hover:bg-blue-50 transition-colors duration-200"},bodyCell:{class:"py-3 px-2 text-sm"},paginator:{class:"text-xs sm:text-sm"},paginatorWrapper:{class:"flex flex-wrap justify-center sm:justify-between items-center gap-2 p-2"}}},{empty:n(()=>[s("div",we,[l(t(d),{icon:t(te),class:"text-4xl mb-2"},null,8,["icon"]),a[4]||(a[4]=s("p",null,"No hay respaldos disponibles",-1))])]),default:n(()=>[l(t(_),{field:"name",header:"Nombre del Archivo",sortable:"",class:"w-40"},{body:n(e=>[s("div",ye,[l(t(d),{icon:t(ae),class:"text-blue-600 mr-2 h-4 w-4"},null,8,["icon"]),s("div",{class:"text-sm font-medium leading-relaxed overflow-hidden",style:{"max-width":"200px","text-overflow":"ellipsis","white-space":"nowrap"},title:e.data.name},w(e.data.name),9,be)])]),_:1}),l(t(_),{field:"date",header:"Fecha de Creación",sortable:"",class:"w-32 hidden sm:table-cell"},{body:n(e=>[s("div",ge,w(e.data.date),1)]),_:1}),l(t(_),{field:"size",header:"Tamaño",class:"w-24 hidden md:table-cell"},{body:n(e=>[s("div",ke,w(e.data.size),1)]),_:1}),l(t(_),{exportable:!1,class:"w-32 min-w-28"},{header:n(()=>a[5]||(a[5]=[s("div",{class:"text-center w-full font-bold"}," Acciones ",-1)])),body:n(e=>[s("div",_e,[s("button",{onClick:c=>T(e.data.id),class:"flex bg-green-500 border p-1 py-2 sm:p-2 text-sm shadow-md hover:shadow-lg rounded-md hover:-translate-y-1 transition-transform duration-300",title:"Descargar "+e.data.name},[l(t(d),{icon:t(j),class:"h-3 w-6 sm:h-4 sm:w-7 text-white"},null,8,["icon"]),a[6]||(a[6]=s("span",{class:"hidden md:block text-white"},"Descargar",-1))],8,Ee),s("button",{onClick:c=>z(e.data.id),class:"flex bg-red-500 border p-1 py-2 sm:p-2 text-sm shadow-md hover:shadow-lg rounded-md hover:-translate-y-1 transition-transform duration-300",title:"Eliminar "+e.data.name},[l(t(d),{icon:t(se),class:"h-3 w-6 sm:h-4 sm:w-7 text-white"},null,8,["icon"]),a[7]||(a[7]=s("span",{class:"hidden md:block text-white"},"Eliminar",-1))],8,Ce)])]),_:1})]),_:1},8,["value","loading"])])]),l(t(X),{class:"z-[9999]"}),l(t(I),{visible:h.value,"onUpdate:visible":a[0]||(a[0]=e=>h.value=e),header:"Eliminar Respaldo",modal:!0,style:M(D.value),closable:!1,draggable:!1},{footer:n(()=>[s("div",Ae,[s("button",{type:"button",class:"bg-red-500 hover:bg-red-700 text-white border-none px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",onClick:F,disabled:p.value},[l(t(d),{icon:p.value?t(L):t(le),class:C(["h-5",{"animate-spin":p.value}])},null,8,["icon","class"]),p.value?(x(),k("span",Ne,"Eliminando...")):(x(),k("span",$e,"Eliminar"))],8,Re),s("button",{type:"button",class:"bg-blue-500 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2",onClick:G,disabled:p.value},[l(t(d),{icon:t(re),class:"h-5"},null,8,["icon"]),a[11]||(a[11]=s("span",null,"Cancelar",-1))],8,Se)])]),default:n(()=>{var e;return[s("div",Le,[l(t(d),{icon:t(oe),class:"h-8 w-8 text-red-500"},null,8,["icon"]),s("div",Be,[s("span",null,[a[8]||(a[8]=S("¿Estás seguro de eliminar el respaldo: ")),s("b",null,w((e=u.value)==null?void 0:e.name),1),a[9]||(a[9]=S("?"))]),a[10]||(a[10]=s("span",{class:"text-red-600 text-sm font-medium mt-1"},"Esta acción es irreversible.",-1))])])]}),_:1},8,["visible","style"])]),_:1}))}};export{Ge as default};
