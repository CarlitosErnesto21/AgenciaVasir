import{r as E,N as z,a4 as H,E as N,w as J,c as p,j as M,d as f,e,p as m,q as T,$ as t,t as y,I as L,F as B,l as Q}from"./vendor-CLNWHdEK.js";import{u as I}from"./carrito-CEIou188.js";import{D as v}from"./ui-DPmvhuIJ.js";import{I as Y}from"./ImageWithFallback-BMmAhLAu.js";import{am as U,y as Z,h as ee,an as te,ac as oe,t as se,ad as K,g as ae,ao as re,z as ne,b as le,P as O}from"./index-Bt2ku3xk.js";import{_ as G}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./app-CeJXAJNY.js";function ie(){const k=E(!1),l=E(null),R=I(),g=z.create(),j=()=>{var d;return((d=document.head.querySelector('meta[name="csrf-token"]'))==null?void 0:d.content)||null};return g.interceptors.request.use(i=>{const d=j();return d&&(i.headers["X-CSRF-TOKEN"]=d),i.headers["X-Requested-With"]="XMLHttpRequest",i.headers.Accept="application/json",i}),{loading:k,error:l,createVentaFromCarrito:async i=>{var d,a,o,r,c;k.value=!0,l.value=null;try{const h={productos:R.items.map(b=>({id:b.id,cantidad:b.cantidad,precio:b.precio,nombre:b.nombre,imagen:b.primera_imagen||b.imagen||null,subtotal:b.precio*b.cantidad})),customer_email:i};let x;try{x=await g.post("/carrito/create-venta",h)}catch(b){if(((d=b.response)==null?void 0:d.status)===419){console.log("ðŸ”„ Token CSRF expirado, renovando...");try{const C=await z.get("/tienda",{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"text/html,application/xhtml+xml"}});if(C.data&&typeof C.data=="string"){const V=C.data.match(/name="csrf-token" content="([^"]+)"/);if(V){const q=V[1],n=document.head.querySelector('meta[name="csrf-token"]');n&&(n.setAttribute("content",q),console.log("âœ… Token CSRF renovado:",q))}}x=await g.post("/carrito/create-venta",h)}catch(C){throw C}}else throw b}if(x.data.success)return{success:!0,venta:x.data.venta,message:x.data.message};throw new Error(x.data.message||"Error desconocido")}catch(u){console.error("Error creando venta desde carrito:",u);let h="Error al crear la venta";return(o=(a=u.response)==null?void 0:a.data)!=null&&o.message?h=u.response.data.message:(c=(r=u.response)==null?void 0:r.data)!=null&&c.errors?h=Object.values(u.response.data.errors).flat().join(", "):u.message&&(h=u.message),l.value=h,{success:!1,error:h}}finally{k.value=!1}},procesarPagoVenta:async i=>{var d,a,o,r;k.value=!0,l.value=null;try{const c=await g.post("/pagos/venta",i);if(c.data.success)return{success:!0,pago:c.data.pago,wompi_data:c.data.wompi_data,message:c.data.message};throw new Error(c.data.message||"Error en el pago")}catch(c){console.error("Error procesando pago:",c);let u="Error al procesar el pago";return(a=(d=c.response)==null?void 0:d.data)!=null&&a.message?u=c.response.data.message:(r=(o=c.response)==null?void 0:o.data)!=null&&r.errors?u=Object.values(c.response.data.errors).flat().join(", "):c.message&&(u=c.message),l.value=u,{success:!1,error:u}}finally{k.value=!1}},consultarEstadoPago:async i=>{var d,a;try{const o=await g.get(`/pagos/${i}/estado`);if(o.data.success)return{success:!0,pago:o.data.pago};throw new Error(o.data.message||"Error consultando estado")}catch(o){return console.error("Error consultando estado del pago:",o),{success:!1,error:((a=(d=o.response)==null?void 0:d.data)==null?void 0:a.message)||o.message||"Error consultando estado"}}}}}const ce={class:"modal-header"},de={class:"modal-title"},ue={key:0,class:"loading-state"},me={key:1,class:"error-state"},pe={key:2,class:"payment-form"},fe={class:"purchase-summary"},ve={class:"summary-details"},ge={class:"total-amount"},be={class:"amount"},ye={class:"order-reference"},he={class:"reference"},xe={class:"payment-section"},Ce=["disabled"],ke={key:0,class:"w-6 h-6 mr-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},we={key:1,class:"w-6 h-6 mr-3 animate-spin",fill:"none",viewBox:"0 0 24 24"},_e={class:"payment-info"},$e={class:"info-item"},Ee={class:"info-item"},Te={key:3,class:"success-state"},Se={class:"success-details"},Pe={class:"cart-cleared-notice"},Fe={__name:"CarritoCheckoutModal",props:{isVisible:{type:Boolean,default:!1}},emits:["close","payment-completed"],setup(k,{emit:l}){const R=k,g=l,{createVentaFromCarrito:j}=ie(),w=I(),A=H(),S=E(!1),i=E(null),d=E(!1),a=E(null),o=E(!1),r=N(()=>{var n;return(n=A.props.auth)==null?void 0:n.user}),c=N(()=>{var n;return((n=r.value)==null?void 0:n.email)||""}),u=N(()=>{var n;return((n=r.value)==null?void 0:n.name)||""}),h=n=>n?new Intl.NumberFormat("es-CO",{minimumFractionDigits:2,maximumFractionDigits:2}).format(n):"0.00";J(()=>R.isVisible,async n=>{n&&!i.value&&!d.value&&await x()});const x=async()=>{if(w.isEmpty){a.value="El carrito estÃ¡ vacÃ­o";return}if(!c.value){a.value="No se encontrÃ³ informaciÃ³n del usuario";return}S.value=!0,a.value=null;try{const n=await j(c.value);n.success?i.value=n.venta:a.value=n.error||"Error creando la venta"}catch(n){a.value="Error inesperado al crear la venta",console.error("Error creando venta:",n)}finally{S.value=!1}},b=async()=>{if(!i.value){a.value="No hay venta creada";return}o.value=!0,a.value=null;try{const n=()=>{var F;return((F=document.querySelector('meta[name="csrf-token"]'))==null?void 0:F.getAttribute("content"))||null},s=async()=>{var F;return await fetch("/wompi/payment-link",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":n(),"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({customer_email:c.value,amount:w.totalPrice,description:`Compra de ${w.items.length} producto(s) - ${u.value}`,reference:`CART-${Date.now()}`,customer_name:u.value,venta_id:((F=i.value)==null?void 0:F.id)||null,productos:w.items.map(_=>({id:_.id,nombre:_.nombre,precio:_.precio,cantidad:_.cantidad,imagen:_.primera_imagen||_.imagen||null,subtotal:_.precio*_.cantidad}))})})};let P=await s();if(P.status===419){console.log("ðŸ”„ Token CSRF expirado, renovando...");const X=(await(await fetch("/tienda",{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"text/html,application/xhtml+xml"}})).text()).match(/name="csrf-token" content="([^"]+)"/);if(X){const D=X[1],W=document.querySelector('meta[name="csrf-token"]');W&&(W.setAttribute("content",D),console.log("âœ… Token CSRF renovado:",D))}P=await s()}const $=await P.json();$.success?(window.open($.payment_link,"_blank"),w.limpiarCarrito(),d.value=!0,setTimeout(()=>{C()},3e3),g("payment-completed",{success:!0,venta:i.value,payment_link:$.payment_link,reference:$.reference,cart_cleared:!0})):a.value=$.message||"Error creando enlace de pago"}catch(n){console.error("Error procesando pago:",n),a.value="Error procesando el pago. IntÃ©ntalo de nuevo."}finally{o.value=!1}},C=()=>{g("close"),V()},V=()=>{i.value=null,d.value=!1,a.value=null,S.value=!1},q=()=>{V(),x()};return(n,s)=>{var P,$;return k.isVisible?(f(),p("div",{key:0,class:"modal-overlay",onClick:C},[e("div",{class:"modal-container",onClick:s[0]||(s[0]=L(()=>{},["stop"]))},[e("div",ce,[e("h3",de,[m(t(v),{icon:t(U),class:"title-icon"},null,8,["icon"]),s[1]||(s[1]=T(" Finalizar Compra "))]),e("button",{onClick:C,class:"close-button"},[m(t(v),{icon:t(Z)},null,8,["icon"])])]),S.value?(f(),p("div",ue,s[2]||(s[2]=[e("div",{class:"spinner"},null,-1),e("p",null,"Procesando tu pedido...",-1)]))):a.value?(f(),p("div",me,[m(t(v),{icon:t(ee),class:"error-icon"},null,8,["icon"]),s[3]||(s[3]=e("h4",null,"Error al procesar",-1)),e("p",null,y(a.value),1),e("button",{onClick:q,class:"retry-button"}," Intentar de nuevo ")])):i.value?(f(),p("div",pe,[e("div",fe,[s[6]||(s[6]=e("h4",null,"Resumen de tu compra",-1)),e("div",ve,[e("div",ge,[s[4]||(s[4]=e("span",null,"Total a pagar:",-1)),e("span",be,"$"+y(h(i.value.total)),1)]),e("div",ye,[s[5]||(s[5]=e("span",null,"NÃºmero de orden:",-1)),e("span",he,"#"+y(i.value.id),1)])])]),e("div",xe,[e("button",{onClick:b,disabled:o.value,class:"w-full inline-flex items-center justify-center px-6 py-4 border border-transparent text-lg font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"},[o.value?(f(),p("svg",we,s[8]||(s[8]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)]))):(f(),p("svg",ke,s[7]||(s[7]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"},null,-1)]))),T(" "+y(o.value?"Generando enlace de pago...":"Pagar con Wompi"),1)],8,Ce)]),e("div",_e,[e("div",$e,[m(t(v),{icon:t(te),class:"info-icon"},null,8,["icon"]),s[9]||(s[9]=e("span",null,"Pago seguro con encriptaciÃ³n SSL",-1))]),e("div",Ee,[m(t(v),{icon:t(oe),class:"info-icon"},null,8,["icon"]),s[10]||(s[10]=e("span",null,"Procesamiento inmediato",-1))])])])):d.value?(f(),p("div",Te,[m(t(v),{icon:t(se),class:"success-icon"},null,8,["icon"]),s[15]||(s[15]=e("h4",null,"Â¡Enlace de pago creado!",-1)),s[16]||(s[16]=e("p",null,"Se abriÃ³ una nueva ventana con tu enlace de pago seguro.",-1)),e("div",Se,[e("p",null,[s[11]||(s[11]=e("strong",null,"NÃºmero de orden:",-1)),T(" #"+y((P=i.value)==null?void 0:P.id),1)]),e("p",null,[s[12]||(s[12]=e("strong",null,"Total a pagar:",-1)),T(" $"+y(h(($=i.value)==null?void 0:$.total)),1)]),e("p",Pe,[m(t(v),{icon:t(K),class:"cart-icon"},null,8,["icon"]),s[13]||(s[13]=T(" Tu carrito se ha limpiado automÃ¡ticamente "))])]),e("div",{class:"success-actions"},[s[14]||(s[14]=e("p",{class:"auto-close-notice"},"Esta ventana se cerrarÃ¡ automÃ¡ticamente en unos segundos",-1)),e("button",{onClick:C,class:"success-button"}," Cerrar ahora ")])])):M("",!0)])])):M("",!0)}}},Re=G(Fe,[["__scopeId","data-v-e288b6a7"]]),je={class:"absolute right-0 top-0 h-full w-full max-w-md transform transition-transform carrito-panel"},Ve={class:"flex h-full flex-col bg-white shadow-xl"},Me={class:"flex items-center justify-between border-b border-gray-200 px-6 py-4"},Ae={class:"text-lg font-semibold text-gray-900 flex items-center gap-2"},qe={class:"px-6 py-2 bg-blue-50 border-b border-blue-100"},Ne={class:"text-sm text-blue-800"},Ie={class:"flex-1 overflow-y-auto px-6 py-4 carrito-scroll"},Xe={key:0,class:"flex flex-col items-center justify-center h-full text-center empty-state"},De={key:1,class:"space-y-4"},We={class:"flex-shrink-0 w-16 h-16 producto-imagen"},ze={class:"flex-1 min-w-0"},Be={class:"text-sm font-medium text-gray-900 truncate"},Oe={class:"text-sm text-blue-600 font-semibold"},He={class:"text-xs text-gray-500 whitespace-nowrap"},Le={class:"flex items-center gap-2"},Ue=["onClick","disabled"],Ke={class:"w-8 text-center text-sm font-medium"},Ge=["onClick","disabled"],Je=["onClick"],Qe={key:0,class:"px-6 py-3 border-t border-gray-100"},Ye={key:1,class:"border-t border-gray-200 px-6 py-4 space-y-4"},Ze={class:"flex items-center justify-between"},et={class:"text-xl font-bold text-blue-600 total-badge"},tt={class:"space-y-2"},ot={__name:"CarritoCompras",setup(k){const l=I(),R=H(),g=E(!1),j=N(()=>{var a;return!!((a=R.props.auth)!=null&&a.user)}),w=a=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(a),A=()=>{if(!j.value){alert("Debes iniciar sesiÃ³n para continuar con la compra");return}if(l.isEmpty){alert("Tu carrito estÃ¡ vacÃ­o");return}g.value=!0},S=()=>{g.value=!1},i=a=>{g.value=!1},d=a=>a.imagen?a.imagen.startsWith("http")||a.imagen.startsWith("data:")?a.imagen:`/storage/productos/${a.imagen}`:null;return(a,o)=>(f(),p(B,null,[t(l).isVisible?(f(),p("div",{key:0,class:"fixed inset-0 z-[10000] overflow-hidden carrito-overlay",onClick:o[5]||(o[5]=L(r=>t(l).ocultarCarrito(),["self"]))},[e("div",{class:"absolute inset-0 bg-black bg-opacity-50 transition-opacity cursor-pointer fondo-clickeable",onClick:o[0]||(o[0]=r=>t(l).ocultarCarrito())}),e("div",je,[e("div",Ve,[e("div",Me,[e("h2",Ae,[m(t(v),{icon:t(K),class:"text-blue-600"},null,8,["icon"]),o[6]||(o[6]=T(" Carrito de Compras "))]),e("button",{onClick:o[1]||(o[1]=r=>t(l).ocultarCarrito()),class:"text-gray-400 hover:text-gray-600 transition-colors"},[m(t(v),{icon:t(ae),class:"w-6 h-6"},null,8,["icon"])])]),e("div",qe,[e("p",Ne,y(t(l).itemCount)+" "+y(t(l).itemCount===1?"producto":"productos")+" en tu carrito ",1)]),e("div",Ie,[t(l).isEmpty?(f(),p("div",Xe,[m(t(v),{icon:t(re),class:"w-16 h-16 text-gray-300 mb-4"},null,8,["icon"]),o[7]||(o[7]=e("h3",{class:"text-lg font-medium text-gray-900 mb-2"},"Tu carrito estÃ¡ vacÃ­o",-1)),o[8]||(o[8]=e("p",{class:"text-gray-500 mb-6"},"Agrega algunos productos para comenzar",-1)),e("button",{onClick:o[2]||(o[2]=r=>t(l).ocultarCarrito()),class:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-colors"}," Continuar Comprando ")])):(f(),p("div",De,[(f(!0),p(B,null,Q(t(l).items,r=>(f(),p("div",{key:r.id,class:"flex items-center gap-4 p-4 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors producto-item"},[e("div",We,[m(Y,{src:d(r),alt:r.nombre,"fallback-text":r.nombre,"container-class":"w-full h-full","image-class":"w-full h-full object-cover rounded-md border border-gray-200"},null,8,["src","alt","fallback-text"])]),e("div",ze,[e("h4",Be,y(r.nombre),1),e("p",Oe,y(w(r.precio)),1),e("p",He," Stock: "+y(r.stock_actual),1)]),e("div",Le,[e("button",{onClick:c=>t(l).decrementarCantidad(r.id),class:"w-8 h-8 flex items-center justify-center border border-gray-300 rounded-md hover:bg-gray-50 transition-colors cantidad-btn",disabled:r.cantidad<=1},[m(t(v),{icon:t(ne),class:"w-3 h-3"},null,8,["icon"])],8,Ue),e("span",Ke,y(r.cantidad),1),e("button",{onClick:c=>t(l).incrementarCantidad(r.id),class:"w-8 h-8 flex items-center justify-center border border-gray-300 rounded-md hover:bg-gray-50 transition-colors cantidad-btn",disabled:r.cantidad>=r.stock_actual},[m(t(v),{icon:t(le),class:"w-3 h-3"},null,8,["icon"])],8,Ge)]),e("button",{onClick:c=>t(l).eliminarProducto(r.id),class:"p-2 text-red-400 hover:text-red-600 transition-colors btn-eliminar",title:"Eliminar producto"},[m(t(v),{icon:t(O),class:"w-4 h-4"},null,8,["icon"])],8,Je)]))),128))]))]),t(l).isEmpty?M("",!0):(f(),p("div",Qe,[e("button",{onClick:o[3]||(o[3]=r=>t(l).limpiarCarrito()),class:"w-full text-red-500 hover:text-red-700 hover:bg-red-50 py-2 px-4 text-sm transition-colors flex items-center justify-center gap-2 rounded-md border border-red-200 hover:border-red-300"},[m(t(v),{icon:t(O),class:"w-4 h-4"},null,8,["icon"]),o[9]||(o[9]=T(" Vaciar Carrito "))])])),t(l).isEmpty?M("",!0):(f(),p("div",Ye,[e("div",Ze,[o[10]||(o[10]=e("span",{class:"text-lg font-semibold text-gray-900"},"Total:",-1)),e("span",et,y(w(t(l).totalPrice)),1)]),e("div",tt,[e("button",{onClick:A,class:"w-full text-white py-3 px-4 rounded-md transition-colors flex items-center justify-center gap-2 font-medium btn-checkout"},[m(t(v),{icon:t(U)},null,8,["icon"]),o[11]||(o[11]=T(" Proceder al Checkout "))]),e("button",{onClick:o[4]||(o[4]=r=>t(l).ocultarCarrito()),class:"w-full text-white py-2 px-4 rounded-md transition-colors btn-continuar"}," Continuar Comprando ")])]))])])])):M("",!0),m(Re,{"is-visible":g.value,onClose:S,onPaymentCompleted:i},null,8,["is-visible"])],64))}},dt=G(ot,[["__scopeId","data-v-579d1735"]]);export{dt as default};
