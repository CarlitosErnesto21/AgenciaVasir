import{r as k,N as O,a4 as G,E as N,w as ee,c as v,j as D,d as m,e,p as f,q as M,$ as t,t as y,F as B,l as K,I as J,x as I,B as X,y as te,h as ae}from"./vendor-DcS5GX9S.js";import{u as W}from"./carrito-CG6dC_5T.js";import{D as h}from"./ui-DN6aYgk-.js";import{I as oe}from"./ImageWithFallback-_VPuFh5t.js";import{ap as Q,s as se,h as re,aq as ne,a7 as le,p as ie,a8 as Y,g as ce,ar as ue,t as de,b as me,M as U}from"./index-00cYtq1U.js";import{_ as Z}from"./_plugin-vue_export-helper-DlAUqK2U.js";import pe from"./ModalDatosCliente-YskJqtp_.js";import"./app-BVz9ZwSN.js";function fe(){const S=k(!1),c=k(null),E=W(),b=O.create(),F=()=>{var p;return((p=document.head.querySelector('meta[name="csrf-token"]'))==null?void 0:p.content)||null};return b.interceptors.request.use(s=>{const p=F();return p&&(s.headers["X-CSRF-TOKEN"]=p),s.headers["X-Requested-With"]="XMLHttpRequest",s.headers.Accept="application/json",s}),{loading:S,error:c,createVentaFromCarrito:async(s,p=null)=>{var l,u,$,d,x;S.value=!0,c.value=null;try{const g={productos:E.items.map(a=>({id:a.id,cantidad:a.cantidad,precio:a.precio,nombre:a.nombre,imagen:a.primera_imagen||a.imagen||null,subtotal:a.precio*a.cantidad})),customer_email:s,cliente_data:p};let w;try{w=await b.post("/carrito/create-venta",g)}catch(a){if(((l=a.response)==null?void 0:l.status)===419){console.log("ðŸ”„ Token CSRF expirado, renovando...");try{const r=await O.get("/tienda",{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"text/html,application/xhtml+xml"}});if(r.data&&typeof r.data=="string"){const i=r.data.match(/name="csrf-token" content="([^"]+)"/);if(i){const V=i[1],n=document.head.querySelector('meta[name="csrf-token"]');n&&(n.setAttribute("content",V),console.log("âœ… Token CSRF renovado:",V))}}w=await b.post("/carrito/create-venta",g)}catch(r){throw r}}else throw a}if(w.data.success)return{success:!0,venta:w.data.venta,message:w.data.message};throw new Error(w.data.message||"Error desconocido")}catch(_){console.error("Error creando venta desde carrito:",_);let g="Error al crear la venta";return($=(u=_.response)==null?void 0:u.data)!=null&&$.message?g=_.response.data.message:(x=(d=_.response)==null?void 0:d.data)!=null&&x.errors?g=Object.values(_.response.data.errors).flat().join(", "):_.message&&(g=_.message),c.value=g,{success:!1,error:g}}finally{S.value=!1}},procesarPagoVenta:async s=>{var p,l,u,$;S.value=!0,c.value=null;try{const d=await b.post("/pagos/venta",s);if(d.data.success)return{success:!0,pago:d.data.pago,wompi_data:d.data.wompi_data,message:d.data.message};throw new Error(d.data.message||"Error en el pago")}catch(d){console.error("Error procesando pago:",d);let x="Error al procesar el pago";return(l=(p=d.response)==null?void 0:p.data)!=null&&l.message?x=d.response.data.message:($=(u=d.response)==null?void 0:u.data)!=null&&$.errors?x=Object.values(d.response.data.errors).flat().join(", "):d.message&&(x=d.message),c.value=x,{success:!1,error:x}}finally{S.value=!1}},consultarEstadoPago:async s=>{var p,l;try{const u=await b.get(`/pagos/${s}/estado`);if(u.data.success)return{success:!0,pago:u.data.pago};throw new Error(u.data.message||"Error consultando estado")}catch(u){return console.error("Error consultando estado del pago:",u),{success:!1,error:((l=(p=u.response)==null?void 0:p.data)==null?void 0:l.message)||u.message||"Error consultando estado"}}}}}const ve={class:"modal-header"},ge={class:"modal-title"},ye={key:0,class:"loading-state"},he={key:1,class:"error-state"},be={key:2,class:"payment-form"},Ce={class:"purchase-summary"},_e={class:"summary-details"},xe={class:"cart-items"},ke={class:"item-name"},we={class:"item-quantity"},Ee={class:"item-price"},$e={class:"total-amount"},Te={class:"amount"},Se={class:"payment-section"},Pe=["disabled"],je={key:0,class:"w-6 h-6 mr-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},De={key:1,class:"w-6 h-6 mr-3 animate-spin",fill:"none",viewBox:"0 0 24 24"},Fe={class:"payment-info"},Me={class:"info-item"},Re={class:"info-item"},Ve={key:3,class:"success-state"},qe={class:"success-details"},Ae={key:0},Ne={class:"cart-cleared-notice"},Ie={__name:"CarritoCheckoutModal",props:{isVisible:{type:Boolean,default:!1},clienteData:{type:Object,default:null}},emits:["close","payment-completed"],setup(S,{emit:c}){const E=S,b=c,{createVentaFromCarrito:F}=fe(),C=W(),R=G(),T=k(!1),s=k(null),p=k(!1),l=k(null),u=k(!1),$=N(()=>{var n;return(n=R.props.auth)==null?void 0:n.user}),d=N(()=>{var n;return((n=$.value)==null?void 0:n.email)||""}),x=N(()=>{var n;return(n=$.value)!=null&&n.name?$.value.name:"Cliente"}),_=N(()=>E.clienteData?{id:E.clienteData.id,numero_identificacion:E.clienteData.numero_identificacion,telefono:E.clienteData.telefono,direccion:E.clienteData.direccion,tipo_documento_id:E.clienteData.tipo_documento_id}:null),g=n=>n?new Intl.NumberFormat("es-CO",{minimumFractionDigits:2,maximumFractionDigits:2}).format(n):"0.00";ee(()=>E.isVisible,n=>{n&&i()});const w=async()=>{if(C.isEmpty){l.value="El carrito estÃ¡ vacÃ­o";return}if(!d.value){l.value="No se encontrÃ³ informaciÃ³n del usuario";return}if(!_.value){l.value="No se encontraron datos del cliente";return}T.value=!0,l.value=null;try{const n=await F(d.value,_.value);n.success?s.value=n.venta:l.value=n.error||"Error creando la venta"}catch(n){l.value="Error inesperado al crear la venta",console.error("Error creando venta:",n)}finally{T.value=!1}},a=async()=>{if(u.value=!0,l.value=null,!s.value){T.value=!0;try{if(await w(),l.value||!s.value){u.value=!1;return}}finally{T.value=!1}}try{const n=()=>{var q;return((q=document.querySelector('meta[name="csrf-token"]'))==null?void 0:q.getAttribute("content"))||null},o=async()=>{var q;return await fetch("/wompi/payment-link",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":n(),"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({customer_email:d.value,amount:C.totalPrice,description:`Compra de ${C.items.length} producto(s) - ${x.value}`,reference:`CART-${Date.now()}`,customer_name:x.value,venta_id:((q=s.value)==null?void 0:q.id)||null,productos:C.items.map(j=>({id:j.id,nombre:j.nombre,precio:j.precio,cantidad:j.cantidad,imagen:j.primera_imagen||j.imagen||null,subtotal:j.precio*j.cantidad}))})})};let P=await o();if(P.status===419){console.log("ðŸ”„ Token CSRF expirado, renovando...");const z=(await(await fetch("/tienda",{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"text/html,application/xhtml+xml"}})).text()).match(/name="csrf-token" content="([^"]+)"/);if(z){const H=z[1],L=document.querySelector('meta[name="csrf-token"]');L&&(L.setAttribute("content",H),console.log("âœ… Token CSRF renovado:",H))}P=await o()}const A=await P.json();A.success?(window.open(A.payment_link,"_blank"),C.limpiarCarrito(),p.value=!0,setTimeout(()=>{r()},3e3),b("payment-completed",{success:!0,venta:s.value,payment_link:A.payment_link,reference:A.reference,cart_cleared:!0})):l.value=A.message||"Error creando enlace de pago"}catch(n){console.error("Error procesando pago:",n),l.value="Error procesando el pago. IntÃ©ntalo de nuevo."}finally{u.value=!1}},r=()=>{b("close"),i()},i=()=>{s.value=null,p.value=!1,l.value=null,T.value=!1},V=()=>{i(),w()};return(n,o)=>S.isVisible?(m(),v("div",{key:0,class:"modal-overlay",onClick:r},[e("div",{class:"modal-container",onClick:o[0]||(o[0]=J(()=>{},["stop"]))},[e("div",ve,[e("h3",ge,[f(t(h),{icon:t(Q),class:"title-icon"},null,8,["icon"]),o[1]||(o[1]=M(" Finalizar Compra "))]),e("button",{onClick:r,class:"close-button"},[f(t(h),{icon:t(se)},null,8,["icon"])])]),T.value?(m(),v("div",ye,o[2]||(o[2]=[e("div",{class:"spinner"},null,-1),e("p",null,"Procesando tu pedido...",-1)]))):l.value?(m(),v("div",he,[f(t(h),{icon:t(re),class:"error-icon"},null,8,["icon"]),o[3]||(o[3]=e("h4",null,"Error al procesar",-1)),e("p",null,y(l.value),1),e("button",{onClick:V,class:"retry-button"}," Intentar de nuevo ")])):(m(),v("div",be,[e("div",Ce,[o[5]||(o[5]=e("h4",null,"Resumen de tu compra",-1)),e("div",_e,[e("div",xe,[(m(!0),v(B,null,K(t(C).items,P=>(m(),v("div",{key:P.id,class:"cart-item"},[e("span",ke,y(P.nombre),1),e("span",we,y(P.cantidad)+"x",1),e("span",Ee,"$"+y(g(P.precio*P.cantidad)),1)]))),128))]),e("div",$e,[o[4]||(o[4]=e("span",null,"Total a pagar:",-1)),e("span",Te,"$"+y(g(t(C).totalPrice)),1)])])]),e("div",Se,[e("button",{onClick:a,disabled:u.value,class:"w-full inline-flex items-center justify-center px-6 py-4 border border-transparent text-lg font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"},[u.value?(m(),v("svg",De,o[7]||(o[7]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)]))):(m(),v("svg",je,o[6]||(o[6]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"},null,-1)]))),M(" "+y(u.value?"Generando enlace de pago...":"Pagar con Wompi"),1)],8,Pe)]),e("div",Fe,[e("div",Me,[f(t(h),{icon:t(ne),class:"info-icon"},null,8,["icon"]),o[8]||(o[8]=e("span",null,"Pago seguro con encriptaciÃ³n SSL",-1))]),e("div",Re,[f(t(h),{icon:t(le),class:"info-icon"},null,8,["icon"]),o[9]||(o[9]=e("span",null,"Procesamiento inmediato",-1))])])])),p.value?(m(),v("div",Ve,[f(t(h),{icon:t(ie),class:"success-icon"},null,8,["icon"]),o[14]||(o[14]=e("h4",null,"Â¡Enlace de pago creado!",-1)),o[15]||(o[15]=e("p",null,"Se abriÃ³ una nueva ventana con tu enlace de pago seguro.",-1)),e("div",qe,[s.value?(m(),v("p",Ae,[o[10]||(o[10]=e("strong",null,"NÃºmero de orden:",-1)),M(" #"+y(s.value.id),1)])):D("",!0),e("p",null,[o[11]||(o[11]=e("strong",null,"Total pagado:",-1)),M(" $"+y(g(t(C).totalPrice)),1)]),e("p",Ne,[f(t(h),{icon:t(Y),class:"cart-icon"},null,8,["icon"]),o[12]||(o[12]=M(" Tu carrito se ha limpiado automÃ¡ticamente "))])]),e("div",{class:"success-actions"},[o[13]||(o[13]=e("p",{class:"auto-close-notice"},"Esta ventana se cerrarÃ¡ automÃ¡ticamente en unos segundos",-1)),e("button",{onClick:r,class:"success-button"}," Cerrar ahora ")])])):D("",!0)])])):D("",!0)}},Xe=Z(Ie,[["__scopeId","data-v-a73afb15"]]),Oe={key:0,class:"absolute right-0 top-0 h-full w-full max-w-md transform carrito-panel"},Be={class:"flex h-full flex-col bg-white shadow-xl"},We={class:"flex items-center justify-between border-b border-gray-200 px-6 py-4"},ze={class:"text-lg font-semibold text-gray-900 flex items-center gap-2"},He={class:"px-6 py-2 bg-blue-50 border-b border-blue-100"},Le={class:"text-sm text-blue-800"},Ue={class:"flex-1 overflow-y-auto px-6 py-4 carrito-scroll"},Ge={key:0,class:"flex flex-col items-center justify-center h-full text-center empty-state"},Ke={key:1,class:"space-y-4"},Je={class:"flex-shrink-0 w-16 h-16 producto-imagen"},Qe={class:"flex-1 min-w-0"},Ye={class:"text-sm font-medium text-gray-900 truncate"},Ze={class:"text-sm text-blue-600 font-semibold"},et={class:"text-xs text-gray-500 whitespace-nowrap"},tt={class:"flex items-center gap-2"},at=["onClick","disabled"],ot={class:"w-8 text-center text-sm font-medium"},st=["onClick","disabled"],rt=["onClick"],nt={key:0,class:"px-6 py-3 border-t border-gray-100"},lt={key:1,class:"border-t border-gray-200 px-6 py-4 space-y-4"},it={class:"flex items-center justify-between"},ct={class:"text-xl font-bold text-blue-600 total-badge"},ut={class:"space-y-2"},dt=["disabled"],mt={__name:"CarritoCompras",setup(S){const c=W(),E=G(),b=k(!1),F=k(!1),C=k(!1),R=k(null),T=k(!1),s=k(!1),p=N(()=>{var a;return!!((a=E.props.auth)!=null&&a.user)}),l=a=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(a),u=async()=>{if(!p.value)return{tieneCliente:!1,cliente:null};try{T.value=!0;const a=await O.get("/api/verificar-datos-cliente");return a.data.success&&a.data.tiene_datos_completos?(R.value=a.data.cliente,{tieneCliente:!0,cliente:a.data.cliente}):{tieneCliente:!1,cliente:null}}catch(a){return console.error("Error al verificar cliente:",a),{tieneCliente:!1,cliente:null}}finally{T.value=!1}},$=async()=>{if(c.isEmpty){alert("Tu carrito estÃ¡ vacÃ­o");return}if(!p.value){alert("Debes iniciar sesiÃ³n para proceder con la compra");return}try{s.value=!0,g(),setTimeout(async()=>{try{const{tieneCliente:a,cliente:r}=await u();a?(R.value=r,b.value=!0):F.value=!0}catch(a){console.error("Error en proceso de checkout:",a),alert("OcurriÃ³ un error al procesar tu solicitud. Por favor intenta nuevamente.")}finally{s.value=!1}},350)}catch(a){console.error("Error inicial en checkout:",a),s.value=!1,alert("OcurriÃ³ un error al procesar tu solicitud. Por favor intenta nuevamente.")}},d=()=>{b.value=!1},x=a=>{R.value=a,F.value=!1,setTimeout(()=>{b.value=!0},300)},_=a=>{b.value=!1},g=()=>{C.value=!0,setTimeout(()=>{c.ocultarCarrito(),C.value=!1},300)},w=a=>a.imagen?a.imagen.startsWith("http")||a.imagen.startsWith("data:")?a.imagen:`/storage/productos/${a.imagen}`:null;return(a,r)=>(m(),v(B,null,[f(X,{name:"carrito-fade",appear:""},{default:I(()=>[t(c).isVisible?(m(),v("div",{key:0,class:"fixed inset-0 z-[10000] overflow-hidden carrito-overlay",onClick:J(g,["self"])},[f(X,{name:"backdrop-fade",appear:""},{default:I(()=>[C.value?D("",!0):(m(),v("div",{key:0,class:"absolute inset-0 bg-black bg-opacity-50 transition-opacity cursor-pointer fondo-clickeable",onClick:g}))]),_:1}),f(X,{name:"carrito-slide",appear:""},{default:I(()=>[C.value?D("",!0):(m(),v("div",Oe,[e("div",Be,[e("div",We,[e("h2",ze,[f(t(h),{icon:t(Y),class:"text-blue-600"},null,8,["icon"]),r[2]||(r[2]=M(" Carrito de Compras "))]),e("button",{onClick:g,class:"text-gray-400 hover:text-gray-600 transition-colors"},[f(t(h),{icon:t(ce),class:"w-6 h-6"},null,8,["icon"])])]),e("div",He,[e("p",Le,y(t(c).itemCount)+" "+y(t(c).itemCount===1?"producto":"productos")+" en tu carrito ",1)]),e("div",Ue,[t(c).isEmpty?(m(),v("div",Ge,[f(t(h),{icon:t(ue),class:"w-16 h-16 text-gray-300 mb-4"},null,8,["icon"]),r[3]||(r[3]=e("h3",{class:"text-lg font-medium text-gray-900 mb-2"},"Tu carrito estÃ¡ vacÃ­o",-1)),r[4]||(r[4]=e("p",{class:"text-gray-500 mb-6"},"Agrega algunos productos para comenzar",-1)),e("button",{onClick:g,class:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-colors"}," Continuar Comprando ")])):(m(),v("div",Ke,[(m(!0),v(B,null,K(t(c).items,i=>(m(),v("div",{key:i.id,class:"flex items-center gap-4 p-4 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors producto-item"},[e("div",Je,[f(oe,{src:w(i),alt:i.nombre,"fallback-text":i.nombre,"container-class":"w-full h-full","image-class":"w-full h-full object-cover rounded-md border border-gray-200"},null,8,["src","alt","fallback-text"])]),e("div",Qe,[e("h4",Ye,y(i.nombre),1),e("p",Ze,y(l(i.precio)),1),e("p",et," Stock: "+y(i.stock_actual),1)]),e("div",tt,[e("button",{onClick:V=>t(c).decrementarCantidad(i.id),class:"w-8 h-8 flex items-center justify-center border border-gray-300 rounded-md hover:bg-gray-50 transition-colors cantidad-btn",disabled:i.cantidad<=1},[f(t(h),{icon:t(de),class:"w-3 h-3"},null,8,["icon"])],8,at),e("span",ot,y(i.cantidad),1),e("button",{onClick:V=>t(c).incrementarCantidad(i.id),class:"w-8 h-8 flex items-center justify-center border border-gray-300 rounded-md hover:bg-gray-50 transition-colors cantidad-btn",disabled:i.cantidad>=i.stock_actual},[f(t(h),{icon:t(me),class:"w-3 h-3"},null,8,["icon"])],8,st)]),e("button",{onClick:V=>t(c).eliminarProducto(i.id),class:"p-2 text-red-400 hover:text-red-600 transition-colors btn-eliminar",title:"Eliminar producto"},[f(t(h),{icon:t(U),class:"w-4 h-4"},null,8,["icon"])],8,rt)]))),128))]))]),t(c).isEmpty?D("",!0):(m(),v("div",nt,[e("button",{onClick:r[0]||(r[0]=i=>t(c).limpiarCarrito()),class:"w-full text-red-500 hover:text-red-700 hover:bg-red-50 py-2 px-4 text-sm transition-colors flex items-center justify-center gap-2 rounded-md border border-red-200 hover:border-red-300"},[f(t(h),{icon:t(U),class:"w-4 h-4"},null,8,["icon"]),r[5]||(r[5]=M(" Vaciar Carrito "))])])),t(c).isEmpty?D("",!0):(m(),v("div",lt,[e("div",it,[r[6]||(r[6]=e("span",{class:"text-lg font-semibold text-gray-900"},"Total:",-1)),e("span",ct,y(l(t(c).totalPrice)),1)]),e("div",ut,[e("button",{onClick:$,disabled:s.value,class:te(["w-full text-white py-3 px-4 rounded-md transition-colors flex items-center justify-center gap-2 font-medium btn-checkout",{loading:s.value}])},[s.value?D("",!0):(m(),ae(t(h),{key:0,icon:t(Q)},null,8,["icon"])),M(" "+y(s.value?"Procesando...":"Proceder al Checkout"),1)],10,dt),e("button",{onClick:g,class:"w-full text-white py-2 px-4 rounded-md transition-colors btn-continuar"}," Continuar Comprando ")])]))])]))]),_:1})])):D("",!0)]),_:1}),f(pe,{visible:F.value,"onUpdate:visible":r[1]||(r[1]=i=>F.value=i),onClienteGuardado:x},null,8,["visible"]),f(Xe,{"is-visible":b.value,"cliente-data":R.value,onClose:d,onPaymentCompleted:_},null,8,["is-visible","cliente-data"])],64))}},_t=Z(mt,[["__scopeId","data-v-fec53078"]]);export{_t as default};
