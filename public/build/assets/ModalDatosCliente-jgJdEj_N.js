import{a4 as J,r as x,E as Q,o as W,w as _,h as ee,d as f,x as I,e as t,q as y,t as c,I as ae,v as U,c as v,j as p,y as b,a7 as $,p as N,$ as m,a9 as oe,N as k}from"./vendor-CqKcGHPa.js";import{z as te,q as ie,A as P,g as le}from"./ui-CVJOYm3g.js";import{f as ne,av as se,g as re,H as de}from"./index-mhZfaEHg.js";import{z as ue}from"./vue-tel-input-J95PmLrS.js";import{_ as ce}from"./_plugin-vue_export-helper-DlAUqK2U.js";const me={class:"text-xl font-bold text-red-700 flex items-center gap-2"},fe={class:"py-4"},ve={class:"bg-blue-50 rounded-lg p-4 mb-6"},pe={class:"text-sm text-blue-700"},ge={class:"grid grid-cols-1 sm:grid-cols-2 gap-4"},xe={key:0,class:"text-red-500 text-xs"},ye=["value","maxlength","placeholder"],be={key:1,class:"text-red-500 text-xs"},_e={class:"grid grid-cols-1 sm:grid-cols-2 gap-4"},Ee={key:0,class:"text-red-500 text-xs"},Ve={key:0,class:"text-red-500 text-xs"},De={class:"grid grid-cols-1 sm:grid-cols-2 gap-4"},Ce={class:"mr-1"},Ne={key:1,class:"text-red-500 text-xs"},he={class:"sm:col-span-1"},je={key:0,class:"text-red-500 text-xs"},we={class:"flex justify-center gap-4 w-full mt-6"},Ae=["disabled"],Ie=["disabled"],Ue={__name:"ModalDatosCliente",props:{visible:{type:Boolean,default:!1},tieneClienteExistente:{type:Boolean,default:!1}},emits:["update:visible","cliente-guardado"],setup(S,{emit:B}){const E=S,w=B,L=J(),V=te(),g=x(!1);x([]),x(!0);const M=Q(()=>{var e;return(e=L.props.auth)==null?void 0:e.user}),o=x({numero_identificacion:"",fecha_nacimiento:null,genero:"",direccion:"",telefono:"",tipo_documento:"DUI"}),i=x({}),n=x({isValid:!1,country:null,formattedNumber:"",mensaje:""}),s=x({isValid:!0,mensaje:""});W(async()=>{});const F=()=>{w("update:visible",!1),Z()},Z=()=>{o.value={numero_identificacion:"",fecha_nacimiento:null,genero:"",direccion:"",telefono:"",tipo_documento:"DUI"},i.value={}},z=async e=>{try{e&&typeof e=="object"&&(n.value.isValid=e.valid===!0,n.value.country={name:e.country,code:e.countryCode},n.value.formattedNumber=e.formatted||"",e.valid===!0&&e.formatted&&(o.value.telefono=e.formatted),E.tieneClienteExistente?e.valid===!0?n.value.mensaje="Número válido (guardado previamente)":o.value.telefono&&e.valid===!1?n.value.mensaje="Número de teléfono inválido para "+e.country:n.value.mensaje="":o.value.telefono&&e.valid===!1?n.value.mensaje="Número de teléfono inválido para "+e.country:e.valid===!0?await G(o.value.telefono):n.value.mensaje="")}catch(a){console.error("[ModalDatosCliente] Error en validación:",a),n.value.mensaje="Error en validación"}},G=async e=>{var a,l;if(!(!e||e.length<8))try{const r=await k.post("/api/clientes/validar-telefono",{telefono:e});r.data.disponible?n.value.mensaje="Número válido para "+((a=n.value.country)==null?void 0:a.name):(n.value.isValid=!1,n.value.mensaje=r.data.message||"Este teléfono ya está registrado")}catch(r){console.error("[ModalDatosCliente] Error validando teléfono:",r),((l=r.response)==null?void 0:l.status)===401?n.value.mensaje="Error de autenticación":n.value.mensaje="Error al validar teléfono"}},T=async e=>{var a,l;if(!(!e||e.length<3))try{const r=await k.post("/api/clientes/validar-documento",{numero_identificacion:e});r.data.disponible?(s.value.mensaje="✓ Número de identificación disponible",s.value.isValid=!0):(s.value.isValid=!1,s.value.mensaje=r.data.message||"Este número de identificación ya está registrado")}catch(r){console.error("[ModalDatosCliente] Error validando documento:",r),s.value.isValid=!1,((a=r.response)==null?void 0:a.status)===403?s.value.mensaje="No tienes permisos para validar este documento":((l=r.response)==null?void 0:l.status)===401?s.value.mensaje="Error de autenticación":s.value.mensaje="Error al validar documento"}},Y=()=>{const e=new Date;return e.setFullYear(e.getFullYear()-18),e},R=e=>{if(!e)return{esValido:!0,mensaje:""};const a=new Date,l=new Date(e),r=a.getFullYear()-l.getFullYear(),d=l.getMonth(),h=l.getDate(),D=a.getMonth(),j=a.getDate(),C=r-(D<d||D===d&&j<h?1:0);return C<18?{esValido:!1,mensaje:`Debe ser mayor de edad (18 años). Edad actual: ${C} años`}:{esValido:!0,mensaje:""}},H=()=>{const e={};if(o.value.numero_identificacion?(A(),i.value.numero_identificacion&&(e.numero_identificacion=i.value.numero_identificacion)):e.numero_identificacion="El número de identificación es requerido",!o.value.fecha_nacimiento)e.fecha_nacimiento="La fecha de nacimiento es requerida";else{const a=R(o.value.fecha_nacimiento);a.esValido||(e.fecha_nacimiento=a.mensaje)}return o.value.genero||(e.genero="El género es requerido"),o.value.direccion||(e.direccion="La dirección es requerida"),o.value.telefono?n.value.isValid===!1&&(e.telefono=n.value.mensaje||"Por favor, ingrese un número de teléfono válido"):e.telefono="El número de teléfono es requerido",!E.tieneClienteExistente&&o.value.numero_identificacion&&!s.value.isValid&&(e.numero_identificacion=s.value.mensaje||"Este número de identificación no está disponible"),o.value.tipo_documento||(e.tipo_documento="El tipo de documento es requerido"),i.value=e,Object.keys(i.value).length===0},q=async()=>{var e,a,l,r,d,h,D,j,C;if(!H()){const u=Object.keys(i.value);u.length===1&&u[0]==="telefono"&&n.value.isValid===!1?V.add({severity:"warn",summary:"Teléfono ya registrado",detail:n.value.mensaje||"Este número de teléfono ya está registrado. Por favor, use un número diferente.",life:5e3}):V.add({severity:"error",summary:"Formulario incompleto",detail:"Por favor completa todos los campos requeridos",life:4e3});return}try{g.value=!0;const u=await k.post("/api/registro-cliente",o.value);V.add({severity:"success",summary:"Información guardada",detail:"Tus datos han sido guardados correctamente",life:3e3}),w("cliente-guardado",u.data.data||u.data),F()}catch(u){console.error("[ModalDatosCliente] Error al guardar cliente:",u),console.error("[ModalDatosCliente] Detalles del error:",(e=u.response)==null?void 0:e.data),(l=(a=u.response)==null?void 0:a.data)!=null&&l.errors&&(i.value=u.response.data.errors),(d=(r=u.response)==null?void 0:r.data)!=null&&d.message&&((D=(h=u.response)==null?void 0:h.data)!=null&&D.message.includes("formato"))&&(i.value.numero_identificacion=u.response.data.message),V.add({severity:"error",summary:"Error al guardar",detail:((C=(j=u.response)==null?void 0:j.data)==null?void 0:C.message)||"No se pudo guardar la información",life:5e3})}finally{g.value=!1}},K=e=>{const l=e.replace(/[^0-9]/g,"").substring(0,9);return l.length>8?l.substring(0,8)+"-"+l.substring(8):l},O=e=>e.toUpperCase().replace(/[^A-Z0-9]/g,"").substring(0,9),X=e=>{const a=e.target.value;let l="";o.value.tipo_documento==="DUI"?(l=K(a),o.value.numero_identificacion=l,e.target.value=l):o.value.tipo_documento==="PASAPORTE"&&(l=O(a),o.value.numero_identificacion=l,e.target.value=l),A(),o.value.numero_identificacion&&o.value.numero_identificacion.length>=3&&((o.value.tipo_documento==="DUI"&&/^\d{8}-\d{1}$/.test(o.value.numero_identificacion)||o.value.tipo_documento==="PASAPORTE"&&/^[A-Z0-9]{6,9}$/.test(o.value.numero_identificacion))&&!E.tieneClienteExistente?T(o.value.numero_identificacion):(s.value.mensaje="",s.value.isValid=!0))},A=()=>{if(!o.value.numero_identificacion){delete i.value.numero_identificacion;return}o.value.tipo_documento==="DUI"?/^\d{8}-\d{1}$/.test(o.value.numero_identificacion)?delete i.value.numero_identificacion:i.value.numero_identificacion="El DUI debe tener 9 dígitos (formato: 12345678-9)":o.value.tipo_documento==="PASAPORTE"&&(/^[A-Z0-9]{6,9}$/.test(o.value.numero_identificacion)?delete i.value.numero_identificacion:i.value.numero_identificacion="El PASAPORTE debe tener entre 6 y 9 caracteres (solo letras mayúsculas y números)")};return _(()=>o.value.numero_identificacion,e=>{A(),e&&e.length>=3&&(o.value.tipo_documento==="DUI"&&/^\d{8}-\d{1}$/.test(e)||o.value.tipo_documento==="PASAPORTE"&&/^[A-Z0-9]{6,9}$/.test(e))&&!E.tieneClienteExistente?T(e):(s.value.mensaje="",s.value.isValid=!0)}),_(()=>o.value.tipo_documento,()=>{o.value.numero_identificacion="",delete i.value.numero_identificacion,s.value.mensaje="",s.value.isValid=!0}),_(()=>o.value.fecha_nacimiento,e=>{if(e){const a=R(e);a.esValido?delete i.value.fecha_nacimiento:(i.value.fecha_nacimiento=a.mensaje,V.add({severity:"error",summary:"Edad insuficiente",detail:a.mensaje,life:4e3}))}}),_(()=>o.value.genero,e=>{e&&i.value.genero&&delete i.value.genero}),_(()=>o.value.direccion,e=>{e&&e.trim()&&i.value.direccion&&delete i.value.direccion}),_(()=>o.value.telefono,e=>{e&&i.value.telefono&&n.value.isValid&&delete i.value.telefono}),(e,a)=>(f(),ee(m(le),{visible:S.visible,"onUpdate:visible":a[5]||(a[5]=l=>w("update:visible",l)),modal:"",closable:!1,class:"max-w-2xl w-full mx-4",draggable:!1},{header:I(()=>[t("h3",me,[N(m(P),{icon:m(de)},null,8,["icon"]),a[6]||(a[6]=y(" Completar información de cliente "))])]),footer:I(()=>[t("div",we,[t("button",{type:"button",class:"bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",onClick:q,disabled:g.value},[N(m(P),{icon:g.value?m(ne):m(se),class:b(["h-5",{"animate-spin":g.value}])},null,8,["icon","class"]),y(" "+c(g.value?"Guardando...":"Guardar y Continuar"),1)],8,Ae),t("button",{type:"button",class:"bg-blue-500 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2",onClick:F,disabled:g.value},[N(m(P),{icon:m(re),class:"h-5"},null,8,["icon"]),a[19]||(a[19]=y(" Cancelar "))],8,Ie)])]),default:I(()=>{var l,r;return[t("div",fe,[t("div",ve,[a[9]||(a[9]=t("h4",{class:"font-semibold text-blue-800 mb-2"},"Información de tu cuenta:",-1)),t("div",pe,[t("p",null,[a[7]||(a[7]=t("strong",null,"Nombre:",-1)),y(" "+c((l=M.value)==null?void 0:l.name),1)]),t("p",null,[a[8]||(a[8]=t("strong",null,"Email:",-1)),y(" "+c((r=M.value)==null?void 0:r.email),1)])])]),t("form",{onSubmit:ae(q,["prevent"]),class:"space-y-4"},[t("div",ge,[t("div",null,[a[11]||(a[11]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Tipo de Documento",-1)),U(t("select",{"onUpdate:modelValue":a[0]||(a[0]=d=>o.value.tipo_documento=d),required:"",class:b(["w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",{"border-red-500":i.value.tipo_documento}])},a[10]||(a[10]=[t("option",{value:"",disabled:""},"Seleccione un tipo",-1),t("option",{value:"DUI"},"DUI",-1),t("option",{value:"PASAPORTE"},"PASAPORTE",-1)]),2),[[$,o.value.tipo_documento]]),i.value.tipo_documento?(f(),v("small",xe,c(i.value.tipo_documento),1)):p("",!0)]),t("div",null,[a[12]||(a[12]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Número de Identificación",-1)),t("input",{value:o.value.numero_identificacion,onInput:X,type:"text",required:"",maxlength:o.value.tipo_documento==="DUI"?10:9,class:b(["w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",{"border-red-500":i.value.numero_identificacion}]),placeholder:o.value.tipo_documento==="DUI"?"Ingrese 9 dígitos (ej: 123456789)":"Ingrese su PASAPORTE (ej: A1B2C3D4)"},null,42,ye),s.value.mensaje&&!E.tieneClienteExistente?(f(),v("p",{key:0,class:b(["text-xs mt-1",s.value.isValid?"text-green-600":"text-red-600"])},c(s.value.mensaje),3)):p("",!0),i.value.numero_identificacion&&!s.value.mensaje?(f(),v("small",be,c(i.value.numero_identificacion),1)):p("",!0)])]),t("div",_e,[t("div",null,[a[13]||(a[13]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Fecha de Nacimiento",-1)),N(m(ie),{modelValue:o.value.fecha_nacimiento,"onUpdate:modelValue":a[1]||(a[1]=d=>o.value.fecha_nacimiento=d),maxDate:Y(),"date-format":"dd/mm/yy",placeholder:"Seleccionar fecha de nacimiento (debe ser mayor de 18 años)",showIcon:"",yearNavigator:"",yearRange:"1920:2006",class:"w-full",inputClass:`w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 ${i.value.fecha_nacimiento?"border-red-500":""}`},null,8,["modelValue","maxDate","inputClass"]),i.value.fecha_nacimiento?(f(),v("small",Ee,c(i.value.fecha_nacimiento),1)):p("",!0)]),t("div",null,[a[15]||(a[15]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Género",-1)),U(t("select",{"onUpdate:modelValue":a[2]||(a[2]=d=>o.value.genero=d),required:"",class:b(["w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",{"border-red-500":i.value.genero}])},a[14]||(a[14]=[t("option",{value:""},"Seleccione",-1),t("option",{value:"MASCULINO"},"Masculino",-1),t("option",{value:"FEMENINO"},"Femenino",-1)]),2),[[$,o.value.genero]]),i.value.genero?(f(),v("small",Ve,c(i.value.genero),1)):p("",!0)])]),t("div",De,[t("div",null,[a[16]||(a[16]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Teléfono",-1)),N(m(ue),{modelValue:o.value.telefono,"onUpdate:modelValue":a[3]||(a[3]=d=>o.value.telefono=d),defaultCountry:"SV",preferredCountries:["SV","GT","HN","CR","NI","PA","BZ"],validCharactersOnly:!0,dropdownOptions:{showDialCodeInSelection:!0,showFlags:!0,showSearchBox:!0,showDialCodeInList:!0},inputOptions:{placeholder:"Número de teléfono"},mode:"international",class:"w-full border border-gray-300 rounded-lg",onValidate:z},null,8,["modelValue"]),n.value.mensaje?(f(),v("p",{key:0,class:b(["text-xs mt-1 flex items-center",n.value.isValid?"text-green-600":"text-red-600"])},[t("span",Ce,c(n.value.isValid?"✓":"⚠️"),1),y(" "+c(n.value.mensaje),1)],2)):p("",!0),i.value.telefono&&!n.value.mensaje?(f(),v("small",Ne,c(i.value.telefono),1)):p("",!0)]),t("div",he,[a[17]||(a[17]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Dirección",-1)),U(t("input",{"onUpdate:modelValue":a[4]||(a[4]=d=>o.value.direccion=d),type:"text",required:"",maxlength:"200",class:b(["w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",{"border-red-500":i.value.direccion}]),placeholder:"Dirección completa"},null,2),[[oe,o.value.direccion]]),i.value.direccion?(f(),v("small",je,c(i.value.direccion),1)):p("",!0)])]),a[18]||(a[18]=t("div",{class:"bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4"},[t("p",{class:"text-sm text-blue-800"},[t("strong",null,"Nota:"),y(" Esta información es necesaria para procesar tu compra. ")])],-1))],32)])]}),_:1},8,["visible"]))}},Te=ce(Ue,[["__scopeId","data-v-48275d44"]]);export{Te as default};
