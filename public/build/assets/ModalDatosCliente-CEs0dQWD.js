import{a4 as J,r as b,E as Q,o as W,w as _,h as ee,d as m,x as I,e as t,q as f,t as c,I as ae,v as k,c as v,j as p,y,a7 as q,p as N,$ as g,a9 as oe,N as U}from"./vendor-CqKcGHPa.js";import{z as te,q as ie,A as $,g as le}from"./ui-CVJOYm3g.js";import{f as ne,e as se,g as re}from"./index-CQ5n6JFv.js";import{z as de}from"./vue-tel-input-J95PmLrS.js";import{_ as ue}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ce={class:"py-4"},me={class:"bg-blue-50 rounded-lg p-4 mb-6"},fe={class:"text-sm text-blue-700"},ve={class:"grid grid-cols-1 sm:grid-cols-2 gap-4"},pe={key:0,class:"text-red-500 text-xs"},ge=["value","maxlength","placeholder"],xe={key:1,class:"text-red-500 text-xs"},be={class:"grid grid-cols-1 sm:grid-cols-2 gap-4"},ye={key:0,class:"text-red-500 text-xs"},_e={key:0,class:"text-red-500 text-xs"},Ee={class:"grid grid-cols-1 sm:grid-cols-2 gap-4"},Ve={class:"mr-1"},De={key:1,class:"text-red-500 text-xs"},Ce={class:"sm:col-span-1"},je={key:0,class:"text-red-500 text-xs"},he={class:"flex justify-center gap-4 w-full mt-4"},Ne=["disabled"],we=["disabled"],Ae={__name:"ModalDatosCliente",props:{visible:{type:Boolean,default:!1},tieneClienteExistente:{type:Boolean,default:!1}},emits:["update:visible","cliente-guardado"],setup(P,{emit:B}){const E=P,w=B,L=J(),V=te(),x=b(!1);b([]),b(!0);const M=Q(()=>{var e;return(e=L.props.auth)==null?void 0:e.user}),o=b({numero_identificacion:"",fecha_nacimiento:null,genero:"",direccion:"",telefono:"",tipo_documento:"DUI"}),i=b({}),n=b({isValid:!1,country:null,formattedNumber:"",mensaje:""}),s=b({isValid:!0,mensaje:""});W(async()=>{});const S=()=>{w("update:visible",!1),Y()},Y=()=>{o.value={numero_identificacion:"",fecha_nacimiento:null,genero:"",direccion:"",telefono:"",tipo_documento:"DUI"},i.value={}},Z=async e=>{try{e&&typeof e=="object"&&(n.value.isValid=e.valid===!0,n.value.country={name:e.country,code:e.countryCode},n.value.formattedNumber=e.formatted||"",e.valid===!0&&e.formatted&&(o.value.telefono=e.formatted),E.tieneClienteExistente?e.valid===!0?n.value.mensaje="Número válido (guardado previamente)":o.value.telefono&&e.valid===!1?n.value.mensaje="Número de teléfono inválido para "+e.country:n.value.mensaje="":o.value.telefono&&e.valid===!1?n.value.mensaje="Número de teléfono inválido para "+e.country:e.valid===!0?await z(o.value.telefono):n.value.mensaje="")}catch(a){console.error("[ModalDatosCliente] Error en validación:",a),n.value.mensaje="Error en validación"}},z=async e=>{var a,l;if(!(!e||e.length<8))try{const r=await U.post("/api/clientes/validar-telefono",{telefono:e});r.data.disponible?n.value.mensaje="Número válido para "+((a=n.value.country)==null?void 0:a.name):(n.value.isValid=!1,n.value.mensaje=r.data.message||"Este teléfono ya está registrado")}catch(r){console.error("[ModalDatosCliente] Error validando teléfono:",r),((l=r.response)==null?void 0:l.status)===401?n.value.mensaje="Error de autenticación":n.value.mensaje="Error al validar teléfono"}},F=async e=>{var a,l;if(!(!e||e.length<3))try{const r=await U.post("/api/clientes/validar-documento",{numero_identificacion:e});r.data.disponible?(s.value.mensaje="✓ Número de identificación disponible",s.value.isValid=!0):(s.value.isValid=!1,s.value.mensaje=r.data.message||"Este número de identificación ya está registrado")}catch(r){console.error("[ModalDatosCliente] Error validando documento:",r),s.value.isValid=!1,((a=r.response)==null?void 0:a.status)===403?s.value.mensaje="No tienes permisos para validar este documento":((l=r.response)==null?void 0:l.status)===401?s.value.mensaje="Error de autenticación":s.value.mensaje="Error al validar documento"}},G=()=>{const e=new Date;return e.setFullYear(e.getFullYear()-18),e},T=e=>{if(!e)return{esValido:!0,mensaje:""};const a=new Date,l=new Date(e),r=a.getFullYear()-l.getFullYear(),d=l.getMonth(),j=l.getDate(),D=a.getMonth(),h=a.getDate(),C=r-(D<d||D===d&&h<j?1:0);return C<18?{esValido:!1,mensaje:`Debe ser mayor de edad (18 años). Edad actual: ${C} años`}:{esValido:!0,mensaje:""}},H=()=>{const e={};if(o.value.numero_identificacion?(A(),i.value.numero_identificacion&&(e.numero_identificacion=i.value.numero_identificacion)):e.numero_identificacion="El número de identificación es requerido",!o.value.fecha_nacimiento)e.fecha_nacimiento="La fecha de nacimiento es requerida";else{const a=T(o.value.fecha_nacimiento);a.esValido||(e.fecha_nacimiento=a.mensaje)}return o.value.genero||(e.genero="El género es requerido"),o.value.direccion||(e.direccion="La dirección es requerida"),o.value.telefono?n.value.isValid===!1&&(e.telefono=n.value.mensaje||"Por favor, ingrese un número de teléfono válido"):e.telefono="El número de teléfono es requerido",!E.tieneClienteExistente&&o.value.numero_identificacion&&!s.value.isValid&&(e.numero_identificacion=s.value.mensaje||"Este número de identificación no está disponible"),o.value.tipo_documento||(e.tipo_documento="El tipo de documento es requerido"),i.value=e,Object.keys(i.value).length===0},R=async()=>{var e,a,l,r,d,j,D,h,C;if(!H()){const u=Object.keys(i.value);u.length===1&&u[0]==="telefono"&&n.value.isValid===!1?V.add({severity:"warn",summary:"Teléfono ya registrado",detail:n.value.mensaje||"Este número de teléfono ya está registrado. Por favor, use un número diferente.",life:5e3}):V.add({severity:"error",summary:"Formulario incompleto",detail:"Por favor completa todos los campos requeridos",life:4e3});return}try{x.value=!0;const u=await U.post("/api/registro-cliente",o.value);V.add({severity:"success",summary:"Información guardada",detail:"Tus datos han sido guardados correctamente",life:3e3}),w("cliente-guardado",u.data.data||u.data),S()}catch(u){console.error("[ModalDatosCliente] Error al guardar cliente:",u),console.error("[ModalDatosCliente] Detalles del error:",(e=u.response)==null?void 0:e.data),(l=(a=u.response)==null?void 0:a.data)!=null&&l.errors&&(i.value=u.response.data.errors),(d=(r=u.response)==null?void 0:r.data)!=null&&d.message&&((D=(j=u.response)==null?void 0:j.data)!=null&&D.message.includes("formato"))&&(i.value.numero_identificacion=u.response.data.message),V.add({severity:"error",summary:"Error al guardar",detail:((C=(h=u.response)==null?void 0:h.data)==null?void 0:C.message)||"No se pudo guardar la información",life:5e3})}finally{x.value=!1}},K=e=>{const l=e.replace(/[^0-9]/g,"").substring(0,9);return l.length>8?l.substring(0,8)+"-"+l.substring(8):l},O=e=>e.toUpperCase().replace(/[^A-Z0-9]/g,"").substring(0,9),X=e=>{const a=e.target.value;let l="";o.value.tipo_documento==="DUI"?(l=K(a),o.value.numero_identificacion=l,e.target.value=l):o.value.tipo_documento==="PASAPORTE"&&(l=O(a),o.value.numero_identificacion=l,e.target.value=l),A(),o.value.numero_identificacion&&o.value.numero_identificacion.length>=3&&((o.value.tipo_documento==="DUI"&&/^\d{8}-\d{1}$/.test(o.value.numero_identificacion)||o.value.tipo_documento==="PASAPORTE"&&/^[A-Z0-9]{6,9}$/.test(o.value.numero_identificacion))&&!E.tieneClienteExistente?F(o.value.numero_identificacion):(s.value.mensaje="",s.value.isValid=!0))},A=()=>{if(!o.value.numero_identificacion){delete i.value.numero_identificacion;return}o.value.tipo_documento==="DUI"?/^\d{8}-\d{1}$/.test(o.value.numero_identificacion)?delete i.value.numero_identificacion:i.value.numero_identificacion="El DUI debe tener 9 dígitos (formato: 12345678-9)":o.value.tipo_documento==="PASAPORTE"&&(/^[A-Z0-9]{6,9}$/.test(o.value.numero_identificacion)?delete i.value.numero_identificacion:i.value.numero_identificacion="El PASAPORTE debe tener entre 6 y 9 caracteres (solo letras mayúsculas y números)")};return _(()=>o.value.numero_identificacion,e=>{A(),e&&e.length>=3&&(o.value.tipo_documento==="DUI"&&/^\d{8}-\d{1}$/.test(e)||o.value.tipo_documento==="PASAPORTE"&&/^[A-Z0-9]{6,9}$/.test(e))&&!E.tieneClienteExistente?F(e):(s.value.mensaje="",s.value.isValid=!0)}),_(()=>o.value.tipo_documento,()=>{o.value.numero_identificacion="",delete i.value.numero_identificacion,s.value.mensaje="",s.value.isValid=!0}),_(()=>o.value.fecha_nacimiento,e=>{if(e){const a=T(e);a.esValido?delete i.value.fecha_nacimiento:(i.value.fecha_nacimiento=a.mensaje,V.add({severity:"error",summary:"Edad insuficiente",detail:a.mensaje,life:4e3}))}}),_(()=>o.value.genero,e=>{e&&i.value.genero&&delete i.value.genero}),_(()=>o.value.direccion,e=>{e&&e.trim()&&i.value.direccion&&delete i.value.direccion}),_(()=>o.value.telefono,e=>{e&&i.value.telefono&&n.value.isValid&&delete i.value.telefono}),(e,a)=>(m(),ee(g(le),{visible:P.visible,"onUpdate:visible":a[5]||(a[5]=l=>w("update:visible",l)),modal:"",closable:!1,class:"max-w-2xl w-full mx-4",draggable:!1},{header:I(()=>a[6]||(a[6]=[t("h3",{class:"text-xl font-bold text-blue-700 gap-2 text-center justify-center w-full"}," Completar información de cliente ",-1)])),footer:I(()=>[t("div",he,[t("button",{type:"button",class:"bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",onClick:R,disabled:x.value},[N(g($),{icon:x.value?g(ne):g(se),class:y(["h-5",{"animate-spin":x.value}])},null,8,["icon","class"]),f(" "+c(x.value?"Guardando...":"Continuar"),1)],8,Ne),t("button",{type:"button",class:"bg-blue-500 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-all duration-200 ease-in-out flex items-center gap-2",onClick:S,disabled:x.value},[N(g($),{icon:g(re),class:"h-5"},null,8,["icon"]),a[19]||(a[19]=f(" Cancelar "))],8,we)])]),default:I(()=>{var l,r;return[t("div",ce,[t("div",me,[a[9]||(a[9]=t("h4",{class:"font-semibold text-blue-800 mb-2 text-center justify-center w-full"},"Información de tu cuenta",-1)),t("div",fe,[t("p",null,[a[7]||(a[7]=t("strong",null,"Nombre:",-1)),f(" "+c((l=M.value)==null?void 0:l.name),1)]),t("p",null,[a[8]||(a[8]=t("strong",null,"Email:",-1)),f(" "+c((r=M.value)==null?void 0:r.email),1)])])]),t("form",{onSubmit:ae(R,["prevent"]),class:"space-y-4"},[t("div",ve,[t("div",null,[a[11]||(a[11]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Documento de identidad",-1)),k(t("select",{"onUpdate:modelValue":a[0]||(a[0]=d=>o.value.tipo_documento=d),required:"",class:y(["w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",{"border-red-500":i.value.tipo_documento}])},a[10]||(a[10]=[t("option",{value:"",disabled:""},"Seleccione un tipo",-1),t("option",{value:"DUI"},"DUI",-1),t("option",{value:"PASAPORTE"},"PASAPORTE",-1)]),2),[[q,o.value.tipo_documento]]),i.value.tipo_documento?(m(),v("small",pe,c(i.value.tipo_documento),1)):p("",!0)]),t("div",null,[a[12]||(a[12]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Número de identificación",-1)),t("input",{value:o.value.numero_identificacion,onInput:X,type:"text",required:"",maxlength:o.value.tipo_documento==="DUI"?10:9,class:y(["w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",{"border-red-500":i.value.numero_identificacion}]),placeholder:o.value.tipo_documento==="DUI"?"Ingrese 9 dígitos (ej: 123456789)":"Ingrese su PASAPORTE (ej: A1B2C3D4)"},null,42,ge),s.value.mensaje&&!E.tieneClienteExistente?(m(),v("p",{key:0,class:y(["text-xs mt-1",s.value.isValid?"text-green-600":"text-red-600"])},c(s.value.mensaje),3)):p("",!0),i.value.numero_identificacion&&!s.value.mensaje?(m(),v("small",xe,c(i.value.numero_identificacion),1)):p("",!0)])]),t("div",be,[t("div",null,[a[13]||(a[13]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Fecha de nacimiento",-1)),N(g(ie),{modelValue:o.value.fecha_nacimiento,"onUpdate:modelValue":a[1]||(a[1]=d=>o.value.fecha_nacimiento=d),maxDate:G(),"date-format":"dd/mm/yy",placeholder:"Seleccionar fecha de nacimiento (debe ser mayor de 18 años)",showIcon:"",yearNavigator:"",yearRange:"1920:2006",class:"w-full",inputClass:`w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 ${i.value.fecha_nacimiento?"border-red-500":""}`},null,8,["modelValue","maxDate","inputClass"]),i.value.fecha_nacimiento?(m(),v("small",ye,c(i.value.fecha_nacimiento),1)):p("",!0)]),t("div",null,[a[15]||(a[15]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Género",-1)),k(t("select",{"onUpdate:modelValue":a[2]||(a[2]=d=>o.value.genero=d),required:"",class:y(["w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",{"border-red-500":i.value.genero}])},a[14]||(a[14]=[t("option",{value:""},"Seleccione",-1),t("option",{value:"MASCULINO"},"Masculino",-1),t("option",{value:"FEMENINO"},"Femenino",-1)]),2),[[q,o.value.genero]]),i.value.genero?(m(),v("small",_e,c(i.value.genero),1)):p("",!0)])]),t("div",Ee,[t("div",null,[a[16]||(a[16]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Teléfono",-1)),N(g(de),{modelValue:o.value.telefono,"onUpdate:modelValue":a[3]||(a[3]=d=>o.value.telefono=d),defaultCountry:"SV",preferredCountries:["SV","GT","HN","CR","NI","PA","BZ"],validCharactersOnly:!0,dropdownOptions:{showDialCodeInSelection:!0,showFlags:!0,showSearchBox:!0,showDialCodeInList:!0},inputOptions:{placeholder:"Número de teléfono"},mode:"international",class:"w-full border border-gray-300 rounded-lg",onValidate:Z},null,8,["modelValue"]),n.value.mensaje?(m(),v("p",{key:0,class:y(["text-xs mt-1 flex items-center",n.value.isValid?"text-green-600":"text-red-600"])},[t("span",Ve,c(n.value.isValid?"✓":"⚠️"),1),f(" "+c(n.value.mensaje),1)],2)):p("",!0),i.value.telefono&&!n.value.mensaje?(m(),v("small",De,c(i.value.telefono),1)):p("",!0)]),t("div",Ce,[a[17]||(a[17]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Dirección de residencia",-1)),k(t("input",{"onUpdate:modelValue":a[4]||(a[4]=d=>o.value.direccion=d),type:"text",required:"",maxlength:"200",class:y(["w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",{"border-red-500":i.value.direccion}]),placeholder:"Dirección completa"},null,2),[[oe,o.value.direccion]]),i.value.direccion?(m(),v("small",je,c(i.value.direccion),1)):p("",!0)])]),a[18]||(a[18]=t("div",{class:"bg-blue-50 border border-blue-200 rounded-lg p-3"},[t("p",{class:"text-xs text-blue-800"},[t("strong",null,"Nota:"),f(" Esta información es necesaria para procesar tu compra. "),t("br"),f(" En tu primera compra, se creará automáticamente una cuenta de cliente con estos datos. "),t("br"),f(" Ya no necesitarás completar este formulario en futuras compras. ")])],-1))],32)])]}),_:1},8,["visible"]))}},Se=ue(Ae,[["__scopeId","data-v-76e86e94"]]);export{Se as default};
