import{r as w,N as W,a4 as O,E as I,w as X,c as p,j as V,d as f,e,p as u,q as E,$ as s,t as b,I as q,F as D,l as L}from"./vendor-BOi6Gr0G.js";import{u as A}from"./carrito-DTsTdRNW.js";import{A as g}from"./ui-BibPgP1I.js";import{I as U}from"./ImageWithFallback-B9m-8y9a.js";import{a8 as B,z as K,g as G,a9 as J,aa as Q,ab as Y,ac as Z,d as ee,ad as se,ae as te,a as oe,u as z}from"./index-B7S65CUL.js";import{_ as H}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./app-BGNGPSMa.js";function ae(){const C=w(!1),n=w(null),S=A(),v=W.create(),y=document.head.querySelector('meta[name="csrf-token"]');return console.log("ðŸ”’ Debug CSRF:",{metaTag:y,tokenContent:y==null?void 0:y.content,documentHead:document.head.innerHTML.substring(0,500)}),y?(v.defaults.headers.common["X-CSRF-TOKEN"]=y.content,console.log("âœ… Token CSRF configurado:",y.content)):console.error("âŒ Token CSRF NO encontrado"),v.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",{loading:C,error:n,createVentaFromCarrito:async d=>{var m,o,t,r,l,h,T,j,N;C.value=!0,n.value=null;try{const x={productos:S.items.map(F=>({id:F.id,cantidad:F.cantidad,precio:F.precio,nombre:F.nombre})),customer_email:d};console.log("ðŸ›’ Datos del carrito a enviar:",{payload:x,carritoItems:S.items,customerEmail:d}),console.log("ðŸ“¡ Headers a enviar:",v.defaults.headers.common);const k=await v.post("/carrito/create-venta",x);if(k.data.success)return{success:!0,venta:k.data.venta,message:k.data.message};throw new Error(k.data.message||"Error desconocido")}catch(c){console.error("Error creando venta desde carrito:",c),console.error("ðŸ“‹ Detalles del error:",{status:(m=c.response)==null?void 0:m.status,statusText:(o=c.response)==null?void 0:o.statusText,data:(t=c.response)==null?void 0:t.data,headers:(r=c.response)==null?void 0:r.headers}),(l=c.response)!=null&&l.data&&(console.error("ðŸ” Respuesta del servidor:",c.response.data),c.response.data.errors&&console.error("âŒ Errores de validaciÃ³n:",c.response.data.errors),c.response.data.message&&console.error("ðŸ’¬ Mensaje del servidor:",c.response.data.message));let x="Error al crear la venta";return(T=(h=c.response)==null?void 0:h.data)!=null&&T.message?x=c.response.data.message:(N=(j=c.response)==null?void 0:j.data)!=null&&N.errors?x=Object.values(c.response.data.errors).flat().join(", "):c.message&&(x=c.message),n.value=x,{success:!1,error:x}}finally{C.value=!1}},procesarPagoVenta:async d=>{var m,o,t,r;C.value=!0,n.value=null;try{const l=await v.post("/pagos/venta",d);if(l.data.success)return{success:!0,pago:l.data.pago,wompi_data:l.data.wompi_data,message:l.data.message};throw new Error(l.data.message||"Error en el pago")}catch(l){console.error("Error procesando pago:",l);let h="Error al procesar el pago";return(o=(m=l.response)==null?void 0:m.data)!=null&&o.message?h=l.response.data.message:(r=(t=l.response)==null?void 0:t.data)!=null&&r.errors?h=Object.values(l.response.data.errors).flat().join(", "):l.message&&(h=l.message),n.value=h,{success:!1,error:h}}finally{C.value=!1}},consultarEstadoPago:async d=>{var m,o;try{const t=await v.get(`/pagos/${d}/estado`);if(t.data.success)return{success:!0,pago:t.data.pago};throw new Error(t.data.message||"Error consultando estado")}catch(t){return console.error("Error consultando estado del pago:",t),{success:!1,error:((o=(m=t.response)==null?void 0:m.data)==null?void 0:o.message)||t.message||"Error consultando estado"}}}}}const re={class:"modal-header"},ne={class:"modal-title"},le={key:0,class:"loading-state"},ie={key:1,class:"error-state"},ce={key:2,class:"payment-form"},de={class:"purchase-summary"},ue={class:"summary-details"},me={class:"total-amount"},pe={class:"amount"},fe={class:"order-reference"},ve={class:"reference"},ge={class:"payment-section"},be=["disabled"],ye={key:0,class:"w-6 h-6 mr-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},he={key:1,class:"w-6 h-6 mr-3 animate-spin",fill:"none",viewBox:"0 0 24 24"},xe={class:"payment-info"},Ce={class:"info-item"},ke={class:"info-item"},_e={key:3,class:"success-state"},we={class:"success-details"},$e={__name:"CarritoCheckoutModal",props:{isVisible:{type:Boolean,default:!1}},emits:["close","payment-completed"],setup(C,{emit:n}){const S=C,v=n,{createVentaFromCarrito:y}=ae(),P=A(),M=O(),$=w(!1),d=w(null),m=w(!1),o=w(null),t=w(!1),r=I(()=>{var i;return(i=M.props.auth)==null?void 0:i.user}),l=I(()=>{var i;return((i=r.value)==null?void 0:i.email)||""}),h=I(()=>{var i;return((i=r.value)==null?void 0:i.name)||""}),T=i=>i?new Intl.NumberFormat("es-CO",{minimumFractionDigits:2,maximumFractionDigits:2}).format(i):"0.00";X(()=>S.isVisible,async i=>{i&&!d.value&&!m.value&&await j()});const j=async()=>{if(P.isEmpty){o.value="El carrito estÃ¡ vacÃ­o";return}if(!l.value){o.value="No se encontrÃ³ informaciÃ³n del usuario";return}$.value=!0,o.value=null;try{const i=await y(l.value);i.success?d.value=i.venta:o.value=i.error||"Error creando la venta"}catch(i){o.value="Error inesperado al crear la venta",console.error("Error creando venta:",i)}finally{$.value=!1}},N=async()=>{var i;if(!d.value){o.value="No hay venta creada";return}t.value=!0,o.value=null;try{const a=(i=document.querySelector('meta[name="csrf-token"]'))==null?void 0:i.getAttribute("content"),_=await(await fetch("/api/wompi/payment-link",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":a,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({venta_id:d.value.id,customer_email:l.value,customer_name:h.value})})).json();_.success?(window.open(_.payment_link,"_blank"),m.value=!0,v("payment-completed",{success:!0,venta:d.value,payment_link:_.payment_link,reference:_.reference})):o.value=_.message||"Error creando enlace de pago"}catch(a){console.error("Error procesando pago:",a),o.value="Error procesando el pago. IntÃ©ntalo de nuevo."}finally{t.value=!1}},c=()=>{v("close"),k()},x=()=>{P.limpiarCarrito(),c()},k=()=>{d.value=null,m.value=!1,o.value=null,$.value=!1},F=()=>{k(),j()};return(i,a)=>{var R,_;return C.isVisible?(f(),p("div",{key:0,class:"modal-overlay",onClick:c},[e("div",{class:"modal-container",onClick:a[0]||(a[0]=q(()=>{},["stop"]))},[e("div",re,[e("h3",ne,[u(s(g),{icon:s(B),class:"title-icon"},null,8,["icon"]),a[1]||(a[1]=E(" Finalizar Compra "))]),e("button",{onClick:c,class:"close-button"},[u(s(g),{icon:s(K)},null,8,["icon"])])]),$.value?(f(),p("div",le,a[2]||(a[2]=[e("div",{class:"spinner"},null,-1),e("p",null,"Procesando tu pedido...",-1)]))):o.value?(f(),p("div",ie,[u(s(g),{icon:s(G),class:"error-icon"},null,8,["icon"]),a[3]||(a[3]=e("h4",null,"Error al procesar",-1)),e("p",null,b(o.value),1),e("button",{onClick:F,class:"retry-button"}," Intentar de nuevo ")])):d.value?(f(),p("div",ce,[e("div",de,[a[6]||(a[6]=e("h4",null,"Resumen de tu compra",-1)),e("div",ue,[e("div",me,[a[4]||(a[4]=e("span",null,"Total a pagar:",-1)),e("span",pe,"$"+b(T(d.value.total)),1)]),e("div",fe,[a[5]||(a[5]=e("span",null,"NÃºmero de orden:",-1)),e("span",ve,"#"+b(d.value.id),1)])])]),e("div",ge,[e("button",{onClick:N,disabled:t.value,class:"w-full inline-flex items-center justify-center px-6 py-4 border border-transparent text-lg font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"},[t.value?(f(),p("svg",he,a[8]||(a[8]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)]))):(f(),p("svg",ye,a[7]||(a[7]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"},null,-1)]))),E(" "+b(t.value?"Generando enlace de pago...":"Pagar con Wompi"),1)],8,be)]),e("div",xe,[e("div",Ce,[u(s(g),{icon:s(J),class:"info-icon"},null,8,["icon"]),a[9]||(a[9]=e("span",null,"Pago seguro con encriptaciÃ³n SSL",-1))]),e("div",ke,[u(s(g),{icon:s(Q),class:"info-icon"},null,8,["icon"]),a[10]||(a[10]=e("span",null,"Procesamiento inmediato",-1))])])])):m.value?(f(),p("div",_e,[u(s(g),{icon:s(Y),class:"success-icon"},null,8,["icon"]),a[13]||(a[13]=e("h4",null,"Â¡Pago exitoso!",-1)),a[14]||(a[14]=e("p",null,"Tu compra ha sido procesada correctamente.",-1)),e("div",we,[e("p",null,[a[11]||(a[11]=e("strong",null,"NÃºmero de orden:",-1)),E(" #"+b((R=d.value)==null?void 0:R.id),1)]),e("p",null,[a[12]||(a[12]=e("strong",null,"Total pagado:",-1)),E(" $"+b(T((_=d.value)==null?void 0:_.total)),1)])]),e("button",{onClick:x,class:"success-button"}," Finalizar ")])):V("",!0)])])):V("",!0)}}},Ee=H($e,[["__scopeId","data-v-deee4043"]]),Se={class:"absolute right-0 top-0 h-full w-full max-w-md transform transition-transform carrito-panel"},Pe={class:"flex h-full flex-col bg-white shadow-xl"},Te={class:"flex items-center justify-between border-b border-gray-200 px-6 py-4"},Fe={class:"text-lg font-semibold text-gray-900 flex items-center gap-2"},je={class:"px-6 py-2 bg-blue-50 border-b border-blue-100"},Ve={class:"text-sm text-blue-800"},Me={class:"flex-1 overflow-y-auto px-6 py-4 carrito-scroll"},Ne={key:0,class:"flex flex-col items-center justify-center h-full text-center empty-state"},Ie={key:1,class:"space-y-4"},Re={class:"flex-shrink-0 w-16 h-16 producto-imagen"},Ae={class:"flex-1 min-w-0"},De={class:"text-sm font-medium text-gray-900 truncate"},ze={class:"text-sm text-blue-600 font-semibold"},Oe={class:"text-xs text-gray-500 whitespace-nowrap"},qe={class:"flex items-center gap-2"},Be=["onClick","disabled"],He={class:"w-8 text-center text-sm font-medium"},We=["onClick","disabled"],Xe=["onClick"],Le={key:0,class:"px-6 py-3 border-t border-gray-100"},Ue={key:1,class:"border-t border-gray-200 px-6 py-4 space-y-4"},Ke={class:"flex items-center justify-between"},Ge={class:"text-xl font-bold text-blue-600 total-badge"},Je={class:"space-y-2"},Qe={__name:"CarritoCompras",setup(C){const n=A(),S=O(),v=w(!1),y=I(()=>{var o;return!!((o=S.props.auth)!=null&&o.user)}),P=o=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(o),M=()=>{if(!y.value){alert("Debes iniciar sesiÃ³n para continuar con la compra");return}if(n.isEmpty){alert("Tu carrito estÃ¡ vacÃ­o");return}v.value=!0},$=()=>{v.value=!1},d=o=>{console.log("Pago completado:",o),v.value=!1},m=o=>o.imagen?o.imagen.startsWith("http")||o.imagen.startsWith("data:")?o.imagen:`/storage/productos/${o.imagen}`:null;return(o,t)=>(f(),p(D,null,[s(n).isVisible?(f(),p("div",{key:0,class:"fixed inset-0 z-[10000] overflow-hidden carrito-overlay",onClick:t[5]||(t[5]=q(r=>s(n).ocultarCarrito(),["self"]))},[e("div",{class:"absolute inset-0 bg-black bg-opacity-50 transition-opacity cursor-pointer fondo-clickeable",onClick:t[0]||(t[0]=r=>s(n).ocultarCarrito())}),e("div",Se,[e("div",Pe,[e("div",Te,[e("h2",Fe,[u(s(g),{icon:s(Z),class:"text-blue-600"},null,8,["icon"]),t[6]||(t[6]=E(" Carrito de Compras "))]),e("button",{onClick:t[1]||(t[1]=r=>s(n).ocultarCarrito()),class:"text-gray-400 hover:text-gray-600 transition-colors"},[u(s(g),{icon:s(ee),class:"w-6 h-6"},null,8,["icon"])])]),e("div",je,[e("p",Ve,b(s(n).itemCount)+" "+b(s(n).itemCount===1?"producto":"productos")+" en tu carrito ",1)]),e("div",Me,[s(n).isEmpty?(f(),p("div",Ne,[u(s(g),{icon:s(se),class:"w-16 h-16 text-gray-300 mb-4"},null,8,["icon"]),t[7]||(t[7]=e("h3",{class:"text-lg font-medium text-gray-900 mb-2"},"Tu carrito estÃ¡ vacÃ­o",-1)),t[8]||(t[8]=e("p",{class:"text-gray-500 mb-6"},"Agrega algunos productos para comenzar",-1)),e("button",{onClick:t[2]||(t[2]=r=>s(n).ocultarCarrito()),class:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-colors"}," Continuar Comprando ")])):(f(),p("div",Ie,[(f(!0),p(D,null,L(s(n).items,r=>(f(),p("div",{key:r.id,class:"flex items-center gap-4 p-4 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors producto-item"},[e("div",Re,[u(U,{src:m(r),alt:r.nombre,"fallback-text":r.nombre,"container-class":"w-full h-full","image-class":"w-full h-full object-cover rounded-md border border-gray-200"},null,8,["src","alt","fallback-text"])]),e("div",Ae,[e("h4",De,b(r.nombre),1),e("p",ze,b(P(r.precio)),1),e("p",Oe," Stock: "+b(r.stock_actual),1)]),e("div",qe,[e("button",{onClick:l=>s(n).decrementarCantidad(r.id),class:"w-8 h-8 flex items-center justify-center border border-gray-300 rounded-md hover:bg-gray-50 transition-colors cantidad-btn",disabled:r.cantidad<=1},[u(s(g),{icon:s(te),class:"w-3 h-3"},null,8,["icon"])],8,Be),e("span",He,b(r.cantidad),1),e("button",{onClick:l=>s(n).incrementarCantidad(r.id),class:"w-8 h-8 flex items-center justify-center border border-gray-300 rounded-md hover:bg-gray-50 transition-colors cantidad-btn",disabled:r.cantidad>=r.stock_actual},[u(s(g),{icon:s(oe),class:"w-3 h-3"},null,8,["icon"])],8,We)]),e("button",{onClick:l=>s(n).eliminarProducto(r.id),class:"p-2 text-red-400 hover:text-red-600 transition-colors btn-eliminar",title:"Eliminar producto"},[u(s(g),{icon:s(z),class:"w-4 h-4"},null,8,["icon"])],8,Xe)]))),128))]))]),s(n).isEmpty?V("",!0):(f(),p("div",Le,[e("button",{onClick:t[3]||(t[3]=r=>s(n).limpiarCarrito()),class:"w-full text-red-500 hover:text-red-700 hover:bg-red-50 py-2 px-4 text-sm transition-colors flex items-center justify-center gap-2 rounded-md border border-red-200 hover:border-red-300"},[u(s(g),{icon:s(z),class:"w-4 h-4"},null,8,["icon"]),t[9]||(t[9]=E(" Vaciar Carrito "))])])),s(n).isEmpty?V("",!0):(f(),p("div",Ue,[e("div",Ke,[t[10]||(t[10]=e("span",{class:"text-lg font-semibold text-gray-900"},"Total:",-1)),e("span",Ge,b(P(s(n).totalPrice)),1)]),e("div",Je,[e("button",{onClick:M,class:"w-full text-white py-3 px-4 rounded-md transition-colors flex items-center justify-center gap-2 font-medium btn-checkout"},[u(s(g),{icon:s(B)},null,8,["icon"]),t[11]||(t[11]=E(" Proceder al Checkout "))]),e("button",{onClick:t[4]||(t[4]=r=>s(n).ocultarCarrito()),class:"w-full text-white py-2 px-4 rounded-md transition-colors btn-continuar"}," Continuar Comprando ")])]))])])])):V("",!0),u(Ee,{"is-visible":v.value,onClose:$,onPaymentCompleted:d},null,8,["is-visible"])],64))}},rs=H(Qe,[["__scopeId","data-v-4fc9e6a8"]]);export{rs as default};
