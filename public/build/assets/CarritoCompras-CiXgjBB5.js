import{r as $,N as L,a4 as K,E as N,w as ee,c as p,j as P,d as f,e,p as m,q as F,$ as t,t as g,F as W,l as G,I as J,x as X,B as D}from"./vendor-B6SkOXHv.js";import{u as B}from"./carrito-DC_iBeuq.js";import{D as b}from"./ui-IQIjmUCy.js";import{I as te}from"./ImageWithFallback-C00cxIeu.js";import{al as Q,w as se,h as oe,am as ae,ab as re,t as ne,ac as Y,g as le,an as ie,x as ce,b as de,a9 as U}from"./index-CWeCUdu2.js";import{_ as Z}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./app-BnNMouRo.js";function ue(){const C=$(!1),i=$(null),V=B(),h=L.create(),T=()=>{var u;return((u=document.head.querySelector('meta[name="csrf-token"]'))==null?void 0:u.content)||null};return h.interceptors.request.use(l=>{const u=T();return u&&(l.headers["X-CSRF-TOKEN"]=u),l.headers["X-Requested-With"]="XMLHttpRequest",l.headers.Accept="application/json",l}),{loading:C,error:i,createVentaFromCarrito:async l=>{var u,r,c,d,o;C.value=!0,i.value=null;try{const v={productos:V.items.map(y=>({id:y.id,cantidad:y.cantidad,precio:y.precio,nombre:y.nombre,imagen:y.primera_imagen||y.imagen||null,subtotal:y.precio*y.cantidad})),customer_email:l};let k;try{k=await h.post("/carrito/create-venta",v)}catch(y){if(((u=y.response)==null?void 0:u.status)===419){console.log("ðŸ”„ Token CSRF expirado, renovando...");try{const _=await L.get("/tienda",{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"text/html,application/xhtml+xml"}});if(_.data&&typeof _.data=="string"){const R=_.data.match(/name="csrf-token" content="([^"]+)"/);if(R){const q=R[1],n=document.head.querySelector('meta[name="csrf-token"]');n&&(n.setAttribute("content",q),console.log("âœ… Token CSRF renovado:",q))}}k=await h.post("/carrito/create-venta",v)}catch(_){throw _}}else throw y}if(k.data.success)return{success:!0,venta:k.data.venta,message:k.data.message};throw new Error(k.data.message||"Error desconocido")}catch(a){console.error("Error creando venta desde carrito:",a);let v="Error al crear la venta";return(c=(r=a.response)==null?void 0:r.data)!=null&&c.message?v=a.response.data.message:(o=(d=a.response)==null?void 0:d.data)!=null&&o.errors?v=Object.values(a.response.data.errors).flat().join(", "):a.message&&(v=a.message),i.value=v,{success:!1,error:v}}finally{C.value=!1}},procesarPagoVenta:async l=>{var u,r,c,d;C.value=!0,i.value=null;try{const o=await h.post("/pagos/venta",l);if(o.data.success)return{success:!0,pago:o.data.pago,wompi_data:o.data.wompi_data,message:o.data.message};throw new Error(o.data.message||"Error en el pago")}catch(o){console.error("Error procesando pago:",o);let a="Error al procesar el pago";return(r=(u=o.response)==null?void 0:u.data)!=null&&r.message?a=o.response.data.message:(d=(c=o.response)==null?void 0:c.data)!=null&&d.errors?a=Object.values(o.response.data.errors).flat().join(", "):o.message&&(a=o.message),i.value=a,{success:!1,error:a}}finally{C.value=!1}},consultarEstadoPago:async l=>{var u,r;try{const c=await h.get(`/pagos/${l}/estado`);if(c.data.success)return{success:!0,pago:c.data.pago};throw new Error(c.data.message||"Error consultando estado")}catch(c){return console.error("Error consultando estado del pago:",c),{success:!1,error:((r=(u=c.response)==null?void 0:u.data)==null?void 0:r.message)||c.message||"Error consultando estado"}}}}}const me={class:"modal-header"},pe={class:"modal-title"},fe={key:0,class:"loading-state"},ve={key:1,class:"error-state"},ge={key:2,class:"payment-form"},be={class:"purchase-summary"},he={class:"summary-details"},ye={class:"cart-items"},xe={class:"item-name"},ke={class:"item-quantity"},_e={class:"item-price"},Ce={class:"total-amount"},we={class:"amount"},Ee={class:"payment-section"},$e=["disabled"],Te={key:0,class:"w-6 h-6 mr-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},Se={key:1,class:"w-6 h-6 mr-3 animate-spin",fill:"none",viewBox:"0 0 24 24"},Pe={class:"payment-info"},Fe={class:"info-item"},Re={class:"info-item"},je={key:3,class:"success-state"},Ve={class:"success-details"},Ae={key:0},Me={class:"cart-cleared-notice"},qe={__name:"CarritoCheckoutModal",props:{isVisible:{type:Boolean,default:!1}},emits:["close","payment-completed"],setup(C,{emit:i}){const V=C,h=i,{createVentaFromCarrito:T}=ue(),x=B(),A=K(),w=$(!1),l=$(null),u=$(!1),r=$(null),c=$(!1),d=N(()=>{var n;return(n=A.props.auth)==null?void 0:n.user}),o=N(()=>{var n;return((n=d.value)==null?void 0:n.email)||""}),a=N(()=>{var n;return((n=d.value)==null?void 0:n.name)||""}),v=n=>n?new Intl.NumberFormat("es-CO",{minimumFractionDigits:2,maximumFractionDigits:2}).format(n):"0.00";ee(()=>V.isVisible,n=>{n&&R()});const k=async()=>{if(x.isEmpty){r.value="El carrito estÃ¡ vacÃ­o";return}if(!o.value){r.value="No se encontrÃ³ informaciÃ³n del usuario";return}w.value=!0,r.value=null;try{const n=await T(o.value);n.success?l.value=n.venta:r.value=n.error||"Error creando la venta"}catch(n){r.value="Error inesperado al crear la venta",console.error("Error creando venta:",n)}finally{w.value=!1}},y=async()=>{var n;if(c.value=!0,r.value=null,!l.value){console.log("ðŸ›’ Creando venta antes del pago..."),w.value=!0;try{if(await k(),r.value||!l.value){c.value=!1;return}}finally{w.value=!1}}console.log("ðŸ’³ Procesando pago para venta:",(n=l.value)==null?void 0:n.id);try{const s=()=>{var j;return((j=document.querySelector('meta[name="csrf-token"]'))==null?void 0:j.getAttribute("content"))||null},S=async()=>{var j;return await fetch("/wompi/payment-link",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":s(),"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({customer_email:o.value,amount:x.totalPrice,description:`Compra de ${x.items.length} producto(s) - ${a.value}`,reference:`CART-${Date.now()}`,customer_name:a.value,venta_id:((j=l.value)==null?void 0:j.id)||null,productos:x.items.map(E=>({id:E.id,nombre:E.nombre,precio:E.precio,cantidad:E.cantidad,imagen:E.primera_imagen||E.imagen||null,subtotal:E.precio*E.cantidad}))})})};let I=await S();if(I.status===419){console.log("ðŸ”„ Token CSRF expirado, renovando...");const O=(await(await fetch("/tienda",{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"text/html,application/xhtml+xml"}})).text()).match(/name="csrf-token" content="([^"]+)"/);if(O){const z=O[1],H=document.querySelector('meta[name="csrf-token"]');H&&(H.setAttribute("content",z),console.log("âœ… Token CSRF renovado:",z))}I=await S()}const M=await I.json();M.success?(window.open(M.payment_link,"_blank"),x.limpiarCarrito(),u.value=!0,setTimeout(()=>{_()},3e3),h("payment-completed",{success:!0,venta:l.value,payment_link:M.payment_link,reference:M.reference,cart_cleared:!0})):r.value=M.message||"Error creando enlace de pago"}catch(s){console.error("Error procesando pago:",s),r.value="Error procesando el pago. IntÃ©ntalo de nuevo."}finally{c.value=!1}},_=()=>{h("close"),R()},R=()=>{l.value=null,u.value=!1,r.value=null,w.value=!1},q=()=>{R(),k()};return(n,s)=>C.isVisible?(f(),p("div",{key:0,class:"modal-overlay",onClick:_},[e("div",{class:"modal-container",onClick:s[0]||(s[0]=J(()=>{},["stop"]))},[e("div",me,[e("h3",pe,[m(t(b),{icon:t(Q),class:"title-icon"},null,8,["icon"]),s[1]||(s[1]=F(" Finalizar Compra "))]),e("button",{onClick:_,class:"close-button"},[m(t(b),{icon:t(se)},null,8,["icon"])])]),w.value?(f(),p("div",fe,s[2]||(s[2]=[e("div",{class:"spinner"},null,-1),e("p",null,"Procesando tu pedido...",-1)]))):r.value?(f(),p("div",ve,[m(t(b),{icon:t(oe),class:"error-icon"},null,8,["icon"]),s[3]||(s[3]=e("h4",null,"Error al procesar",-1)),e("p",null,g(r.value),1),e("button",{onClick:q,class:"retry-button"}," Intentar de nuevo ")])):(f(),p("div",ge,[e("div",be,[s[5]||(s[5]=e("h4",null,"Resumen de tu compra",-1)),e("div",he,[e("div",ye,[(f(!0),p(W,null,G(t(x).items,S=>(f(),p("div",{key:S.id,class:"cart-item"},[e("span",xe,g(S.nombre),1),e("span",ke,g(S.cantidad)+"x",1),e("span",_e,"$"+g(v(S.precio*S.cantidad)),1)]))),128))]),e("div",Ce,[s[4]||(s[4]=e("span",null,"Total a pagar:",-1)),e("span",we,"$"+g(v(t(x).totalPrice)),1)])])]),e("div",Ee,[e("button",{onClick:y,disabled:c.value,class:"w-full inline-flex items-center justify-center px-6 py-4 border border-transparent text-lg font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"},[c.value?(f(),p("svg",Se,s[7]||(s[7]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)]))):(f(),p("svg",Te,s[6]||(s[6]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"},null,-1)]))),F(" "+g(c.value?"Generando enlace de pago...":"Pagar con Wompi"),1)],8,$e)]),e("div",Pe,[e("div",Fe,[m(t(b),{icon:t(ae),class:"info-icon"},null,8,["icon"]),s[8]||(s[8]=e("span",null,"Pago seguro con encriptaciÃ³n SSL",-1))]),e("div",Re,[m(t(b),{icon:t(re),class:"info-icon"},null,8,["icon"]),s[9]||(s[9]=e("span",null,"Procesamiento inmediato",-1))])])])),u.value?(f(),p("div",je,[m(t(b),{icon:t(ne),class:"success-icon"},null,8,["icon"]),s[14]||(s[14]=e("h4",null,"Â¡Enlace de pago creado!",-1)),s[15]||(s[15]=e("p",null,"Se abriÃ³ una nueva ventana con tu enlace de pago seguro.",-1)),e("div",Ve,[l.value?(f(),p("p",Ae,[s[10]||(s[10]=e("strong",null,"NÃºmero de orden:",-1)),F(" #"+g(l.value.id),1)])):P("",!0),e("p",null,[s[11]||(s[11]=e("strong",null,"Total pagado:",-1)),F(" $"+g(v(t(x).totalPrice)),1)]),e("p",Me,[m(t(b),{icon:t(Y),class:"cart-icon"},null,8,["icon"]),s[12]||(s[12]=F(" Tu carrito se ha limpiado automÃ¡ticamente "))])]),e("div",{class:"success-actions"},[s[13]||(s[13]=e("p",{class:"auto-close-notice"},"Esta ventana se cerrarÃ¡ automÃ¡ticamente en unos segundos",-1)),e("button",{onClick:_,class:"success-button"}," Cerrar ahora ")])])):P("",!0)])])):P("",!0)}},Ne=Z(qe,[["__scopeId","data-v-e1fc33fe"]]),Ie={key:0,class:"absolute right-0 top-0 h-full w-full max-w-md transform carrito-panel"},Xe={class:"flex h-full flex-col bg-white shadow-xl"},De={class:"flex items-center justify-between border-b border-gray-200 px-6 py-4"},We={class:"text-lg font-semibold text-gray-900 flex items-center gap-2"},Be={class:"px-6 py-2 bg-blue-50 border-b border-blue-100"},Oe={class:"text-sm text-blue-800"},ze={class:"flex-1 overflow-y-auto px-6 py-4 carrito-scroll"},He={key:0,class:"flex flex-col items-center justify-center h-full text-center empty-state"},Le={key:1,class:"space-y-4"},Ue={class:"flex-shrink-0 w-16 h-16 producto-imagen"},Ke={class:"flex-1 min-w-0"},Ge={class:"text-sm font-medium text-gray-900 truncate"},Je={class:"text-sm text-blue-600 font-semibold"},Qe={class:"text-xs text-gray-500 whitespace-nowrap"},Ye={class:"flex items-center gap-2"},Ze=["onClick","disabled"],et={class:"w-8 text-center text-sm font-medium"},tt=["onClick","disabled"],st=["onClick"],ot={key:0,class:"px-6 py-3 border-t border-gray-100"},at={key:1,class:"border-t border-gray-200 px-6 py-4 space-y-4"},rt={class:"flex items-center justify-between"},nt={class:"text-xl font-bold text-blue-600 total-badge"},lt={class:"space-y-2"},it={__name:"CarritoCompras",setup(C){const i=B(),V=K(),h=$(!1),T=$(!1),x=N(()=>{var d;return!!((d=V.props.auth)!=null&&d.user)}),A=d=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(d),w=()=>{if(!x.value){alert("Debes iniciar sesiÃ³n para continuar con la compra");return}if(i.isEmpty){alert("Tu carrito estÃ¡ vacÃ­o");return}r(),setTimeout(()=>{h.value=!0},350)},l=()=>{h.value=!1},u=d=>{h.value=!1},r=()=>{T.value=!0,setTimeout(()=>{i.ocultarCarrito(),T.value=!1},300)},c=d=>d.imagen?d.imagen.startsWith("http")||d.imagen.startsWith("data:")?d.imagen:`/storage/productos/${d.imagen}`:null;return(d,o)=>(f(),p(W,null,[m(D,{name:"carrito-fade",appear:""},{default:X(()=>[t(i).isVisible?(f(),p("div",{key:0,class:"fixed inset-0 z-[10000] overflow-hidden carrito-overlay",onClick:J(r,["self"])},[m(D,{name:"backdrop-fade",appear:""},{default:X(()=>[T.value?P("",!0):(f(),p("div",{key:0,class:"absolute inset-0 bg-black bg-opacity-50 transition-opacity cursor-pointer fondo-clickeable",onClick:r}))]),_:1}),m(D,{name:"carrito-slide",appear:""},{default:X(()=>[T.value?P("",!0):(f(),p("div",Ie,[e("div",Xe,[e("div",De,[e("h2",We,[m(t(b),{icon:t(Y),class:"text-blue-600"},null,8,["icon"]),o[1]||(o[1]=F(" Carrito de Compras "))]),e("button",{onClick:r,class:"text-gray-400 hover:text-gray-600 transition-colors"},[m(t(b),{icon:t(le),class:"w-6 h-6"},null,8,["icon"])])]),e("div",Be,[e("p",Oe,g(t(i).itemCount)+" "+g(t(i).itemCount===1?"producto":"productos")+" en tu carrito ",1)]),e("div",ze,[t(i).isEmpty?(f(),p("div",He,[m(t(b),{icon:t(ie),class:"w-16 h-16 text-gray-300 mb-4"},null,8,["icon"]),o[2]||(o[2]=e("h3",{class:"text-lg font-medium text-gray-900 mb-2"},"Tu carrito estÃ¡ vacÃ­o",-1)),o[3]||(o[3]=e("p",{class:"text-gray-500 mb-6"},"Agrega algunos productos para comenzar",-1)),e("button",{onClick:r,class:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-colors"}," Continuar Comprando ")])):(f(),p("div",Le,[(f(!0),p(W,null,G(t(i).items,a=>(f(),p("div",{key:a.id,class:"flex items-center gap-4 p-4 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors producto-item"},[e("div",Ue,[m(te,{src:c(a),alt:a.nombre,"fallback-text":a.nombre,"container-class":"w-full h-full","image-class":"w-full h-full object-cover rounded-md border border-gray-200"},null,8,["src","alt","fallback-text"])]),e("div",Ke,[e("h4",Ge,g(a.nombre),1),e("p",Je,g(A(a.precio)),1),e("p",Qe," Stock: "+g(a.stock_actual),1)]),e("div",Ye,[e("button",{onClick:v=>t(i).decrementarCantidad(a.id),class:"w-8 h-8 flex items-center justify-center border border-gray-300 rounded-md hover:bg-gray-50 transition-colors cantidad-btn",disabled:a.cantidad<=1},[m(t(b),{icon:t(ce),class:"w-3 h-3"},null,8,["icon"])],8,Ze),e("span",et,g(a.cantidad),1),e("button",{onClick:v=>t(i).incrementarCantidad(a.id),class:"w-8 h-8 flex items-center justify-center border border-gray-300 rounded-md hover:bg-gray-50 transition-colors cantidad-btn",disabled:a.cantidad>=a.stock_actual},[m(t(b),{icon:t(de),class:"w-3 h-3"},null,8,["icon"])],8,tt)]),e("button",{onClick:v=>t(i).eliminarProducto(a.id),class:"p-2 text-red-400 hover:text-red-600 transition-colors btn-eliminar",title:"Eliminar producto"},[m(t(b),{icon:t(U),class:"w-4 h-4"},null,8,["icon"])],8,st)]))),128))]))]),t(i).isEmpty?P("",!0):(f(),p("div",ot,[e("button",{onClick:o[0]||(o[0]=a=>t(i).limpiarCarrito()),class:"w-full text-red-500 hover:text-red-700 hover:bg-red-50 py-2 px-4 text-sm transition-colors flex items-center justify-center gap-2 rounded-md border border-red-200 hover:border-red-300"},[m(t(b),{icon:t(U),class:"w-4 h-4"},null,8,["icon"]),o[4]||(o[4]=F(" Vaciar Carrito "))])])),t(i).isEmpty?P("",!0):(f(),p("div",at,[e("div",rt,[o[5]||(o[5]=e("span",{class:"text-lg font-semibold text-gray-900"},"Total:",-1)),e("span",nt,g(A(t(i).totalPrice)),1)]),e("div",lt,[e("button",{onClick:w,class:"w-full text-white py-3 px-4 rounded-md transition-colors flex items-center justify-center gap-2 font-medium btn-checkout"},[m(t(b),{icon:t(Q)},null,8,["icon"]),o[6]||(o[6]=F(" Proceder al Checkout "))]),e("button",{onClick:r,class:"w-full text-white py-2 px-4 rounded-md transition-colors btn-continuar"}," Continuar Comprando ")])]))])]))]),_:1})])):P("",!0)]),_:1}),m(Ne,{"is-visible":h.value,onClose:l,onPaymentCompleted:u},null,8,["is-visible"])],64))}},gt=Z(it,[["__scopeId","data-v-4bc1bb72"]]);export{gt as default};
